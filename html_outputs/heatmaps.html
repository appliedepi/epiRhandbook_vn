<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>34 Biểu đồ nhiệt | Cẩm nang dịch tễ học với R</title>

    <meta name="author" content="the handbook team" />
  
   <meta name="description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="34 Biểu đồ nhiệt | Cẩm nang dịch tễ học với R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="34 Biểu đồ nhiệt | Cẩm nang dịch tễ học với R" />
  
  <meta name="twitter:description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.6.1/transition.js"></script>
    <script src="libs/bs3compat-0.6.1/tabs.js"></script>
    <script src="libs/bs3compat-0.6.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.31/datatables.js"></script>
    <link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
    <link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
    <script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
    <link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
    <script src="libs/selectize-0.12.0/selectize.min.js"></script>
    <link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet" />
    <script src="libs/tabwid-1.1.3/tabwid.js"></script>
    <link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-1.3.1/leaflet.js"></script>
    <link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
    <script src="libs/proj4-2.6.2/proj4.min.js"></script>
    <script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding-2.2.1/leaflet.js"></script>
    <script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
    <script src="libs/leaflet-providers-plugin-2.2.1/leaflet-providers-plugin.js"></script>
    <script src="libs/viz-1.8.2/viz.js"></script>
    <link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
    <script src="libs/grViz-binding-1.0.11/grViz.js"></script>
    <script src="libs/d3-4.5.0/d3.min.js"></script>
    <script src="libs/sankey-1/sankey.js"></script>
    <script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>
    <script src="libs/plotly-binding-4.10.4/plotly.js"></script>
    <script src="libs/typedarray-0.1/typedarray.min.js"></script>
    <link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>
    <link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
    <script src="libs/vis-9.1.0/vis-network.min.js"></script>
    <script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script>
    <link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script>
    <script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script>
    <script src="libs/proj4js-2.3.15/proj4.js"></script>
    <link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet" />
    <script src="libs/highcharts-9.3.1/highcharts.js"></script>
    <script src="libs/highcharts-9.3.1/highcharts-3d.js"></script>
    <script src="libs/highcharts-9.3.1/highcharts-more.js"></script>
    <script src="libs/highcharts-9.3.1/modules/stock.js"></script>
    <script src="libs/highcharts-9.3.1/modules/map.js"></script>
    <script src="libs/highcharts-9.3.1/modules/data.js"></script>
    <script src="libs/highcharts-9.3.1/modules/exporting.js"></script>
    <script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script>
    <script src="libs/highcharts-9.3.1/modules/drilldown.js"></script>
    <script src="libs/highcharts-9.3.1/modules/item-series.js"></script>
    <script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script>
    <script src="libs/highcharts-9.3.1/modules/annotations.js"></script>
    <script src="libs/highcharts-9.3.1/modules/export-data.js"></script>
    <script src="libs/highcharts-9.3.1/modules/funnel.js"></script>
    <script src="libs/highcharts-9.3.1/modules/heatmap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/treemap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/sankey.js"></script>
    <script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script>
    <script src="libs/highcharts-9.3.1/modules/organization.js"></script>
    <script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script>
    <script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script>
    <script src="libs/highcharts-9.3.1/modules/sunburst.js"></script>
    <script src="libs/highcharts-9.3.1/modules/vector.js"></script>
    <script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script>
    <script src="libs/highcharts-9.3.1/modules/xrange.js"></script>
    <script src="libs/highcharts-9.3.1/modules/tilemap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/venn.js"></script>
    <script src="libs/highcharts-9.3.1/modules/gantt.js"></script>
    <script src="libs/highcharts-9.3.1/modules/timeline.js"></script>
    <script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script>
    <script src="libs/highcharts-9.3.1/modules/bullet.js"></script>
    <script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script>
    <script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script>
    <script src="libs/highcharts-9.3.1/modules/lollipop.js"></script>
    <script src="libs/highcharts-9.3.1/modules/series-label.js"></script>
    <script src="libs/highcharts-9.3.1/plugins/motion.js"></script>
    <script src="libs/highcharts-9.3.1/custom/reset.js"></script>
    <script src="libs/highcharts-9.3.1/modules/boost.js"></script>
    <script src="libs/highchart-binding-0.9.4/highchart.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>

    <div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
      <strong>Bạn cần trợ giúp khi học R?</strong> Hãy tham gia <a href="https://www.appliedepi.org/live/" class="alert-link">khóa học</a>, trải nghiệm <a href="https://www.appliedepi.org/tutorial/" class="alert-link">các học phần miễn phí</a>, gửi bài viết <a href="https://community.appliedepi.org/" class="alert-link">trên trang Cộng đồng</a>, hoặc liên hệ <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ hỗ trợ của chúng tôi</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
      <link rel="stylesheet" href="style_bs4.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Cẩm nang dịch tễ học với R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="heatmaps" class="section level1" number="34">
<h1><span class="header-section-number">34</span> Biểu đồ nhiệt</h1>
<p>Biểu đồ nhiệt, còn được gọi là “bản đồ nhiệt” hoặc “bảng nhiệt”, là những hình ảnh trực quan hữu ích khi cố gắng hiển thị 3 biến (trục x, trục y và màu sắc). Dưới đây chúng tôi minh họa hai ví dụ:</p>
<ul>
<li>Ma trận trực quan về các sự kiện lây truyền theo độ tuổi (“ai lây nhiễm cho ai”)</li>
<li>Theo dõi các chỉ số báo cáo trên nhiều cơ sở/khu vực theo thời gian</li>
</ul>
<p><img src="images/transmission_matrix.png" width="50%" /><img src="images/heat_tile.png" width="50%" /></p>
<!-- ======================================================= -->
<div id="chuẩn-bị-26" class="section level2" number="34.1">
<h2><span class="header-section-number">34.1</span> Chuẩn bị</h2>
<div id="gọi-packages-11" class="section level3 unnumbered">
<h3>Gọi packages</h3>
<p>Đoạn code dưới đây hiển thị cách gọi các packages cần thiết cho việc phân tích dữ liệu. Trong cuốn sách này, chúng tôi nhấn mạnh đến hàm <code>p_load()</code> từ package <strong>pacman</strong>, cài đặt packages nếu cần <em>và</em> gọi chúng ra để sử dụng. Bạn cũng có thể gọi các packages đã cài đặt với hàm <code>library()</code> từ <strong>base</strong> R. Xem chương <a href="basics.html#basics">R cơ bản</a> để biết thêm thông tin về các packages trong R.</p>
<div class="sourceCode" id="cb1596"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1596-1"><a href="heatmaps.html#cb1596-1" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1596-2"><a href="heatmaps.html#cb1596-2" tabindex="-1"></a>  tidyverse,       <span class="co"># data manipulation and visualization</span></span>
<span id="cb1596-3"><a href="heatmaps.html#cb1596-3" tabindex="-1"></a>  rio,             <span class="co"># importing data </span></span>
<span id="cb1596-4"><a href="heatmaps.html#cb1596-4" tabindex="-1"></a>  lubridate        <span class="co"># working with dates</span></span>
<span id="cb1596-5"><a href="heatmaps.html#cb1596-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><strong>Bộ dữ liệu</strong></p>
<p>Chương này sẽ sử dụng bộ dữ liệu linelist-một vụ dịch mô phỏng trong mục ma trận lây truyền và bộ dữ liệu về số trường hợp sốt rét được ghi nhận hàng ngày theo cơ sở trong phần theo dõi các chỉ số báo cáo. Các bộ dữ liệu sẽ được gọi và làm sạch trong khi trình bày.</p>
</div>
</div>
<div id="ma-trận-lây-truyền-1" class="section level2" number="34.2">
<h2><span class="header-section-number">34.2</span> Ma trận lây truyền</h2>
<p>Bảng nhiệt có thể hữu ích để trực quan hóa ma trận. Một ví dụ là hiển thị “ai đã lây nhiễm cho ai” trong một vụ dịch. Giả sử rằng bạn có đầy đủ thông tin về các sự kiện lây truyền.</p>
<p>Lưu ý rằng chương <a href="data-used.html#truy-vết-tiếp-xúc">Truy vết tiếp xúc</a> có một ví dụ khác về tạo ma trận tiếp xúc thành bảng nhiệt, sử dụng một dataset khác (có lẽ đơn giản hơn) trong đó tuổi của các trường hợp và nguồn lây của chúng được căn chỉnh gọn gàng trên cùng một hàng của data frame. Dataset này cũng được sử dụng để tạo bản đồ <em>mật độ</em> trong chương <a href="ggplot-tips.html#ggplot-tips">Các tips với ggplot</a>. Ví dụ dưới đây bắt đầu từ một danh sách các trường hợp và yêu cầu nhiều thao tác biến đổi dữ liệu trước khi thành một data frame sẵn sàng để vẽ biểu đồ. Vì vậy, có rất nhiều kịch bản để bạn lựa chọn…</p>
<p>Chúng tôi bắt đầu từ danh sách trường hợp của một vụ dịch Ebola mô phỏng. Nếu bạn muốn theo dõi, hãy <a href='https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>bấm để tải bộ dữ liệu linelist “đã làm sạch”</a> (as .rds file). Nhập dữ liệu của bạn bằng hàm <code>import()</code> từ package <strong>rio</strong> (hàm này chấp nhận nhiều loại tệp như .xlsx, .rds, .csv - Xem chương <a href="importing.html#importing">Nhập xuất dữ liệu</a> để biết thêm chi tiết).</p>
<p>Danh sách dưới đây bao gồm 50 hàng đầu tiên của linelist:</p>
<div class="sourceCode" id="cb1597"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1597-1"><a href="heatmaps.html#cb1597-1" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">&quot;linelist_cleaned.rds&quot;</span>)</span></code></pre></div>
<p>Trong bộ dữ liệu linelist này:</p>
<ul>
<li>Mỗi trường hợp được thể hiện trên một hàng, được định danh bằng <code>case_id</code><br />
</li>
<li>Kéo sang phải bạn sẽ thấy cột <code>infector</code> có chứa <code>case_id</code> của <em>nguồn lây</em>, mỗi nguồn lây cũng là một trường hợp trong linelist</li>
</ul>
<div class="datatables html-widget html-fill-item" id="htmlwidget-0fba29440fa3e4d4af85" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-0fba29440fa3e4d4af85">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.461830626007281,8.462729314626459,8.461443675342711,8.46191259217774,8.472923276435059,8.48401630165138,8.458371253408441,8.477617055125091,8.47570184950483,8.477799468789719,8.47145134147474,8.478048406853629,8.48528034195779,8.469575303958671,8.45957352078114,8.474048895115439,8.488029171298839,8.473437335922,8.484082637344621,8.46242233645879,8.470268221265719,8.463984474805329,8.464134789434199,8.456230946296071,8.48334624336805,8.47493999153642,8.47832062438022,8.469393389176499,8.48480589906514,8.47121232619015,8.48438437371817,8.484661585743391,8.477141599844281,8.462381270106089,8.455685978131131,8.4632880274758,8.47940722413856,8.46353857052336,8.461789681588639,8.47508713872833,8.458258081280711,8.4532568143863,8.4732571907655,8.479115866419329,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.81844297615629,16.06524962926347,22.49657064471879,71.41440190438405,41.61712247324614,62.09538908706566,0,16.83765369253662,22.79032897344431,53.41198979591836,24.28026361429067,22.46003435064077,54.32098765432099,41.05784325564545,28.56648199445983,17.03205520132763,25.04129149128882,38.7172182043977,27.3876813705495,31.55555555555556,14.80690759456621,30.88398111998135,26.61934338952972,59.37499999999999,96.61835748792272,19.23947487550928,84.94031221303948,18.41993774061044,27.77226740726046,41.32231404958677,17.20806665861611,24.16716240333135,15.72189710891781,428.9940828402366,27.99302202929125,243.2610124917817,20.23950075898128,30.52744643563797,25.15589569160998,47,39.04,31.06616432017979,77.96836711962574,29.51659612385831,166.4932362122789,100.3086419753086,37.76,20.60378034578518,23.45856237526698],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]},{"name":"case_id","targets":0},{"name":"generation","targets":1},{"name":"date_infection","targets":2},{"name":"date_onset","targets":3},{"name":"date_hospitalisation","targets":4},{"name":"date_outcome","targets":5},{"name":"outcome","targets":6},{"name":"gender","targets":7},{"name":"age","targets":8},{"name":"age_unit","targets":9},{"name":"age_years","targets":10},{"name":"age_cat","targets":11},{"name":"age_cat5","targets":12},{"name":"hospital","targets":13},{"name":"lon","targets":14},{"name":"lat","targets":15},{"name":"infector","targets":16},{"name":"source","targets":17},{"name":"wt_kg","targets":18},{"name":"ht_cm","targets":19},{"name":"ct_blood","targets":20},{"name":"fever","targets":21},{"name":"chills","targets":22},{"name":"cough","targets":23},{"name":"aches","targets":24},{"name":"vomit","targets":25},{"name":"temp","targets":26},{"name":"time_admission","targets":27},{"name":"bmi","targets":28},{"name":"days_onset_hosp","targets":29}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<div id="chuẩn-bị-dữ-liệu" class="section level3 unnumbered">
<h3>Chuẩn bị dữ liệu</h3>
<p><strong>Mục tiêu</strong>: Chúng ta cần tạo một data frame dạng “dọc”, tức là mỗi đường lây truyền theo lứa tuổi có thể có nằm trên một hàng, với một cột số chứa tỷ lệ của hàng đó đối với tất cả các sự kiện lây nhiễm được quan sát trong linelist.</p>
<p>Để đạt được mục tiêu này, một số bước biến đổi dữ liệu cần được thực hiện:</p>
<div id="tạo-data-frame-các-trường-hợp" class="section level4 unnumbered">
<h4>Tạo data frame các trường hợp</h4>
<p>Để bắt đầu, chúng ta tạo một data frame về các trường hợp, bao gồm độ tuổi và nguồn lây nhiễm của chúng - chúng ta đặt tên data frame này là <code>case_ages</code>. 50 hàng đầu tiên của bộ dữ liệu dữ liệu được hiển thị bên dưới.</p>
<div class="sourceCode" id="cb1598"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1598-1"><a href="heatmaps.html#cb1598-1" tabindex="-1"></a>case_ages <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb1598-2"><a href="heatmaps.html#cb1598-2" tabindex="-1"></a>  <span class="fu">select</span>(case_id, infector, age_cat) <span class="sc">%&gt;%</span> </span>
<span id="cb1598-3"><a href="heatmaps.html#cb1598-3" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;case_age_cat&quot;</span> <span class="ot">=</span> <span class="st">&quot;age_cat&quot;</span>)</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-b085d7b1a4f1f5dd79ea" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b085d7b1a4f1f5dd79ea">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"name":"case_id","targets":0},{"name":"infector","targets":1},{"name":"case_age_cat","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="tạo-data-frame-nguồn-lây-nhiễm" class="section level4 unnumbered">
<h4>Tạo data frame nguồn lây nhiễm</h4>
<p>Tiếp theo, chúng ta tạo một data frame các nguồn lây nhiễm - tại thời điểm này, nó chỉ gồm một cột duy nhất. Đây là các ID của các nguồn lâu nhiễm trong bộ dữ liệu linelist. Không phải mọi trường hợp đều xác định được nguồn lây, vì vậy chúng ta cần loại bỏ các giá trị missing. 50 hàng đầu tiên được hiển thị bên dưới.</p>
<div class="sourceCode" id="cb1599"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1599-1"><a href="heatmaps.html#cb1599-1" tabindex="-1"></a>infectors <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb1599-2"><a href="heatmaps.html#cb1599-2" tabindex="-1"></a>  <span class="fu">select</span>(infector) <span class="sc">%&gt;%</span> </span>
<span id="cb1599-3"><a href="heatmaps.html#cb1599-3" tabindex="-1"></a>  <span class="fu">drop_na</span>(infector)</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-9f0b55f574b160d28c2b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9f0b55f574b160d28c2b">{"x":{"filter":"none","vertical":false,"data":[["f547d6","f90f5f","11f8ea","aec8ec","893f25","133ee7","996f3a","133ee7","37a6f6","9f6884","4802b1","a75c7f","8e104d","ab634e","b799eb","5d9e4d","a15e13","ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277","d6584f","312ecf","52ea64","cfd79c","d145b7","174288","53608c","3b096b","f5c142","d05405","700448","a2e5cc","7fd086","4e08f2","3789ee","c2595d","b7641e","ce4ec6","09f7ab","4b501e","006775","1f8797","2b36fa","068c6a","535760"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"name":"infector","targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Tiếp theo, chúng ta sử dụng hàm join để thu thập tuổi của những nguồn lây nhiễm. Điều này không đơn giản, vì trong <code>linelist</code>, tuổi của người lây nhiễm không được liệt kê như vậy. Chúng ta sẽ đạt được kết quả này bằng cách nối dữ liệu các trường hợp trong <code>linelist</code> với dữ liệu những người lây nhiễm. Chúng ta bắt đầu với bộ dữ liệu infectors, sau đó dùng hàm <code>left_join()</code> thêm các trường hợp trong <code>linelist</code> sao cho cột id của các trường hợp lây nhiễm trong bộ dữ liệu <code>infector</code> nối với cột <code>case_id</code> trong bộ dữ liệu <code>linelist</code>.</p>
<p>Do đó, dữ liệu từ bản ghi trường hợp của người lây nhiễm trong linelist (bao gồm cả tuổi) được thêm vào hàng của người lây nhiễm. 50 hàng đầu tiên được hiển thị bên dưới.</p>
<div class="sourceCode" id="cb1600"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1600-1"><a href="heatmaps.html#cb1600-1" tabindex="-1"></a>infector_ages <span class="ot">&lt;-</span> infectors <span class="sc">%&gt;%</span>             <span class="co"># begin with infectors</span></span>
<span id="cb1600-2"><a href="heatmaps.html#cb1600-2" tabindex="-1"></a>  <span class="fu">left_join</span>(                               <span class="co"># add the linelist data to each infector  </span></span>
<span id="cb1600-3"><a href="heatmaps.html#cb1600-3" tabindex="-1"></a>    linelist,</span>
<span id="cb1600-4"><a href="heatmaps.html#cb1600-4" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;infector&quot;</span> <span class="ot">=</span> <span class="st">&quot;case_id&quot;</span>)) <span class="sc">%&gt;%</span>    <span class="co"># match infector to their information as a case</span></span>
<span id="cb1600-5"><a href="heatmaps.html#cb1600-5" tabindex="-1"></a>  <span class="fu">select</span>(infector, age_cat) <span class="sc">%&gt;%</span>            <span class="co"># keep only columns of interest</span></span>
<span id="cb1600-6"><a href="heatmaps.html#cb1600-6" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;infector_age_cat&quot;</span> <span class="ot">=</span> <span class="st">&quot;age_cat&quot;</span>)   <span class="co"># rename for clarity</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-bc30aa5c582e1192d1f2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-bc30aa5c582e1192d1f2">{"x":{"filter":"none","vertical":false,"data":[["f547d6","f90f5f","11f8ea","aec8ec","893f25","133ee7","996f3a","133ee7","37a6f6","9f6884","4802b1","a75c7f","8e104d","ab634e","b799eb","5d9e4d","a15e13","ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277","d6584f","312ecf","52ea64","cfd79c","d145b7","174288","53608c","3b096b","f5c142","d05405","700448","a2e5cc","7fd086","4e08f2","3789ee","c2595d","b7641e","ce4ec6","09f7ab","4b501e","006775","1f8797","2b36fa","068c6a","535760"],["15-19",null,"50-69",null,"0-4","20-29",null,"20-29",null,"15-19",null,null,"10-14",null,"10-14",null,null,null,null,"50-69",null,null,null,null,null,"5-9",null,"10-14","10-14","0-4","20-29",null,null,"20-29",null,"5-9",null,"10-14",null,"20-29","10-14","5-9","0-4",null,null,null,"5-9","15-19",null,null]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"name":"infector","targets":0},{"name":"infector_age_cat","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Sau đó, chúng ta kết hợp các trường hợp và tuổi của chúng với những người lây nhiễm và tuổi của những người này lại. Mỗi data frame đều có chung cột <code>infector</code>, vì vậy nó được sử dụng cho phép nối. Các hàng đầu tiên được hiển thị bên dưới:</p>
<div class="sourceCode" id="cb1601"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1601-1"><a href="heatmaps.html#cb1601-1" tabindex="-1"></a>ages_complete <span class="ot">&lt;-</span> case_ages <span class="sc">%&gt;%</span>  </span>
<span id="cb1601-2"><a href="heatmaps.html#cb1601-2" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb1601-3"><a href="heatmaps.html#cb1601-3" tabindex="-1"></a>    infector_ages,</span>
<span id="cb1601-4"><a href="heatmaps.html#cb1601-4" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">&quot;infector&quot;</span>) <span class="sc">%&gt;%</span>        <span class="co"># each has the column infector</span></span>
<span id="cb1601-5"><a href="heatmaps.html#cb1601-5" tabindex="-1"></a>  <span class="fu">drop_na</span>()                     <span class="co"># drop rows with any missing data</span></span></code></pre></div>
<pre><code>## Warning in left_join(., infector_ages, by = &quot;infector&quot;): Detected an unexpected many-to-many relationship between `x` and `y`.
## ℹ Row 1 of `x` matches multiple rows in `y`.
## ℹ Row 6 of `y` matches multiple rows in `x`.
## ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to
##   silence this warning.</code></pre>
<div class="datatables html-widget html-fill-item" id="htmlwidget-38a9555e23da4264361a" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-38a9555e23da4264361a">{"x":{"filter":"none","vertical":false,"data":[["5fe599","5fe599","5fe599","893f25","893f25","893f25","893f25","893f25","07e3e8","369449","369449","57a565","57a565","2eaa9a","ddddee","bc2adf","bc2adf","8ebf6e","f5c142","062638","c76676","c76676","c76676","baacc1","497372","c71dcd","c71dcd","422831","2b36fa","2b36fa","2b36fa","4ade58","9f0c37","f97626","7d99f2","7d99f2","babc2d","d5f3c0","d5f3c0","8b4b24","bd5a25","564652","564652","890de4","890de4","890de4","890de4","cc71ea","cc71ea","3c0ca7"],["f547d6","f547d6","f547d6","11f8ea","11f8ea","11f8ea","11f8ea","11f8ea","893f25","133ee7","133ee7","133ee7","133ee7","9f6884","8e104d","b799eb","b799eb","567136","d6584f","52ea64","cfd79c","cfd79c","cfd79c","d145b7","174288","f5c142","f5c142","700448","7fd086","7fd086","7fd086","3789ee","c2595d","b7641e","ce4ec6","ce4ec6","1f8797","2b36fa","2b36fa","108b95","5b2dd9","92e129","92e129","9a9a84","9a9a84","9a9a84","9a9a84","68623f","68623f","088b66"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","15-19","0-4","0-4","30-49","30-49","5-9","10-14","20-29","20-29","10-14","20-29","10-14","10-14","10-14","10-14","0-4","10-14","20-29","20-29","10-14","15-19","15-19","15-19","30-49","10-14","5-9","5-9","5-9","20-29","5-9","5-9","15-19","20-29","15-19","15-19","30-49","30-49","30-49","30-49","30-49","30-49","5-9"],["15-19","15-19","15-19","50-69","50-69","50-69","50-69","50-69","0-4","20-29","20-29","20-29","20-29","15-19","10-14","10-14","10-14","50-69","5-9","10-14","10-14","10-14","10-14","0-4","20-29","20-29","20-29","5-9","10-14","10-14","10-14","20-29","10-14","5-9","0-4","0-4","5-9","15-19","15-19","15-19","30-49","10-14","10-14","70+","70+","70+","70+","30-49","30-49","30-49"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"name":"case_id","targets":0},{"name":"infector","targets":1},{"name":"case_age_cat","targets":2},{"name":"infector_age_cat","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Dưới đây là bảng chéo đơn giản về số lượng các trường hợp và người lây nhiễm theo nhóm tuổi. Nhãn được thêm vào để phân biệt.</p>
<div class="sourceCode" id="cb1603"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1603-1"><a href="heatmaps.html#cb1603-1" tabindex="-1"></a><span class="fu">table</span>(<span class="at">cases =</span> ages_complete<span class="sc">$</span>case_age_cat,</span>
<span id="cb1603-2"><a href="heatmaps.html#cb1603-2" tabindex="-1"></a>      <span class="at">infectors =</span> ages_complete<span class="sc">$</span>infector_age_cat)</span></code></pre></div>
<pre><code>##        infectors
## cases   0-4 5-9 10-14 15-19 20-29 30-49 50-69 70+
##   0-4   105 156   105   114   143   117    13   0
##   5-9   102 132   110   102   117    96    12   5
##   10-14 104 109    91    79   120    80    12   4
##   15-19  85 105    82    39    75    69     7   5
##   20-29 101 127   109    80   143   107    22   4
##   30-49  72  97    56    54    98    61     4   5
##   50-69   5   6    15     9     7     5     2   0
##   70+     1   0     2     0     0     0     0   0</code></pre>
<p>Chúng ta có thể chuyển đổi bảng này thành data frame với hàm <code>data.frame()</code> từ <strong>base</strong> R, hàm sẽ tự động chuyển đổi dữ liệu sang dạng “dọc” để có thể áp dụng trong hàm <code>ggplot()</code>. Các hàng đầu tiên được hiển thị bên dưới.</p>
<div class="sourceCode" id="cb1605"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1605-1"><a href="heatmaps.html#cb1605-1" tabindex="-1"></a>long_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">table</span>(</span>
<span id="cb1605-2"><a href="heatmaps.html#cb1605-2" tabindex="-1"></a>    <span class="at">cases     =</span> ages_complete<span class="sc">$</span>case_age_cat,</span>
<span id="cb1605-3"><a href="heatmaps.html#cb1605-3" tabindex="-1"></a>    <span class="at">infectors =</span> ages_complete<span class="sc">$</span>infector_age_cat))</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-544deeabae354c149899" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-544deeabae354c149899">{"x":{"filter":"none","vertical":false,"data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[105,102,104,85,101,72,5,1,156,132,109,105,127,97,6,0,105,110,91,82,109,56,15,2,114,102,79,39,80,54,9,0,143,117,120,75,143,98,7,0,117,96,80,69,107,61,5,0,13,12]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"name":"cases","targets":0},{"name":"infectors","targets":1},{"name":"Freq","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Bây giờ chúng ta làm tương tự, nhưng áp dụng hàm <code>prop.table()</code> từ <strong>base</strong> R vào bảng để thay vì nhận số lượng, chúng ta nhận được tỷ lệ của tất cả các biến. 50 hàng đầu tiên được hiển thị bên dưới.</p>
<div class="sourceCode" id="cb1606"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1606-1"><a href="heatmaps.html#cb1606-1" tabindex="-1"></a>long_prop <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">prop.table</span>(<span class="fu">table</span>(</span>
<span id="cb1606-2"><a href="heatmaps.html#cb1606-2" tabindex="-1"></a>    <span class="at">cases =</span> ages_complete<span class="sc">$</span>case_age_cat,</span>
<span id="cb1606-3"><a href="heatmaps.html#cb1606-3" tabindex="-1"></a>    <span class="at">infectors =</span> ages_complete<span class="sc">$</span>infector_age_cat)))</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-1a2971189e78fcffbeb6" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1a2971189e78fcffbeb6">{"x":{"filter":"none","vertical":false,"data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[0.02847843775427177,0.02766476810414972,0.02820721453756441,0.02305397342012476,0.02739354488744236,0.01952807160292921,0.001356116083536751,0.0002712232167073502,0.04231082180634662,0.03580146460537022,0.02956333062110117,0.02847843775427177,0.03444534852183347,0.02630865202061296,0.001627339300244101,0,0.02847843775427177,0.02983455383780852,0.02468131272036886,0.02224030377000271,0.02956333062110117,0.01518850013561161,0.004068348250610252,0.0005424464334147003,0.03091944670463792,0.02766476810414972,0.02142663411988066,0.01057770545158665,0.02169785733658801,0.01464605370219691,0.002441008950366151,0,0.03878491998915107,0.03173311635475997,0.03254678600488202,0.02034174125305126,0.03878491998915107,0.02657987523732032,0.001898562516951451,0,0.03173311635475997,0.02603742880390561,0.02169785733658801,0.01871440195280716,0.02902088418768647,0.01654461621914836,0.001356116083536751,0,0.003525901817195552,0.003254678600488202]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"name":"cases","targets":0},{"name":"infectors","targets":1},{"name":"Freq","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="tạo-biểu-đồ-nhiệt" class="section level3 unnumbered">
<h3>Tạo biểu đồ nhiệt</h3>
<p>Cuối cùng, chúng ta có thể vẽ biểu đồ nhiệt với hàm <code>geom_tile()</code> trong package <strong>ggplot2</strong>. Xem chương <a href="ggplot-tips.html#ggplot-tips">Các tips với ggplot</a> để tìm hiểu sâu hơn về thang màu/tô màu cho biểu đồ, đặc biệt là hàm <code>scale_fill_gradient()</code>.</p>
<ul>
<li>Bên trong hàm <code>aes()</code> của hàm <code>geom_tile()</code>, thiết lập trục x và y tương ứng với tuổi của các trường hợp và tuổi của người lây nhiễm<br />
</li>
<li>Ngoài ra trong hàm <code>aes()</code>, hãy đặt đối số <code>fill =</code> tới cột tần suất <code>Freq</code> - đây là giá trị sẽ được chuyển đổi thành màu gạch</li>
<li>Đặt màu thang đo với <code>scale_fill_gradient()</code> - bạn có thể chỉ định màu cao/thấp
<ul>
<li>Lưu ý rằng <code>scale_color_gradient()</code> là một cái khác! Trong trường hợp này, bạn sẽ sử dụng fill</li>
</ul></li>
<li>Bởi vì màu được tạo thông qua “fill”, bạn có thể sử dụng đối số <code>fill =</code> đối số trong hàm <code>labs()</code> để thay đổi tiêu đề chú giải</li>
</ul>
<div class="sourceCode" id="cb1607"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1607-1"><a href="heatmaps.html#cb1607-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> long_prop)<span class="sc">+</span>       <span class="co"># use long data, with proportions as Freq</span></span>
<span id="cb1607-2"><a href="heatmaps.html#cb1607-2" tabindex="-1"></a>  <span class="fu">geom_tile</span>(                    <span class="co"># visualize it in tiles</span></span>
<span id="cb1607-3"><a href="heatmaps.html#cb1607-3" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb1607-4"><a href="heatmaps.html#cb1607-4" tabindex="-1"></a>      <span class="at">x =</span> cases,         <span class="co"># x-axis is case age</span></span>
<span id="cb1607-5"><a href="heatmaps.html#cb1607-5" tabindex="-1"></a>      <span class="at">y =</span> infectors,     <span class="co"># y-axis is infector age</span></span>
<span id="cb1607-6"><a href="heatmaps.html#cb1607-6" tabindex="-1"></a>      <span class="at">fill =</span> Freq))<span class="sc">+</span>            <span class="co"># color of the tile is the Freq column in the data</span></span>
<span id="cb1607-7"><a href="heatmaps.html#cb1607-7" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(          <span class="co"># adjust the fill color of the tiles</span></span>
<span id="cb1607-8"><a href="heatmaps.html#cb1607-8" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb1607-9"><a href="heatmaps.html#cb1607-9" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;orange&quot;</span>)<span class="sc">+</span></span>
<span id="cb1607-10"><a href="heatmaps.html#cb1607-10" tabindex="-1"></a>  <span class="fu">labs</span>(                         <span class="co"># labels</span></span>
<span id="cb1607-11"><a href="heatmaps.html#cb1607-11" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Case age&quot;</span>,</span>
<span id="cb1607-12"><a href="heatmaps.html#cb1607-12" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Infector age&quot;</span>,</span>
<span id="cb1607-13"><a href="heatmaps.html#cb1607-13" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Who infected whom&quot;</span>,</span>
<span id="cb1607-14"><a href="heatmaps.html#cb1607-14" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Frequency matrix of transmission events&quot;</span>,</span>
<span id="cb1607-15"><a href="heatmaps.html#cb1607-15" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Proportion of all</span><span class="sc">\n</span><span class="st">tranmsission events&quot;</span>     <span class="co"># legend title</span></span>
<span id="cb1607-16"><a href="heatmaps.html#cb1607-16" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1248-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
<div id="các-chỉ-số-báo-cáo-theo-thời-gian" class="section level2" number="34.3">
<h2><span class="header-section-number">34.3</span> Các chỉ số báo cáo theo thời gian</h2>
<p>Thông thường, trong lĩnh vực y tế công cộng, một mục tiêu là đánh giá xu hướng theo thời gian của nhiều thực thể (cơ sở điều trị, địa giới hành chính, v.v.). Một cách để hình dung các xu hướng như vậy theo thời gian là biểu đồ nhiệt trong đó trục x là thời gian và trên trục y là các thực thể.</p>
<div id="chuẩn-bị-dữ-liệu-1" class="section level3 unnumbered">
<h3>Chuẩn bị dữ liệu</h3>
<p>Chúng ta bắt đầu bằng cách nhập bộ dữ liệu báo cáo về bệnh sốt rét hàng ngày từ nhiều cơ sở. Các báo cáo chứa dữu liệu về ngày, tỉnh, huyện và số trường hợp sốt rét. Xem chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a> để biết thông tin về cách tải xuống các dữ liệu này. Dưới đây là 30 hàng đầu tiên:</p>
<div class="sourceCode" id="cb1608"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1608-1"><a href="heatmaps.html#cb1608-1" tabindex="-1"></a>facility_count_data <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">&quot;malaria_facility_count_data.rds&quot;</span>)</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-d665905b6ff8c3bd8dd9" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-d665905b6ff8c3bd8dd9">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 2","Facility 3","Facility 4","Facility 5","Facility 6","Facility 6","Facility 5","Facility 5","Facility 5","Facility 7","Facility 8","Facility 9","Facility 10","Facility 11","Facility 12","Facility 13","Facility 14","Facility 15","Facility 16","Facility 17","Facility 18","Facility 19","Facility 19","Facility 20","Facility 21","Facility 19","Facility 22","Facility 23","Facility 23"],["2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-10","2020-08-10","2020-08-09","2020-08-08","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-10","2020-08-11","2020-08-11","2020-08-09","2020-08-11","2020-08-11","2020-08-12"],["Spring","Bolo","Dingo","Bolo","Bolo","Dingo","Dingo","Bolo","Bolo","Bolo","Spring","Bolo","Spring","Bolo","Spring","Dingo","Bolo","Dingo","Barnard","Barnard","Barnard","Bolo","Bolo","Bolo","Barnard","Bolo","Bolo","Bolo","Dingo","Dingo"],[46,26,18,49,17,8,7,42,35,49,32,28,53,34,60,134,0,16,11,34,9,13,32,52,37,51,32,28,31,31]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>District<\/th>\n      <th>malaria_tot<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3},{"name":"location_name","targets":0},{"name":"data_date","targets":1},{"name":"District","targets":2},{"name":"malaria_tot","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<div id="tổng-hợp-và-tóm-tắt" class="section level4 unnumbered">
<h4>Tổng hợp và tóm tắt</h4>
<p><strong>Mục tiêu của ví dụ này</strong> là chuyển đổi <em>tổng số</em> số ca bệnh sốt rét hàng ngày tại các cơ sở (xem trong tab trước) thành số liệu thống kê tóm tắt <em>hàng tuần</em> về hiệu suất báo cáo của cơ sở - trong trường hợp này là <em>tỷ lệ số ngày mỗi tuần mà cơ sở báo cáo bất kỳ dữ liệu nào</em>. Đối với ví dụ này, chúng ta sẽ chỉ hiển thị dữ liệu cho <strong>Spring District</strong>.</p>
<p>Để đạt được điều này, chúng ta sẽ thực hiện các bước quản lý dữ liệu sau:</p>
<ol style="list-style-type: decimal">
<li>Lọc dữ liệu phù hợp (theo địa điểm, ngày tháng)<br />
</li>
<li>Tạo cột tuần bằng cách sử dụng hàm <code>floor_date()</code> trong package <strong>lubridate</strong>
<ul>
<li>Hàm này trả về ngày bắt đầu trong tuần của một ngày cụ thể, sử dụng ngày bắt đầu được chỉ định của mỗi tuần (ví dụ: “Thứ Hai”)</li>
</ul></li>
<li>Dữ liệu được nhóm theo cột “location” và “week” để tạo ra các đơn vị phân tích “facility-week”<br />
</li>
<li>Hàm <code>summarise()</code> tạo các cột mới để trình bày thống kê tóm tắt cho từng nhóm cơ sở theo tuần (facility-week):
<ul>
<li>Số ngày mỗi tuần (7 - một giá trị không đổi)<br />
</li>
<li>Số lượng báo cáo nhận được từ cơ sở-tuần (có thể nhiều hơn 7!)<br />
</li>
<li>Tổng số ca sốt rét do cơ sở báo cáo trong tuần (chỉ dành cho ai quan tâm)<br />
</li>
<li>Số ngày <em>duy nhất</em> trong mỗi cơ sở-tuần có dữ liệu được báo cáo<br />
</li>
<li><strong>Phần trăm trong số 7 ngày mỗi cơ sở-tuần mà dữ liệu được báo cáo</strong><br />
</li>
</ul></li>
<li>Data frame được kết hợp bằng hàm <code>right_join()</code> thành một danh sách hoàn chỉnh về tất cả các kết hợp cơ sở-tuần có thể có, để làm cho tập dữ liệu hoàn thiện. Ma trận của tất cả các kết hợp có thể có được tạo bằng cách áp dụng hàm <code>expand()</code> cho hai cột đó của data frame giống như tại thời điểm đó trong chuỗi pipe (được biểu thị bằng <code>.</code>). Vì sử dụng hàm <code>right_join()</code>, nên tất cả các hàng trong data frame <code>expand()</code> mở rộng được giữ lại và được thêm vào <code>agg_weeks</code> nếu cần. Các hàng mới này xuất hiện với các giá trị tóm tắt <code>NA</code> (missing).</li>
</ol>
<p>Dưới đây là từng bước thực hiện:</p>
<div class="sourceCode" id="cb1609"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1609-1"><a href="heatmaps.html#cb1609-1" tabindex="-1"></a><span class="co"># Create weekly summary dataset</span></span>
<span id="cb1609-2"><a href="heatmaps.html#cb1609-2" tabindex="-1"></a>agg_weeks <span class="ot">&lt;-</span> facility_count_data <span class="sc">%&gt;%</span> </span>
<span id="cb1609-3"><a href="heatmaps.html#cb1609-3" tabindex="-1"></a>  </span>
<span id="cb1609-4"><a href="heatmaps.html#cb1609-4" tabindex="-1"></a>  <span class="co"># filter the data as appropriate</span></span>
<span id="cb1609-5"><a href="heatmaps.html#cb1609-5" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb1609-6"><a href="heatmaps.html#cb1609-6" tabindex="-1"></a>    District <span class="sc">==</span> <span class="st">&quot;Spring&quot;</span>,</span>
<span id="cb1609-7"><a href="heatmaps.html#cb1609-7" tabindex="-1"></a>    data_date <span class="sc">&lt;</span> <span class="fu">as.Date</span>(<span class="st">&quot;2020-08-01&quot;</span>)) </span></code></pre></div>
<p>Bây giờ tập dữ liệu có số lượng hàng tính theo agg_week <code>nrow(agg_weeks)</code>, trong khi trước được tính theo facility_count_data <code>nrow(facility_count_data)</code>.</p>
<p>Tiếp theo, chúng ta tạo cột <code>tuần</code> để phản ánh ngày bắt đầu trong tuần cho mỗi bản ghi. Thực hiện điều này với hàm <code>floor_date ()</code> trong package <strong>lubridate</strong>, giúp thiết lập theo “tuần” và các tuần sẽ bắt đầu vào Thứ Hai (ngày 1 trong tuần - Chủ Nhật sẽ là 7). Các hàng đầu tiên được hiển thị như bên dưới.</p>
<div class="sourceCode" id="cb1610"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1610-1"><a href="heatmaps.html#cb1610-1" tabindex="-1"></a>agg_weeks <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span> </span>
<span id="cb1610-2"><a href="heatmaps.html#cb1610-2" tabindex="-1"></a>  <span class="co"># Create week column from data_date</span></span>
<span id="cb1610-3"><a href="heatmaps.html#cb1610-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1610-4"><a href="heatmaps.html#cb1610-4" tabindex="-1"></a>    <span class="at">week =</span> lubridate<span class="sc">::</span><span class="fu">floor_date</span>(                     <span class="co"># create new column of weeks</span></span>
<span id="cb1610-5"><a href="heatmaps.html#cb1610-5" tabindex="-1"></a>      data_date,                                      <span class="co"># date column</span></span>
<span id="cb1610-6"><a href="heatmaps.html#cb1610-6" tabindex="-1"></a>      <span class="at">unit =</span> <span class="st">&quot;week&quot;</span>,                                  <span class="co"># give start of the week</span></span>
<span id="cb1610-7"><a href="heatmaps.html#cb1610-7" tabindex="-1"></a>      <span class="at">week_start =</span> <span class="dv">1</span>))                                <span class="co"># weeks to start on Mondays </span></span></code></pre></div>
<p>Cột tuần mới này có thể được nhìn thấy ở ngoài cùng bên phải của data frame được tạo ra:</p>
<div class="datatables html-widget html-fill-item" id="htmlwidget-a4a96d332d8858dde94d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a4a96d332d8858dde94d">{"x":{"filter":"none","vertical":false,"data":[["Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 51","Facility 51","Facility 51","Facility 56","Facility 7","Facility 7","Facility 7","Facility 11","Facility 35","Facility 35","Facility 28","Facility 28","Facility 28","Facility 28"],["2020-07-31","2020-07-30","2020-07-29","2020-07-28","2020-07-27","2020-07-31","2020-07-30","2020-07-29","2020-07-28","2020-07-27","2020-07-26","2020-07-25","2020-07-24","2020-07-23","2020-07-22","2020-07-21","2020-07-30","2020-07-29","2020-07-28","2020-06-25","2020-07-31","2020-07-30","2020-07-29","2020-07-31","2020-07-30","2020-07-29","2020-07-30","2020-07-29","2020-07-28","2020-07-27"],["Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring"],[13,14,74,75,91,80,39,44,44,43,28,41,61,40,33,66,32,32,32,200,0,0,21,21,43,179,1,35,31,45],["2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-27","2020-07-27","2020-07-27","2020-06-22","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>District<\/th>\n      <th>malaria_tot<\/th>\n      <th>week<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3},{"name":"location_name","targets":0},{"name":"data_date","targets":1},{"name":"District","targets":2},{"name":"malaria_tot","targets":3},{"name":"week","targets":4}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Bây giờ chúng ta nhóm dữ liệu thành các cơ sở-tuần và tóm tắt chúng để tạo ra số liệu thống kê cho mỗi cơ sở-tuần. Xem thêm chương <a href="tables-descriptive.html#tables-descriptive">Bảng mô tả</a> để biết các mẹo. Bản thân việc nhóm sẽ không làm thay đổi data frame, nhưng nó ảnh hưởng đến cách các thống kê tóm tắt tiếp theo được tính toán.</p>
<p>Các hàng đầu tiên được hiển thị bên dưới. Lưu ý cách các cột đã thay đổi hoàn toàn để phản ánh thống kê tóm tắt mong muốn. Mỗi hàng phản ánh một cơ sở-tuần.</p>
<div class="sourceCode" id="cb1611"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1611-1"><a href="heatmaps.html#cb1611-1" tabindex="-1"></a>agg_weeks <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span>   </span>
<span id="cb1611-2"><a href="heatmaps.html#cb1611-2" tabindex="-1"></a></span>
<span id="cb1611-3"><a href="heatmaps.html#cb1611-3" tabindex="-1"></a>  <span class="co"># Group into facility-weeks</span></span>
<span id="cb1611-4"><a href="heatmaps.html#cb1611-4" tabindex="-1"></a>  <span class="fu">group_by</span>(location_name, week) <span class="sc">%&gt;%</span></span>
<span id="cb1611-5"><a href="heatmaps.html#cb1611-5" tabindex="-1"></a>  </span>
<span id="cb1611-6"><a href="heatmaps.html#cb1611-6" tabindex="-1"></a>  <span class="co"># Create summary statistics columns on the grouped data</span></span>
<span id="cb1611-7"><a href="heatmaps.html#cb1611-7" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb1611-8"><a href="heatmaps.html#cb1611-8" tabindex="-1"></a>    <span class="at">n_days          =</span> <span class="dv">7</span>,                                          <span class="co"># 7 days per week           </span></span>
<span id="cb1611-9"><a href="heatmaps.html#cb1611-9" tabindex="-1"></a>    <span class="at">n_reports       =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),                                 <span class="co"># number of reports received per week (could be &gt;7)</span></span>
<span id="cb1611-10"><a href="heatmaps.html#cb1611-10" tabindex="-1"></a>    <span class="at">malaria_tot     =</span> <span class="fu">sum</span>(malaria_tot, <span class="at">na.rm =</span> T),                <span class="co"># total malaria cases reported</span></span>
<span id="cb1611-11"><a href="heatmaps.html#cb1611-11" tabindex="-1"></a>    <span class="at">n_days_reported =</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_date)),                  <span class="co"># number of unique days reporting per week</span></span>
<span id="cb1611-12"><a href="heatmaps.html#cb1611-12" tabindex="-1"></a>    <span class="at">p_days_reported =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>(n_days_reported <span class="sc">/</span> n_days))) <span class="sc">%&gt;%</span>  <span class="co"># percent of days reporting</span></span>
<span id="cb1611-13"><a href="heatmaps.html#cb1611-13" tabindex="-1"></a></span>
<span id="cb1611-14"><a href="heatmaps.html#cb1611-14" tabindex="-1"></a>  <span class="fu">ungroup</span>(location_name, week)                                    <span class="co"># ungroup so expand() works in next step</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-0fb1d2602f8a486f1f2c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-0fb1d2602f8a486f1f2c">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28"],["2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29"],[7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],[2,7,7,7,7,7,7,4,2,8,6,2,3,1,5,2,7,6,5,7,6,5,2,7,7,7,7,7,9,7],[0,0,0,101,402,570,378,131,354,853,502,317,245,0,0,0,17,147,136,118,88,86,26,216,155,120,319,256,475,352],[2,7,7,7,7,7,7,4,2,7,6,2,3,1,5,2,5,6,5,7,6,5,2,7,7,7,7,7,7,7],[29,100,100,100,100,100,100,57,29,100,86,29,43,14,71,29,71,86,71,100,86,71,29,100,100,100,100,100,100,100]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>week<\/th>\n      <th>n_days<\/th>\n      <th>n_reports<\/th>\n      <th>malaria_tot<\/th>\n      <th>n_days_reported<\/th>\n      <th>p_days_reported<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"name":"location_name","targets":0},{"name":"week","targets":1},{"name":"n_days","targets":2},{"name":"n_reports","targets":3},{"name":"malaria_tot","targets":4},{"name":"n_days_reported","targets":5},{"name":"p_days_reported","targets":6}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Cuối cùng, chúng ta chạy lệnh dưới đây để đảm bảo rằng TẤT CẢ các cặp cơ sở điều trị-tuần báo cáo có thể có trong dữ liệu, ngay cả khi chúng bị missing trước đó.</p>
<p>Chúng ta tiếp tục sử dụng hàm <code>right_join()</code> trên chính dữ liệu (tập dữ liệu được thể hiện bởi dấu “.”) vừa được mở rộng để bao gồm tất cả các kết hợp có thể có của các cột <code>week</code> và <code>location_name</code>. Xem tài liệu về hàm <code>expand()</code> trong chương <a href="pivoting.html#pivoting">Xoay trục dữ liệu</a>. Trước khi chạy đoạn lệnh này, tập dữ liệu cần chứa <code>nrow(agg_weeks)</code> hàng.</p>
<div class="sourceCode" id="cb1612"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1612-1"><a href="heatmaps.html#cb1612-1" tabindex="-1"></a><span class="co"># Create data frame of every possible facility-week</span></span>
<span id="cb1612-2"><a href="heatmaps.html#cb1612-2" tabindex="-1"></a>expanded_weeks <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span> </span>
<span id="cb1612-3"><a href="heatmaps.html#cb1612-3" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">expand</span>(location_name, week)  <span class="co"># expand data frame to include all possible facility-week combinations</span></span></code></pre></div>
<p>Đây là <code>expanded_weeks</code>:</p>
<div class="datatables html-widget html-fill-item" id="htmlwidget-2b7fb7aa47c7fb730282" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2b7fb7aa47c7fb730282">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9"],["2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>week<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"name":"location_name","targets":0},{"name":"week","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>TRước khi chạy dòng lệnh này, <code>agg_weeks</code> bao gồm <code>nrow(agg_weeks)</code> hàng.</p>
<div class="sourceCode" id="cb1613"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1613-1"><a href="heatmaps.html#cb1613-1" tabindex="-1"></a><span class="co"># Use a right-join with the expanded facility-week list to fill-in the missing gaps in the data</span></span>
<span id="cb1613-2"><a href="heatmaps.html#cb1613-2" tabindex="-1"></a>agg_weeks <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span>      </span>
<span id="cb1613-3"><a href="heatmaps.html#cb1613-3" tabindex="-1"></a>  <span class="fu">right_join</span>(expanded_weeks) <span class="sc">%&gt;%</span>                            <span class="co"># Ensure every possible facility-week combination appears in the data</span></span>
<span id="cb1613-4"><a href="heatmaps.html#cb1613-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_days_reported =</span> <span class="fu">replace_na</span>(p_days_reported, <span class="dv">0</span>))  <span class="co"># convert missing values to 0                           </span></span></code></pre></div>
<pre><code>## Joining with `by = join_by(location_name, week)`</code></pre>
<p>Sau khi chạy dòng lệnh này, <code>agg_weeks</code> vẫn bao gồm <code>nrow(agg_weeks)</code> hàng.</p>
<!-- ======================================================= -->
</div>
</div>
<div id="tạo-biểu-đồ-nhiệt-1" class="section level3 unnumbered">
<h3>Tạo biểu đồ nhiệt</h3>
<p>Hàm <code>ggplot()</code> được thực hiện bằng cách sử dụng hàm <code>geom_tile()</code> từ package <strong>ggplot2</strong>:</p>
<ul>
<li>Các tuần trên trục x được chuyển đổi thành ngày tháng, cho phép sử dụng <code>scale_x_date()</code><br />
</li>
<li><code>location_name</code> trên trục y sẽ hiển thị tất cả các tên cơ sở</li>
<li><code>fill</code> được gán cho <code>p_days_reported</code>, hiệu suất cho cơ sở-tuần đó (dạng số)</li>
<li><code>scale_fill_gradient()</code> được sử dụng để tô màu cho biến dạng số, cụ thể màu sắc gồm cao, thấp và <code>NA</code><br />
</li>
<li><code>scale_x_date()</code> được sử dụng trên trục x, chỉ định các nhãn 2 tuần một lần và định dạng của chúng<br />
</li>
<li>Các chủ đề và nhãn hiển thị có thể được điều chỉnh khi cần thiết</li>
</ul>
<!-- ======================================================= -->
</div>
<div id="cơ-bản" class="section level3 unnumbered">
<h3>Cơ bản</h3>
<p>Biểu đồ nhiệt cơ bản sẽ được tạo như bên dưới, sử dụng màu, thang đo, v.v mặc định. Như đã giải thích ở trên, trong <code>aes()</code> của hàm <code>geom_tile()</code>, bạn phải cung cấp cột trục x, cột trục y, <strong>và</strong> một cột cho <code>fill =</code>. Phần tô là giá trị số thể hiện dưới dạng màu ô.</p>
<div class="sourceCode" id="cb1615"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1615-1"><a href="heatmaps.html#cb1615-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> agg_weeks)<span class="sc">+</span></span>
<span id="cb1615-2"><a href="heatmaps.html#cb1615-2" tabindex="-1"></a>  <span class="fu">geom_tile</span>(</span>
<span id="cb1615-3"><a href="heatmaps.html#cb1615-3" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> week,</span>
<span id="cb1615-4"><a href="heatmaps.html#cb1615-4" tabindex="-1"></a>        <span class="at">y =</span> location_name,</span>
<span id="cb1615-5"><a href="heatmaps.html#cb1615-5" tabindex="-1"></a>        <span class="at">fill =</span> p_days_reported))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1260-1.png" width="672" /></p>
</div>
<div id="làm-sạch-biểu-đồ-nhiệt" class="section level3 unnumbered">
<h3>Làm sạch biểu đồ nhiệt</h3>
<p>Chúng ta có thể làm cho biểu đồ này trông đẹp hơn bằng cách thêm các hàm <strong>ggplot2</strong> bổ sung, như được hiển thị bên dưới. Xem thêm chương <a href="ggplot-tips.html#ggplot-tips">Các tips với ggplot</a> để biết thêm chi tiết.</p>
<div class="sourceCode" id="cb1616"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1616-1"><a href="heatmaps.html#cb1616-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> agg_weeks)<span class="sc">+</span> </span>
<span id="cb1616-2"><a href="heatmaps.html#cb1616-2" tabindex="-1"></a>  </span>
<span id="cb1616-3"><a href="heatmaps.html#cb1616-3" tabindex="-1"></a>  <span class="co"># show data as tiles</span></span>
<span id="cb1616-4"><a href="heatmaps.html#cb1616-4" tabindex="-1"></a>  <span class="fu">geom_tile</span>(</span>
<span id="cb1616-5"><a href="heatmaps.html#cb1616-5" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> week,</span>
<span id="cb1616-6"><a href="heatmaps.html#cb1616-6" tabindex="-1"></a>        <span class="at">y =</span> location_name,</span>
<span id="cb1616-7"><a href="heatmaps.html#cb1616-7" tabindex="-1"></a>        <span class="at">fill =</span> p_days_reported),      </span>
<span id="cb1616-8"><a href="heatmaps.html#cb1616-8" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;white&quot;</span>)<span class="sc">+</span>                 <span class="co"># white gridlines</span></span>
<span id="cb1616-9"><a href="heatmaps.html#cb1616-9" tabindex="-1"></a>  </span>
<span id="cb1616-10"><a href="heatmaps.html#cb1616-10" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb1616-11"><a href="heatmaps.html#cb1616-11" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb1616-12"><a href="heatmaps.html#cb1616-12" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;darkgreen&quot;</span>,</span>
<span id="cb1616-13"><a href="heatmaps.html#cb1616-13" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>)<span class="sc">+</span></span>
<span id="cb1616-14"><a href="heatmaps.html#cb1616-14" tabindex="-1"></a>  </span>
<span id="cb1616-15"><a href="heatmaps.html#cb1616-15" tabindex="-1"></a>  <span class="co"># date axis</span></span>
<span id="cb1616-16"><a href="heatmaps.html#cb1616-16" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb1616-17"><a href="heatmaps.html#cb1616-17" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),             <span class="co"># remove extra space on sides</span></span>
<span id="cb1616-18"><a href="heatmaps.html#cb1616-18" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">&quot;2 weeks&quot;</span>,     <span class="co"># labels every 2 weeks</span></span>
<span id="cb1616-19"><a href="heatmaps.html#cb1616-19" tabindex="-1"></a>    <span class="at">date_labels =</span> <span class="st">&quot;%d</span><span class="sc">\n</span><span class="st">%b&quot;</span>)<span class="sc">+</span>     <span class="co"># format is day over month (\n in newline)</span></span>
<span id="cb1616-20"><a href="heatmaps.html#cb1616-20" tabindex="-1"></a>  </span>
<span id="cb1616-21"><a href="heatmaps.html#cb1616-21" tabindex="-1"></a>  <span class="co"># aesthetic themes</span></span>
<span id="cb1616-22"><a href="heatmaps.html#cb1616-22" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span>                                  <span class="co"># simplify background</span></span>
<span id="cb1616-23"><a href="heatmaps.html#cb1616-23" tabindex="-1"></a>  </span>
<span id="cb1616-24"><a href="heatmaps.html#cb1616-24" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1616-25"><a href="heatmaps.html#cb1616-25" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1616-26"><a href="heatmaps.html#cb1616-26" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1616-27"><a href="heatmaps.html#cb1616-27" tabindex="-1"></a>    <span class="at">legend.key.height =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">1</span>,<span class="st">&quot;cm&quot;</span>),           <span class="co"># height of legend key</span></span>
<span id="cb1616-28"><a href="heatmaps.html#cb1616-28" tabindex="-1"></a>    <span class="at">legend.key.width  =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="fl">0.6</span>,<span class="st">&quot;cm&quot;</span>),         <span class="co"># width of legend key</span></span>
<span id="cb1616-29"><a href="heatmaps.html#cb1616-29" tabindex="-1"></a>    </span>
<span id="cb1616-30"><a href="heatmaps.html#cb1616-30" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),              <span class="co"># axis text size</span></span>
<span id="cb1616-31"><a href="heatmaps.html#cb1616-31" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">vjust=</span><span class="fl">0.2</span>),            <span class="co"># axis text alignment</span></span>
<span id="cb1616-32"><a href="heatmaps.html#cb1616-32" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.4</span>),               </span>
<span id="cb1616-33"><a href="heatmaps.html#cb1616-33" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># axis title size and bold</span></span>
<span id="cb1616-34"><a href="heatmaps.html#cb1616-34" tabindex="-1"></a>    </span>
<span id="cb1616-35"><a href="heatmaps.html#cb1616-35" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>,<span class="at">size=</span><span class="dv">14</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># title right-aligned, large, bold</span></span>
<span id="cb1616-36"><a href="heatmaps.html#cb1616-36" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)  <span class="co"># caption right-aligned and italic</span></span>
<span id="cb1616-37"><a href="heatmaps.html#cb1616-37" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb1616-38"><a href="heatmaps.html#cb1616-38" tabindex="-1"></a>  </span>
<span id="cb1616-39"><a href="heatmaps.html#cb1616-39" tabindex="-1"></a>  <span class="co"># plot labels</span></span>
<span id="cb1616-40"><a href="heatmaps.html#cb1616-40" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Week&quot;</span>,</span>
<span id="cb1616-41"><a href="heatmaps.html#cb1616-41" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Facility name&quot;</span>,</span>
<span id="cb1616-42"><a href="heatmaps.html#cb1616-42" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Reporting</span><span class="sc">\n</span><span class="st">performance (%)&quot;</span>,           <span class="co"># legend title, because legend shows fill</span></span>
<span id="cb1616-43"><a href="heatmaps.html#cb1616-43" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Percent of days per week that facility reported data&quot;</span>,</span>
<span id="cb1616-44"><a href="heatmaps.html#cb1616-44" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;District health facilities, May-July 2020&quot;</span>,</span>
<span id="cb1616-45"><a href="heatmaps.html#cb1616-45" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;7-day weeks beginning on Mondays.&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1261-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="sắp-xếp-thứ-tự-trục-y" class="section level3 unnumbered">
<h3>Sắp xếp thứ tự trục y</h3>
<p>Hiện tại, các cơ sở được sắp xếp theo thứ tự “theo bảng chữ cái” từ dưới lên trên. Nếu bạn muốn điều chỉnh thứ tự các cơ sở trục y, hãy chuyển đổi chúng thành factor thứ bậc và cung cấp thứ tự. Xem thêm chương <a href="factors.html#factors">Factors</a> để biết các mẹo để thực hiện điều này.</p>
<p>Vì có rất nhiều cơ sở và chúng ta không muốn viết hết chúng ra, chúng ta sẽ thử một cách tiếp cận khác - sắp xếp thứ tự các cơ sở trong data frame và sử dụng cột tên kết quả làm thứ tự của factor. Bên dưới, cột <code>location_name</code> được chuyển đổi thành một factor và thứ tự của các cấp của nó được đặt dựa trên tổng số ngày báo cáo do cơ sở nộp trong toàn bộ khoảng thời gian.</p>
<p>Để làm điều này, chúng ta tạo một data frame đại diện cho tổng số báo cáo cho mỗi cơ sở, được sắp xếp theo thứ tự tăng dần. Chúng ta có thể sử dụng vectơ này để sắp xếp các mức thứ tự trong biểu đồ.</p>
<div class="sourceCode" id="cb1617"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1617-1"><a href="heatmaps.html#cb1617-1" tabindex="-1"></a>facility_order <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span> </span>
<span id="cb1617-2"><a href="heatmaps.html#cb1617-2" tabindex="-1"></a>  <span class="fu">group_by</span>(location_name) <span class="sc">%&gt;%</span> </span>
<span id="cb1617-3"><a href="heatmaps.html#cb1617-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">tot_reports =</span> <span class="fu">sum</span>(n_days_reported, <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb1617-4"><a href="heatmaps.html#cb1617-4" tabindex="-1"></a>  <span class="fu">arrange</span>(tot_reports) <span class="co"># ascending order</span></span></code></pre></div>
<p>Xem data frame bên dưới:</p>
<div class="datatables html-widget html-fill-item" id="htmlwidget-d8741d5f7a21311b5202" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-d8741d5f7a21311b5202">{"x":{"filter":"none","vertical":false,"data":[["Facility 56","Facility 65","Facility 11","Facility 39","Facility 59","Facility 27","Facility 51","Facility 32","Facility 7","Facility 1","Facility 9","Facility 35","Facility 50","Facility 58","Facility 28"],[1,6,20,33,35,42,42,43,44,48,50,52,53,55,77]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>tot_reports<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1},{"name":"location_name","targets":0},{"name":"tot_reports","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>Bây giờ, hãy sử dụng một cột từ data frame bên trên (<code>facility_order$location_name</code>) để trở thành thứ bậc factors của biến <code>location_name</code> trong data frame <code>agg_weeks</code>:</p>
<div class="sourceCode" id="cb1618"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1618-1"><a href="heatmaps.html#cb1618-1" tabindex="-1"></a><span class="co"># load package </span></span>
<span id="cb1618-2"><a href="heatmaps.html#cb1618-2" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(forcats)</span>
<span id="cb1618-3"><a href="heatmaps.html#cb1618-3" tabindex="-1"></a></span>
<span id="cb1618-4"><a href="heatmaps.html#cb1618-4" tabindex="-1"></a><span class="co"># create factor and define levels manually</span></span>
<span id="cb1618-5"><a href="heatmaps.html#cb1618-5" tabindex="-1"></a>agg_weeks <span class="ot">&lt;-</span> agg_weeks <span class="sc">%&gt;%</span> </span>
<span id="cb1618-6"><a href="heatmaps.html#cb1618-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">location_name =</span> <span class="fu">fct_relevel</span>(</span>
<span id="cb1618-7"><a href="heatmaps.html#cb1618-7" tabindex="-1"></a>    location_name, facility_order<span class="sc">$</span>location_name)</span>
<span id="cb1618-8"><a href="heatmaps.html#cb1618-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>Và bây giờ dữ liệu được vẽ lại, với <code>location_name</code> trở thành một factor có thứ tự:</p>
<div class="sourceCode" id="cb1619"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1619-1"><a href="heatmaps.html#cb1619-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> agg_weeks)<span class="sc">+</span> </span>
<span id="cb1619-2"><a href="heatmaps.html#cb1619-2" tabindex="-1"></a>  </span>
<span id="cb1619-3"><a href="heatmaps.html#cb1619-3" tabindex="-1"></a>  <span class="co"># show data as tiles</span></span>
<span id="cb1619-4"><a href="heatmaps.html#cb1619-4" tabindex="-1"></a>  <span class="fu">geom_tile</span>(</span>
<span id="cb1619-5"><a href="heatmaps.html#cb1619-5" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> week,</span>
<span id="cb1619-6"><a href="heatmaps.html#cb1619-6" tabindex="-1"></a>        <span class="at">y =</span> location_name,</span>
<span id="cb1619-7"><a href="heatmaps.html#cb1619-7" tabindex="-1"></a>        <span class="at">fill =</span> p_days_reported),      </span>
<span id="cb1619-8"><a href="heatmaps.html#cb1619-8" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;white&quot;</span>)<span class="sc">+</span>                 <span class="co"># white gridlines</span></span>
<span id="cb1619-9"><a href="heatmaps.html#cb1619-9" tabindex="-1"></a>  </span>
<span id="cb1619-10"><a href="heatmaps.html#cb1619-10" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb1619-11"><a href="heatmaps.html#cb1619-11" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb1619-12"><a href="heatmaps.html#cb1619-12" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;darkgreen&quot;</span>,</span>
<span id="cb1619-13"><a href="heatmaps.html#cb1619-13" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>)<span class="sc">+</span></span>
<span id="cb1619-14"><a href="heatmaps.html#cb1619-14" tabindex="-1"></a>  </span>
<span id="cb1619-15"><a href="heatmaps.html#cb1619-15" tabindex="-1"></a>  <span class="co"># date axis</span></span>
<span id="cb1619-16"><a href="heatmaps.html#cb1619-16" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb1619-17"><a href="heatmaps.html#cb1619-17" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),             <span class="co"># remove extra space on sides</span></span>
<span id="cb1619-18"><a href="heatmaps.html#cb1619-18" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">&quot;2 weeks&quot;</span>,     <span class="co"># labels every 2 weeks</span></span>
<span id="cb1619-19"><a href="heatmaps.html#cb1619-19" tabindex="-1"></a>    <span class="at">date_labels =</span> <span class="st">&quot;%d</span><span class="sc">\n</span><span class="st">%b&quot;</span>)<span class="sc">+</span>     <span class="co"># format is day over month (\n in newline)</span></span>
<span id="cb1619-20"><a href="heatmaps.html#cb1619-20" tabindex="-1"></a>  </span>
<span id="cb1619-21"><a href="heatmaps.html#cb1619-21" tabindex="-1"></a>  <span class="co"># aesthetic themes</span></span>
<span id="cb1619-22"><a href="heatmaps.html#cb1619-22" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span>                                  <span class="co"># simplify background</span></span>
<span id="cb1619-23"><a href="heatmaps.html#cb1619-23" tabindex="-1"></a>  </span>
<span id="cb1619-24"><a href="heatmaps.html#cb1619-24" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1619-25"><a href="heatmaps.html#cb1619-25" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1619-26"><a href="heatmaps.html#cb1619-26" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1619-27"><a href="heatmaps.html#cb1619-27" tabindex="-1"></a>    <span class="at">legend.key.height =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">1</span>,<span class="st">&quot;cm&quot;</span>),           <span class="co"># height of legend key</span></span>
<span id="cb1619-28"><a href="heatmaps.html#cb1619-28" tabindex="-1"></a>    <span class="at">legend.key.width  =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="fl">0.6</span>,<span class="st">&quot;cm&quot;</span>),         <span class="co"># width of legend key</span></span>
<span id="cb1619-29"><a href="heatmaps.html#cb1619-29" tabindex="-1"></a>    </span>
<span id="cb1619-30"><a href="heatmaps.html#cb1619-30" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),              <span class="co"># axis text size</span></span>
<span id="cb1619-31"><a href="heatmaps.html#cb1619-31" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">vjust=</span><span class="fl">0.2</span>),            <span class="co"># axis text alignment</span></span>
<span id="cb1619-32"><a href="heatmaps.html#cb1619-32" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.4</span>),               </span>
<span id="cb1619-33"><a href="heatmaps.html#cb1619-33" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># axis title size and bold</span></span>
<span id="cb1619-34"><a href="heatmaps.html#cb1619-34" tabindex="-1"></a>    </span>
<span id="cb1619-35"><a href="heatmaps.html#cb1619-35" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>,<span class="at">size=</span><span class="dv">14</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># title right-aligned, large, bold</span></span>
<span id="cb1619-36"><a href="heatmaps.html#cb1619-36" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)  <span class="co"># caption right-aligned and italic</span></span>
<span id="cb1619-37"><a href="heatmaps.html#cb1619-37" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb1619-38"><a href="heatmaps.html#cb1619-38" tabindex="-1"></a>  </span>
<span id="cb1619-39"><a href="heatmaps.html#cb1619-39" tabindex="-1"></a>  <span class="co"># plot labels</span></span>
<span id="cb1619-40"><a href="heatmaps.html#cb1619-40" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Week&quot;</span>,</span>
<span id="cb1619-41"><a href="heatmaps.html#cb1619-41" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Facility name&quot;</span>,</span>
<span id="cb1619-42"><a href="heatmaps.html#cb1619-42" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Reporting</span><span class="sc">\n</span><span class="st">performance (%)&quot;</span>,           <span class="co"># legend title, because legend shows fill</span></span>
<span id="cb1619-43"><a href="heatmaps.html#cb1619-43" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Percent of days per week that facility reported data&quot;</span>,</span>
<span id="cb1619-44"><a href="heatmaps.html#cb1619-44" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;District health facilities, May-July 2020&quot;</span>,</span>
<span id="cb1619-45"><a href="heatmaps.html#cb1619-45" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;7-day weeks beginning on Mondays.&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1265-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="biểu-diễn-các-giá-trị" class="section level3 unnumbered">
<h3>Biểu diễn các giá trị</h3>
<p>Bạn có thể thêm lớp văn bản <code>geom_text()</code> lên phía trên các ô, để hiển thị số lượng thực của mỗi ô. Hãy lưu ý rằng điều này có thể trông không đẹp nếu bạn có nhiều ô nhỏ!</p>
<p>Đoạn code sau đã được thêm vào: <code>geom_text(aes(label = p_days_reported))</code>. Điều này giúp thêm văn bản vào từng ô. Văn bản được hiển thị là giá trị được gán cho đối số <code>label =</code>, trong trường hợp này đã được đặt thành cùng một cột số <code>p_days_reported</code> cũng được sử dụng để tạo gradient màu.</p>
<div class="sourceCode" id="cb1620"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1620-1"><a href="heatmaps.html#cb1620-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> agg_weeks)<span class="sc">+</span> </span>
<span id="cb1620-2"><a href="heatmaps.html#cb1620-2" tabindex="-1"></a>  </span>
<span id="cb1620-3"><a href="heatmaps.html#cb1620-3" tabindex="-1"></a>  <span class="co"># show data as tiles</span></span>
<span id="cb1620-4"><a href="heatmaps.html#cb1620-4" tabindex="-1"></a>  <span class="fu">geom_tile</span>(</span>
<span id="cb1620-5"><a href="heatmaps.html#cb1620-5" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> week,</span>
<span id="cb1620-6"><a href="heatmaps.html#cb1620-6" tabindex="-1"></a>        <span class="at">y =</span> location_name,</span>
<span id="cb1620-7"><a href="heatmaps.html#cb1620-7" tabindex="-1"></a>        <span class="at">fill =</span> p_days_reported),      </span>
<span id="cb1620-8"><a href="heatmaps.html#cb1620-8" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;white&quot;</span>)<span class="sc">+</span>                 <span class="co"># white gridlines</span></span>
<span id="cb1620-9"><a href="heatmaps.html#cb1620-9" tabindex="-1"></a>  </span>
<span id="cb1620-10"><a href="heatmaps.html#cb1620-10" tabindex="-1"></a>  <span class="co"># text</span></span>
<span id="cb1620-11"><a href="heatmaps.html#cb1620-11" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb1620-12"><a href="heatmaps.html#cb1620-12" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb1620-13"><a href="heatmaps.html#cb1620-13" tabindex="-1"></a>      <span class="at">x =</span> week,</span>
<span id="cb1620-14"><a href="heatmaps.html#cb1620-14" tabindex="-1"></a>      <span class="at">y =</span> location_name,</span>
<span id="cb1620-15"><a href="heatmaps.html#cb1620-15" tabindex="-1"></a>      <span class="at">label =</span> p_days_reported))<span class="sc">+</span>      <span class="co"># add text on top of tile</span></span>
<span id="cb1620-16"><a href="heatmaps.html#cb1620-16" tabindex="-1"></a>  </span>
<span id="cb1620-17"><a href="heatmaps.html#cb1620-17" tabindex="-1"></a>  <span class="co"># fill scale</span></span>
<span id="cb1620-18"><a href="heatmaps.html#cb1620-18" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb1620-19"><a href="heatmaps.html#cb1620-19" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb1620-20"><a href="heatmaps.html#cb1620-20" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;darkgreen&quot;</span>,</span>
<span id="cb1620-21"><a href="heatmaps.html#cb1620-21" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>)<span class="sc">+</span></span>
<span id="cb1620-22"><a href="heatmaps.html#cb1620-22" tabindex="-1"></a>  </span>
<span id="cb1620-23"><a href="heatmaps.html#cb1620-23" tabindex="-1"></a>  <span class="co"># date axis</span></span>
<span id="cb1620-24"><a href="heatmaps.html#cb1620-24" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb1620-25"><a href="heatmaps.html#cb1620-25" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),             <span class="co"># remove extra space on sides</span></span>
<span id="cb1620-26"><a href="heatmaps.html#cb1620-26" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">&quot;2 weeks&quot;</span>,     <span class="co"># labels every 2 weeks</span></span>
<span id="cb1620-27"><a href="heatmaps.html#cb1620-27" tabindex="-1"></a>    <span class="at">date_labels =</span> <span class="st">&quot;%d</span><span class="sc">\n</span><span class="st">%b&quot;</span>)<span class="sc">+</span>     <span class="co"># format is day over month (\n in newline)</span></span>
<span id="cb1620-28"><a href="heatmaps.html#cb1620-28" tabindex="-1"></a>  </span>
<span id="cb1620-29"><a href="heatmaps.html#cb1620-29" tabindex="-1"></a>  <span class="co"># aesthetic themes</span></span>
<span id="cb1620-30"><a href="heatmaps.html#cb1620-30" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span>                                    <span class="co"># simplify background</span></span>
<span id="cb1620-31"><a href="heatmaps.html#cb1620-31" tabindex="-1"></a>  </span>
<span id="cb1620-32"><a href="heatmaps.html#cb1620-32" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1620-33"><a href="heatmaps.html#cb1620-33" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1620-34"><a href="heatmaps.html#cb1620-34" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb1620-35"><a href="heatmaps.html#cb1620-35" tabindex="-1"></a>    <span class="at">legend.key.height =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">1</span>,<span class="st">&quot;cm&quot;</span>),           <span class="co"># height of legend key</span></span>
<span id="cb1620-36"><a href="heatmaps.html#cb1620-36" tabindex="-1"></a>    <span class="at">legend.key.width  =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="fl">0.6</span>,<span class="st">&quot;cm&quot;</span>),         <span class="co"># width of legend key</span></span>
<span id="cb1620-37"><a href="heatmaps.html#cb1620-37" tabindex="-1"></a>    </span>
<span id="cb1620-38"><a href="heatmaps.html#cb1620-38" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),              <span class="co"># axis text size</span></span>
<span id="cb1620-39"><a href="heatmaps.html#cb1620-39" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">vjust=</span><span class="fl">0.2</span>),            <span class="co"># axis text alignment</span></span>
<span id="cb1620-40"><a href="heatmaps.html#cb1620-40" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_line</span>(<span class="at">size=</span><span class="fl">0.4</span>),               </span>
<span id="cb1620-41"><a href="heatmaps.html#cb1620-41" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># axis title size and bold</span></span>
<span id="cb1620-42"><a href="heatmaps.html#cb1620-42" tabindex="-1"></a>    </span>
<span id="cb1620-43"><a href="heatmaps.html#cb1620-43" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>,<span class="at">size=</span><span class="dv">14</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),  <span class="co"># title right-aligned, large, bold</span></span>
<span id="cb1620-44"><a href="heatmaps.html#cb1620-44" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)  <span class="co"># caption right-aligned and italic</span></span>
<span id="cb1620-45"><a href="heatmaps.html#cb1620-45" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb1620-46"><a href="heatmaps.html#cb1620-46" tabindex="-1"></a>  </span>
<span id="cb1620-47"><a href="heatmaps.html#cb1620-47" tabindex="-1"></a>  <span class="co"># plot labels</span></span>
<span id="cb1620-48"><a href="heatmaps.html#cb1620-48" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Week&quot;</span>,</span>
<span id="cb1620-49"><a href="heatmaps.html#cb1620-49" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Facility name&quot;</span>,</span>
<span id="cb1620-50"><a href="heatmaps.html#cb1620-50" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Reporting</span><span class="sc">\n</span><span class="st">performance (%)&quot;</span>,           <span class="co"># legend title, because legend shows fill</span></span>
<span id="cb1620-51"><a href="heatmaps.html#cb1620-51" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Percent of days per week that facility reported data&quot;</span>,</span>
<span id="cb1620-52"><a href="heatmaps.html#cb1620-52" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;District health facilities, May-July 2020&quot;</span>,</span>
<span id="cb1620-53"><a href="heatmaps.html#cb1620-53" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;7-day weeks beginning on Mondays.&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1266-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
<div id="nguồn-9" class="section level2" number="34.4">
<h2><span class="header-section-number">34.4</span> Nguồn</h2>
<p><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient()</a></p>
<p><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">R graph gallery - heatmap</a></p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Cẩm nang dịch tễ học với R</strong>" was written by the handbook team. It was last built on 2024-02-16.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
