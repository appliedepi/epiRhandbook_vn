<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>23 Chuỗi thời gian và phát hiện ổ dịch | Cẩm nang dịch tễ học với R</title>

    <meta name="author" content="the handbook team" />
  
   <meta name="description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="23 Chuỗi thời gian và phát hiện ổ dịch | Cẩm nang dịch tễ học với R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="23 Chuỗi thời gian và phát hiện ổ dịch | Cẩm nang dịch tễ học với R" />
  
  <meta name="twitter:description" content="The Epi R Handbook is a R reference manual for applied epidemiology and public health." />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.6.1/transition.js"></script>
    <script src="libs/bs3compat-0.6.1/tabs.js"></script>
    <script src="libs/bs3compat-0.6.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.31/datatables.js"></script>
    <link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
    <link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
    <script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
    <link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
    <script src="libs/selectize-0.12.0/selectize.min.js"></script>
    <link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet" />
    <script src="libs/tabwid-1.1.3/tabwid.js"></script>
    <link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-1.3.1/leaflet.js"></script>
    <link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
    <script src="libs/proj4-2.6.2/proj4.min.js"></script>
    <script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding-2.2.1/leaflet.js"></script>
    <script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
    <script src="libs/leaflet-providers-plugin-2.2.1/leaflet-providers-plugin.js"></script>
    <script src="libs/viz-1.8.2/viz.js"></script>
    <link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
    <script src="libs/grViz-binding-1.0.11/grViz.js"></script>
    <script src="libs/d3-4.5.0/d3.min.js"></script>
    <script src="libs/sankey-1/sankey.js"></script>
    <script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>
    <script src="libs/plotly-binding-4.10.4/plotly.js"></script>
    <script src="libs/typedarray-0.1/typedarray.min.js"></script>
    <link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>
    <link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
    <script src="libs/vis-9.1.0/vis-network.min.js"></script>
    <script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script>
    <link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script>
    <script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script>
    <script src="libs/proj4js-2.3.15/proj4.js"></script>
    <link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet" />
    <script src="libs/highcharts-9.3.1/highcharts.js"></script>
    <script src="libs/highcharts-9.3.1/highcharts-3d.js"></script>
    <script src="libs/highcharts-9.3.1/highcharts-more.js"></script>
    <script src="libs/highcharts-9.3.1/modules/stock.js"></script>
    <script src="libs/highcharts-9.3.1/modules/map.js"></script>
    <script src="libs/highcharts-9.3.1/modules/data.js"></script>
    <script src="libs/highcharts-9.3.1/modules/exporting.js"></script>
    <script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script>
    <script src="libs/highcharts-9.3.1/modules/drilldown.js"></script>
    <script src="libs/highcharts-9.3.1/modules/item-series.js"></script>
    <script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script>
    <script src="libs/highcharts-9.3.1/modules/annotations.js"></script>
    <script src="libs/highcharts-9.3.1/modules/export-data.js"></script>
    <script src="libs/highcharts-9.3.1/modules/funnel.js"></script>
    <script src="libs/highcharts-9.3.1/modules/heatmap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/treemap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/sankey.js"></script>
    <script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script>
    <script src="libs/highcharts-9.3.1/modules/organization.js"></script>
    <script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script>
    <script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script>
    <script src="libs/highcharts-9.3.1/modules/sunburst.js"></script>
    <script src="libs/highcharts-9.3.1/modules/vector.js"></script>
    <script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script>
    <script src="libs/highcharts-9.3.1/modules/xrange.js"></script>
    <script src="libs/highcharts-9.3.1/modules/tilemap.js"></script>
    <script src="libs/highcharts-9.3.1/modules/venn.js"></script>
    <script src="libs/highcharts-9.3.1/modules/gantt.js"></script>
    <script src="libs/highcharts-9.3.1/modules/timeline.js"></script>
    <script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script>
    <script src="libs/highcharts-9.3.1/modules/bullet.js"></script>
    <script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script>
    <script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script>
    <script src="libs/highcharts-9.3.1/modules/lollipop.js"></script>
    <script src="libs/highcharts-9.3.1/modules/series-label.js"></script>
    <script src="libs/highcharts-9.3.1/plugins/motion.js"></script>
    <script src="libs/highcharts-9.3.1/custom/reset.js"></script>
    <script src="libs/highcharts-9.3.1/modules/boost.js"></script>
    <script src="libs/highchart-binding-0.9.4/highchart.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>

    <div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
      <strong>Bạn cần trợ giúp khi học R?</strong> Hãy tham gia <a href="https://www.appliedepi.org/live/" class="alert-link">khóa học</a>, trải nghiệm <a href="https://www.appliedepi.org/tutorial/" class="alert-link">các học phần miễn phí</a>, gửi bài viết <a href="https://community.appliedepi.org/" class="alert-link">trên trang Cộng đồng</a>, hoặc liên hệ <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ hỗ trợ của chúng tôi</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
      <link rel="stylesheet" href="style_bs4.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Cẩm nang dịch tễ học với R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="time-series" class="section level1" number="23">
<h1><span class="header-section-number">23</span> Chuỗi thời gian và phát hiện ổ dịch</h1>
<!-- ======================================================= -->
<div id="tổng-quan-2" class="section level2" number="23.1">
<h2><span class="header-section-number">23.1</span> Tổng quan</h2>
<p>Chương này minh họa cách sử dụng của một số packages cho phân tích chuỗi thời gian. Các packages chủ yếu đến từ hệ sinh thái <a href="https://tidyverts.org/"><strong>tidyverts</strong></a>, ngoài ra cũng sử dụng RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a> package để fit các mô hình dịch tễ học bệnh truyền nhiễm.</p>
<p>VÍ dụ dưới đây chúng ta sẽ sử dụng bộ dữ liệu về Campylobacter ở Đức thuộc package <strong>surveillance</strong> (xem chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a> để biết thêm chi tiết). Tuy nhiên, nếu bạn muốn thử chạy code này trên bộ dữ liệu lớn hơn (nhiều quốc gia hoặc tầng), bạn có thể tham khảo code mẫu tại <a href="https://github.com/R4EPI/epitsa">repo github của r4epis</a>.</p>
<p>Các chủ đề được đề cập bao gồm:</p>
<ol style="list-style-type: decimal">
<li>Dữ liệu chuỗi thời gian</li>
<li>Phân tích mô tả</li>
<li>Fitting đường hồi quy</li>
<li>Mối liên hệ của hai chuỗi thời gian</li>
<li>Phát hiện dịch bệnh</li>
<li>Chuỗi thời gian bị gián đoạn</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="chuẩn-bị-13" class="section level2" number="23.2">
<h2><span class="header-section-number">23.2</span> Chuẩn bị</h2>
<div id="packages-1" class="section level3 unnumbered">
<h3>Packages</h3>
<p>Đoạn code này hiển thị việc gọi các package cần thiết cho các phân tích. Trong cuốn sách này, chúng tôi nhấn mạnh việc sử dụng hàm <code>p_load()</code> từ package <strong>pacman</strong>, giúp cài đặt các package cần thiết <em>và</em> gọi chúng ra để sử dụng. Bạn cũng có thể gọi các packages đã cài đặt với hàm <code>library()</code> của <strong>base</strong> R. Xem thêm chương <a href="basics.html#basics">R cơ bản</a> để có thêm thông tin về các packages trong R.</p>
<div class="sourceCode" id="cb1103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1103-1"><a href="time-series.html#cb1103-1" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(rio,          <span class="co"># File import</span></span>
<span id="cb1103-2"><a href="time-series.html#cb1103-2" tabindex="-1"></a>               here,         <span class="co"># File locator</span></span>
<span id="cb1103-3"><a href="time-series.html#cb1103-3" tabindex="-1"></a>               tidyverse,    <span class="co"># data management + ggplot2 graphics</span></span>
<span id="cb1103-4"><a href="time-series.html#cb1103-4" tabindex="-1"></a>               tsibble,      <span class="co"># handle time series datasets</span></span>
<span id="cb1103-5"><a href="time-series.html#cb1103-5" tabindex="-1"></a>               slider,       <span class="co"># for calculating moving averages</span></span>
<span id="cb1103-6"><a href="time-series.html#cb1103-6" tabindex="-1"></a>               imputeTS,     <span class="co"># for filling in missing values</span></span>
<span id="cb1103-7"><a href="time-series.html#cb1103-7" tabindex="-1"></a>               feasts,       <span class="co"># for time series decomposition and autocorrelation</span></span>
<span id="cb1103-8"><a href="time-series.html#cb1103-8" tabindex="-1"></a>               forecast,     <span class="co"># fit sin and cosin terms to data (note: must load after feasts)</span></span>
<span id="cb1103-9"><a href="time-series.html#cb1103-9" tabindex="-1"></a>               trending,     <span class="co"># fit and assess models </span></span>
<span id="cb1103-10"><a href="time-series.html#cb1103-10" tabindex="-1"></a>               tmaptools,    <span class="co"># for getting geocoordinates (lon/lat) based on place names</span></span>
<span id="cb1103-11"><a href="time-series.html#cb1103-11" tabindex="-1"></a>               ecmwfr,       <span class="co"># for interacting with copernicus sateliate CDS API</span></span>
<span id="cb1103-12"><a href="time-series.html#cb1103-12" tabindex="-1"></a>               stars,        <span class="co"># for reading in .nc (climate data) files</span></span>
<span id="cb1103-13"><a href="time-series.html#cb1103-13" tabindex="-1"></a>               units,        <span class="co"># for defining units of measurement (climate data)</span></span>
<span id="cb1103-14"><a href="time-series.html#cb1103-14" tabindex="-1"></a>               yardstick,    <span class="co"># for looking at model accuracy</span></span>
<span id="cb1103-15"><a href="time-series.html#cb1103-15" tabindex="-1"></a>               surveillance  <span class="co"># for aberration detection</span></span>
<span id="cb1103-16"><a href="time-series.html#cb1103-16" tabindex="-1"></a>               )</span></code></pre></div>
</div>
<div id="nhập-dữ-liệu-12" class="section level3 unnumbered">
<h3>Nhập dữ liệu</h3>
<p>Bạn có thể tải xuống tất cả dữ liệu được sử dụng trong sổ tay này thông qua các hướng dẫn trong chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a>.</p>
<p>Bộ dữ liệu minh họa được sử dụng trong phần này là số lượng các trường hợp campylobacter hàng tuần được báo cáo ở Đức từ năm 2001 đến 2011. <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx' class='download-button'>Bạn có thể bấm vào đây để tải xuống<span> bộ dữ liệu này (.xlsx).</span></a></p>
<p>Bộ dữ liệu này là một phiên bản rút gọn của bộ dữ liệu có sẵn trong package <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a>. (để biết chi tiết, hãy gọi surveillance package ra sau đó nhập <code>?campyDE</code>)</p>
<p>Nhập dữ liệu này với hàm <code>import()</code> từ package <strong>rio</strong> (nó xử lý nhiều loại tệp như .xlsx, .csv, .rds - xem thêm chương <a href="importing.html#importing">Nhập xuất dữ liệu</a> để biết thêm chi tiết).</p>
<div class="sourceCode" id="cb1104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1104-1"><a href="time-series.html#cb1104-1" tabindex="-1"></a><span class="co"># import the counts into R</span></span>
<span id="cb1104-2"><a href="time-series.html#cb1104-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(<span class="st">&quot;campylobacter_germany.xlsx&quot;</span>)</span></code></pre></div>
<p>10 hàng đầu tiên được hiển thị như bên dưới.</p>
<div class="datatables html-widget html-fill-item" id="htmlwidget-b48e93f3a918f652a1d0" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b48e93f3a918f652a1d0">{"x":{"filter":"none","vertical":false,"data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1},{"name":"date","targets":0},{"name":"case","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="làm-sạch-dữ-liệu" class="section level3 unnumbered">
<h3>Làm sạch dữ liệu</h3>
<p>Code dưới đây đảm bảo rằng cột ngày thág đã ở đúng định dạng. Trong chương này chúng ta sẽ sử dụng package <strong>tsibble</strong> và hàm <code>yearweek</code> sẽ được sử dụng để tạp biến lịch theo tuần. Có một số cách để thực hiện việc này (Xem chương <a href="dates.html#dates">Làm việc với ngày tháng</a> để biết thêm chi tiết), tuy nhiên đối với dữ liệu chuỗi thời gian thì tốt nhất nên sử dụng thống nhất một framework (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb1105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1105-1"><a href="time-series.html#cb1105-1" tabindex="-1"></a><span class="do">## ensure the date column is in the appropriate format</span></span>
<span id="cb1105-2"><a href="time-series.html#cb1105-2" tabindex="-1"></a>counts<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(counts<span class="sc">$</span>date)</span>
<span id="cb1105-3"><a href="time-series.html#cb1105-3" tabindex="-1"></a></span>
<span id="cb1105-4"><a href="time-series.html#cb1105-4" tabindex="-1"></a><span class="do">## create a calendar week variable </span></span>
<span id="cb1105-5"><a href="time-series.html#cb1105-5" tabindex="-1"></a><span class="do">## fitting ISO definitons of weeks starting on a monday</span></span>
<span id="cb1105-6"><a href="time-series.html#cb1105-6" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1105-7"><a href="time-series.html#cb1105-7" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">epiweek =</span> <span class="fu">yearweek</span>(date, <span class="at">week_start =</span> <span class="dv">1</span>))</span></code></pre></div>
</div>
<div id="tải-xuống-dữ-liệu-khí-hậu" class="section level3 unnumbered">
<h3>Tải xuống dữ liệu khí hậu</h3>
<p>Trong mục <em>mối tương quan của hai chuỗi thời gian</em> trong chương này, chúng ta sẽ so sánh số lượng trường hợp campylobacter với dữ liệu khí hậu.
Dữ liệu khí hậu tại bất kỳ đâu trên thế giới đều có thể được tải xuống từ EU’s Copernicus Satellite. Đây không phải là các phép đo chính xác, mà dựa trên một mô hình (tương tự như phép nội suy), tuy nhiên lợi ích là mức độ bao phủ toàn cầu hàng giờ cũng như các dự báo.</p>
<p>Bạn có thể tải xuống từng tệp dữ liệu khí hậu này từ chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a>.</p>
<p>Với mục đích minh họa ở đây, chúng tôi sẽ trình bày code để sử dụng package <strong>ecmwfr</strong> để lấy những dữ liệu này từ kho dữ liệu khí hậu Copernicus. Bạn sẽ cần tạo một tài khoản miễn phí để thực hiện. Trang web của package có một <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">hướng dẫn</a> hữu ích về cách thực hiện việc này. Dưới đây là code minh họa về cách thực hiện việc này, khi bạn có các khóa API thích hợp. Bạn phải thay thế X bên dưới bằng ID tài khoản của mình. Bạn sẽ cần tải xuống một năm dữ liệu cùng một lúc nếu không máy chủ sẽ hết thời gian chờ.</p>
<p>Nếu bạn không chắc chắn về tọa độ cho vị trí mà bạn muốn tải dữ liệu xuống, bạn có thể sử dụng gói <strong>tmaptools</strong> để lấy tọa độ ra từ open street maps. Một cách khác là dùng package <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>, tuy nhiên nó chưa được chính thức xuất bản lên trên CRAN; cái hay của <strong>photon</strong> là nó cung cấp nhiều dữ liệu ngữ cảnh hơn khi có một số kết quả phù hợp cho tìm kiếm của bạn.</p>
<div class="sourceCode" id="cb1106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1106-1"><a href="time-series.html#cb1106-1" tabindex="-1"></a><span class="do">## retrieve location coordinates</span></span>
<span id="cb1106-2"><a href="time-series.html#cb1106-2" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">geocode_OSM</span>(<span class="st">&quot;Germany&quot;</span>, <span class="at">geometry =</span> <span class="st">&quot;point&quot;</span>)</span>
<span id="cb1106-3"><a href="time-series.html#cb1106-3" tabindex="-1"></a></span>
<span id="cb1106-4"><a href="time-series.html#cb1106-4" tabindex="-1"></a><span class="do">## pull together long/lats in format for ERA-5 querying (bounding box) </span></span>
<span id="cb1106-5"><a href="time-series.html#cb1106-5" tabindex="-1"></a><span class="do">## (as just want a single point can repeat coords)</span></span>
<span id="cb1106-6"><a href="time-series.html#cb1106-6" tabindex="-1"></a>request_coords <span class="ot">&lt;-</span> <span class="fu">str_glue_data</span>(coords<span class="sc">$</span>coords, <span class="st">&quot;{y}/{x}/{y}/{x}&quot;</span>)</span>
<span id="cb1106-7"><a href="time-series.html#cb1106-7" tabindex="-1"></a></span>
<span id="cb1106-8"><a href="time-series.html#cb1106-8" tabindex="-1"></a></span>
<span id="cb1106-9"><a href="time-series.html#cb1106-9" tabindex="-1"></a><span class="do">## Pulling data modelled from copernicus satellite (ERA-5 reanalysis)</span></span>
<span id="cb1106-10"><a href="time-series.html#cb1106-10" tabindex="-1"></a><span class="do">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span id="cb1106-11"><a href="time-series.html#cb1106-11" tabindex="-1"></a><span class="do">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span id="cb1106-12"><a href="time-series.html#cb1106-12" tabindex="-1"></a></span>
<span id="cb1106-13"><a href="time-series.html#cb1106-13" tabindex="-1"></a><span class="do">## set up key for weather data </span></span>
<span id="cb1106-14"><a href="time-series.html#cb1106-14" tabindex="-1"></a><span class="fu">wf_set_key</span>(<span class="at">user =</span> <span class="st">&quot;XXXXX&quot;</span>,</span>
<span id="cb1106-15"><a href="time-series.html#cb1106-15" tabindex="-1"></a>           <span class="at">key =</span> <span class="st">&quot;XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX&quot;</span>,</span>
<span id="cb1106-16"><a href="time-series.html#cb1106-16" tabindex="-1"></a>           <span class="at">service =</span> <span class="st">&quot;cds&quot;</span>) </span>
<span id="cb1106-17"><a href="time-series.html#cb1106-17" tabindex="-1"></a></span>
<span id="cb1106-18"><a href="time-series.html#cb1106-18" tabindex="-1"></a><span class="do">## run for each year of interest (otherwise server times out)</span></span>
<span id="cb1106-19"><a href="time-series.html#cb1106-19" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2002</span><span class="sc">:</span><span class="dv">2011</span>) {</span>
<span id="cb1106-20"><a href="time-series.html#cb1106-20" tabindex="-1"></a>  </span>
<span id="cb1106-21"><a href="time-series.html#cb1106-21" tabindex="-1"></a>  <span class="do">## pull together a query </span></span>
<span id="cb1106-22"><a href="time-series.html#cb1106-22" tabindex="-1"></a>  <span class="do">## see here for how to do: https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span id="cb1106-23"><a href="time-series.html#cb1106-23" tabindex="-1"></a>  <span class="do">## change request to a list using addin button above (python to list)</span></span>
<span id="cb1106-24"><a href="time-series.html#cb1106-24" tabindex="-1"></a>  <span class="do">## Target is the name of the output file!!</span></span>
<span id="cb1106-25"><a href="time-series.html#cb1106-25" tabindex="-1"></a>  request <span class="ot">&lt;-</span> request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1106-26"><a href="time-series.html#cb1106-26" tabindex="-1"></a>    <span class="at">product_type =</span> <span class="st">&quot;reanalysis&quot;</span>,</span>
<span id="cb1106-27"><a href="time-series.html#cb1106-27" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">&quot;netcdf&quot;</span>,</span>
<span id="cb1106-28"><a href="time-series.html#cb1106-28" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&quot;2m_temperature&quot;</span>, <span class="st">&quot;total_precipitation&quot;</span>),</span>
<span id="cb1106-29"><a href="time-series.html#cb1106-29" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">c</span>(i),</span>
<span id="cb1106-30"><a href="time-series.html#cb1106-30" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">c</span>(<span class="st">&quot;01&quot;</span>, <span class="st">&quot;02&quot;</span>, <span class="st">&quot;03&quot;</span>, <span class="st">&quot;04&quot;</span>, <span class="st">&quot;05&quot;</span>, <span class="st">&quot;06&quot;</span>, <span class="st">&quot;07&quot;</span>, <span class="st">&quot;08&quot;</span>, <span class="st">&quot;09&quot;</span>, <span class="st">&quot;10&quot;</span>, <span class="st">&quot;11&quot;</span>, <span class="st">&quot;12&quot;</span>),</span>
<span id="cb1106-31"><a href="time-series.html#cb1106-31" tabindex="-1"></a>    <span class="at">day =</span> <span class="fu">c</span>(<span class="st">&quot;01&quot;</span>, <span class="st">&quot;02&quot;</span>, <span class="st">&quot;03&quot;</span>, <span class="st">&quot;04&quot;</span>, <span class="st">&quot;05&quot;</span>, <span class="st">&quot;06&quot;</span>, <span class="st">&quot;07&quot;</span>, <span class="st">&quot;08&quot;</span>, <span class="st">&quot;09&quot;</span>, <span class="st">&quot;10&quot;</span>, <span class="st">&quot;11&quot;</span>, <span class="st">&quot;12&quot;</span>,</span>
<span id="cb1106-32"><a href="time-series.html#cb1106-32" tabindex="-1"></a>            <span class="st">&quot;13&quot;</span>, <span class="st">&quot;14&quot;</span>, <span class="st">&quot;15&quot;</span>, <span class="st">&quot;16&quot;</span>, <span class="st">&quot;17&quot;</span>, <span class="st">&quot;18&quot;</span>, <span class="st">&quot;19&quot;</span>, <span class="st">&quot;20&quot;</span>, <span class="st">&quot;21&quot;</span>, <span class="st">&quot;22&quot;</span>, <span class="st">&quot;23&quot;</span>, <span class="st">&quot;24&quot;</span>,</span>
<span id="cb1106-33"><a href="time-series.html#cb1106-33" tabindex="-1"></a>            <span class="st">&quot;25&quot;</span>, <span class="st">&quot;26&quot;</span>, <span class="st">&quot;27&quot;</span>, <span class="st">&quot;28&quot;</span>, <span class="st">&quot;29&quot;</span>, <span class="st">&quot;30&quot;</span>, <span class="st">&quot;31&quot;</span>),</span>
<span id="cb1106-34"><a href="time-series.html#cb1106-34" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">&quot;00:00&quot;</span>, <span class="st">&quot;01:00&quot;</span>, <span class="st">&quot;02:00&quot;</span>, <span class="st">&quot;03:00&quot;</span>, <span class="st">&quot;04:00&quot;</span>, <span class="st">&quot;05:00&quot;</span>, <span class="st">&quot;06:00&quot;</span>, <span class="st">&quot;07:00&quot;</span>,</span>
<span id="cb1106-35"><a href="time-series.html#cb1106-35" tabindex="-1"></a>             <span class="st">&quot;08:00&quot;</span>, <span class="st">&quot;09:00&quot;</span>, <span class="st">&quot;10:00&quot;</span>, <span class="st">&quot;11:00&quot;</span>, <span class="st">&quot;12:00&quot;</span>, <span class="st">&quot;13:00&quot;</span>, <span class="st">&quot;14:00&quot;</span>, <span class="st">&quot;15:00&quot;</span>,</span>
<span id="cb1106-36"><a href="time-series.html#cb1106-36" tabindex="-1"></a>             <span class="st">&quot;16:00&quot;</span>, <span class="st">&quot;17:00&quot;</span>, <span class="st">&quot;18:00&quot;</span>, <span class="st">&quot;19:00&quot;</span>, <span class="st">&quot;20:00&quot;</span>, <span class="st">&quot;21:00&quot;</span>, <span class="st">&quot;22:00&quot;</span>, <span class="st">&quot;23:00&quot;</span>),</span>
<span id="cb1106-37"><a href="time-series.html#cb1106-37" tabindex="-1"></a>    <span class="at">area =</span> request_coords,</span>
<span id="cb1106-38"><a href="time-series.html#cb1106-38" tabindex="-1"></a>    <span class="at">dataset_short_name =</span> <span class="st">&quot;reanalysis-era5-single-levels&quot;</span>,</span>
<span id="cb1106-39"><a href="time-series.html#cb1106-39" tabindex="-1"></a>    <span class="at">target =</span> <span class="fu">paste0</span>(<span class="st">&quot;germany_weather&quot;</span>, i, <span class="st">&quot;.nc&quot;</span>)</span>
<span id="cb1106-40"><a href="time-series.html#cb1106-40" tabindex="-1"></a>  )</span>
<span id="cb1106-41"><a href="time-series.html#cb1106-41" tabindex="-1"></a>  </span>
<span id="cb1106-42"><a href="time-series.html#cb1106-42" tabindex="-1"></a>  <span class="do">## download the file and store it in the current working directory</span></span>
<span id="cb1106-43"><a href="time-series.html#cb1106-43" tabindex="-1"></a>  file <span class="ot">&lt;-</span> <span class="fu">wf_request</span>(<span class="at">user     =</span> <span class="st">&quot;XXXXX&quot;</span>,  <span class="co"># user ID (for authentication)</span></span>
<span id="cb1106-44"><a href="time-series.html#cb1106-44" tabindex="-1"></a>                     <span class="at">request  =</span> request,  <span class="co"># the request</span></span>
<span id="cb1106-45"><a href="time-series.html#cb1106-45" tabindex="-1"></a>                     <span class="at">transfer =</span> <span class="cn">TRUE</span>,     <span class="co"># download the file</span></span>
<span id="cb1106-46"><a href="time-series.html#cb1106-46" tabindex="-1"></a>                     <span class="at">path     =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;Weather&quot;</span>)) <span class="do">## path to save the data</span></span>
<span id="cb1106-47"><a href="time-series.html#cb1106-47" tabindex="-1"></a>  }</span></code></pre></div>
</div>
<div id="nhập-dữ-liệu-khí-hậu" class="section level3 unnumbered">
<h3>Nhập dữ liệu khí hậu</h3>
<p>Cho dù bạn đã tải xuống dữ liệu khí hậu thông qua sổ tay này hay sử dụng code ở trên, thì bạn cần phải các tệp dữ liệu khí hậu trong 10 năm có phần mở rộng là “.nc”, được lưu trữ trong cùng một thư mục trong máy tính của bạn.</p>
<p>Sử dụng mã bên dưới để nhập các tệp này vào R với package <strong>stars</strong>.</p>
<div class="sourceCode" id="cb1107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1107-1"><a href="time-series.html#cb1107-1" tabindex="-1"></a><span class="do">## define path to weather folder </span></span>
<span id="cb1107-2"><a href="time-series.html#cb1107-2" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb1107-3"><a href="time-series.html#cb1107-3" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;time_series&quot;</span>, <span class="st">&quot;weather&quot;</span>), <span class="co"># replace with your own file path </span></span>
<span id="cb1107-4"><a href="time-series.html#cb1107-4" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1107-5"><a href="time-series.html#cb1107-5" tabindex="-1"></a></span>
<span id="cb1107-6"><a href="time-series.html#cb1107-6" tabindex="-1"></a><span class="do">## only keep those with the current name of interest </span></span>
<span id="cb1107-7"><a href="time-series.html#cb1107-7" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> file_paths[<span class="fu">str_detect</span>(file_paths, <span class="st">&quot;germany&quot;</span>)]</span>
<span id="cb1107-8"><a href="time-series.html#cb1107-8" tabindex="-1"></a></span>
<span id="cb1107-9"><a href="time-series.html#cb1107-9" tabindex="-1"></a><span class="do">## read in all the files as a stars object </span></span>
<span id="cb1107-10"><a href="time-series.html#cb1107-10" tabindex="-1"></a>data <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">read_stars</span>(file_paths)</span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Khi các tệp này đã được nhập vào một đối tượng có tên <code>data</code>, chúng ta sẽ chuyển chúng thành một data frame.</p>
<div class="sourceCode" id="cb1109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1109-1"><a href="time-series.html#cb1109-1" tabindex="-1"></a><span class="do">## change to a data frame </span></span>
<span id="cb1109-2"><a href="time-series.html#cb1109-2" tabindex="-1"></a>temp_data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb1109-3"><a href="time-series.html#cb1109-3" tabindex="-1"></a>  <span class="do">## add in variables and correct units</span></span>
<span id="cb1109-4"><a href="time-series.html#cb1109-4" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1109-5"><a href="time-series.html#cb1109-5" tabindex="-1"></a>    <span class="do">## create an calendar week variable </span></span>
<span id="cb1109-6"><a href="time-series.html#cb1109-6" tabindex="-1"></a>    <span class="at">epiweek =</span> tsibble<span class="sc">::</span><span class="fu">yearweek</span>(time), </span>
<span id="cb1109-7"><a href="time-series.html#cb1109-7" tabindex="-1"></a>    <span class="do">## create a date variable (start of calendar week)</span></span>
<span id="cb1109-8"><a href="time-series.html#cb1109-8" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(epiweek),</span>
<span id="cb1109-9"><a href="time-series.html#cb1109-9" tabindex="-1"></a>    <span class="do">## change temperature from kelvin to celsius</span></span>
<span id="cb1109-10"><a href="time-series.html#cb1109-10" tabindex="-1"></a>    <span class="at">t2m =</span> <span class="fu">set_units</span>(t2m, celsius), </span>
<span id="cb1109-11"><a href="time-series.html#cb1109-11" tabindex="-1"></a>    <span class="do">## change precipitation from metres to millimetres </span></span>
<span id="cb1109-12"><a href="time-series.html#cb1109-12" tabindex="-1"></a>    <span class="at">tp  =</span> <span class="fu">set_units</span>(tp, mm)) <span class="sc">%&gt;%</span> </span>
<span id="cb1109-13"><a href="time-series.html#cb1109-13" tabindex="-1"></a>  <span class="do">## group by week (keep the date too though)</span></span>
<span id="cb1109-14"><a href="time-series.html#cb1109-14" tabindex="-1"></a>  <span class="fu">group_by</span>(epiweek, date) <span class="sc">%&gt;%</span> </span>
<span id="cb1109-15"><a href="time-series.html#cb1109-15" tabindex="-1"></a>  <span class="do">## get the average per week</span></span>
<span id="cb1109-16"><a href="time-series.html#cb1109-16" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">t2m =</span> <span class="fu">as.numeric</span>(<span class="fu">mean</span>(t2m)), </span>
<span id="cb1109-17"><a href="time-series.html#cb1109-17" tabindex="-1"></a>            <span class="at">tp =</span> <span class="fu">as.numeric</span>(<span class="fu">mean</span>(tp)))</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;epiweek&#39;. You can override using the `.groups`
## argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="dữ-liệu-chuỗi-thời-gian" class="section level2" number="23.3">
<h2><span class="header-section-number">23.3</span> Dữ liệu chuỗi thời gian</h2>
<p>Có một số package khác nhau để cấu trúc và xử lý dữ liệu chuỗi thời gian. Như đã nói, chúng ta sẽ tập trung vào họ các package thuộc <strong>tidyverts</strong> và sẽ sử dụng package <strong>tsibble</strong> để xác định đối tượng chuỗi thời gian. Việc có một tập dữ liệu được xác định là một đối tượng chuỗi thời gian có nghĩa là việc cấu trúc phân tích của chúng ta sẽ trở nên dễ dàng hơn nhiều.</p>
<p>Để thực hiện, chúng ta sử dụng hàm <code>tsibble()</code> và cụ thể “chỉ mục (index)”, vd: biến số cụ thể đơn vị thời gian quan tâm. Trong trường hợp của chúng ta, biến số này có tên <code>epiweek</code>.</p>
<p>Ví dụ: nếu chúng ta có một tập dữ liệu với số lượng hàng tuần theo tỉnh, chúng ta cũng có thể cụ thể biến nhóm bằng cách cụ sử dụng đối số <code>key =</code>. Điều này sẽ cho phép chúng ta thực hiện phân tích cho từng nhóm.</p>
<div class="sourceCode" id="cb1111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1111-1"><a href="time-series.html#cb1111-1" tabindex="-1"></a><span class="do">## define time series object </span></span>
<span id="cb1111-2"><a href="time-series.html#cb1111-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(counts, <span class="at">index =</span> epiweek)</span></code></pre></div>
<p>Nhìn vào <code>class(counts)</code>, ta thấy ngoài việc là một data frame gọn gàng (“tbl_df”, “tbl”, “data.frame”), nó có các thuộc tính bổ sung của một khung dữ liệu chuỗi thời gian (“tbl_ts”).</p>
<p>Bạn có thể xem nhanh dữ liệu của mình bằng cách sử dụng <strong>ggplot2</strong>. Từ biểu đồ ta thấy có một xu hướng theo mùa, và không có bất kỳ giá trị bị thiếu nào. Tuy nhiên, dường như có vấn đề với việc báo cáo vào đầu mỗi năm; số ca mắc bệnh giảm vào tuần cuối cùng của năm và sau đó tăng vào tuần đầu tiên của năm tiếp theo.</p>
<div class="sourceCode" id="cb1112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1112-1"><a href="time-series.html#cb1112-1" tabindex="-1"></a><span class="do">## plot a line graph of cases by week</span></span>
<span id="cb1112-2"><a href="time-series.html#cb1112-2" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> case)) <span class="sc">+</span> </span>
<span id="cb1112-3"><a href="time-series.html#cb1112-3" tabindex="-1"></a>     <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/basic_plot-1.png" width="672" /></p>
<p><span style="color: red;"><strong><em>NGUY HIỂM:</em></strong> Không giống như ví dụ này, phần lớn các bộ dữ liệu sẽ chưa được làm sạch. Bạn sẽ cần phải kiểm tra các bản ghi trùng lặp và bản ghi bị thiếu như bên dưới.</span></p>
<!-- ======================================================= -->
<div id="trùng-lặp" class="section level3 unnumbered">
<h3>Trùng lặp</h3>
<p><strong>tsibble</strong> không cho phép các quan sát trùng lặp. Vì vậy, mỗi hàng sẽ cần phải là duy nhất, hoặc duy nhất trong nhóm (biến <code>key</code>). Package này có một số hàm để xác định các bản ghi trùng lặp. Chúng bao gồm các hàm: <code>are_duplicated()</code> trả về một vectơ có giá trị TRUE/FALSE vector, truy vấn xem hàng có là duy nhất không; và hàm <code>duplicates()</code> sẽ cung cấp cho bạn một data frame chứa các hàng trùng lặp.</p>
<p>Xem chương <a href="cleaning.html#loại-bỏ-trùng-lặp">Loại bỏ trùng lặp</a> để biết thêm chi tiết về cách lựa chọn các hàng bạn muốn.</p>
<div class="sourceCode" id="cb1113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1113-1"><a href="time-series.html#cb1113-1" tabindex="-1"></a><span class="do">## get a vector of TRUE/FALSE whether rows are duplicates</span></span>
<span id="cb1113-2"><a href="time-series.html#cb1113-2" tabindex="-1"></a><span class="fu">are_duplicated</span>(counts, <span class="at">index =</span> epiweek) </span>
<span id="cb1113-3"><a href="time-series.html#cb1113-3" tabindex="-1"></a></span>
<span id="cb1113-4"><a href="time-series.html#cb1113-4" tabindex="-1"></a><span class="do">## get a data frame of any duplicated rows </span></span>
<span id="cb1113-5"><a href="time-series.html#cb1113-5" tabindex="-1"></a><span class="fu">duplicates</span>(counts, <span class="at">index =</span> epiweek) </span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="bản-ghi-bị-thiếu" class="section level3 unnumbered">
<h3>Bản ghi bị thiếu</h3>
<p>Chúng ta đã thấy từ cuộc khảo sát tóm tắt bên trên, không có bất kỳ giá trị missing nào được phát hiện, nhưng chúng ta cũng đã thấy rằng dường như có vấn đề với việc báo cáo chậm trễ vào khoảng năm mới. Một cách để giải quyết vấn đề này có thể là đặt các giá trị này thành missing và sau đó impute các giá trị. Dạng đơn giản nhất của khi impute chuỗi thời gian là vẽ một đường thẳng giữa giá trị không bị thiếu cuối cùng và giá trị không bị thiếu tiếp theo. Để làm điều này, chúng ta sẽ sử dụng hàm <code>na_interpolation()</code> từ package <strong>imputeTS</strong> .</p>
<p>Xem chương <a href="missing-data.html#missing-data">Dữ liệu Missing</a> để biết các tùy chọn khác của imputation.</p>
<p>Một giải pháp thay thế khác sẽ là tính toán đường trung bình động, để thử và giải quyết các vấn đề báo cáo rõ ràng này (xem phần tiếp theo và chương <a href="moving-average.html#moving-average">Đường trung bình động</a>.</p>
<div class="sourceCode" id="cb1114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1114-1"><a href="time-series.html#cb1114-1" tabindex="-1"></a><span class="do">## create a variable with missings instead of weeks with reporting issues</span></span>
<span id="cb1114-2"><a href="time-series.html#cb1114-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1114-3"><a href="time-series.html#cb1114-3" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">case_miss =</span> <span class="fu">if_else</span>(</span>
<span id="cb1114-4"><a href="time-series.html#cb1114-4" tabindex="-1"></a>          <span class="do">## if epiweek contains 52, 53, 1 or 2</span></span>
<span id="cb1114-5"><a href="time-series.html#cb1114-5" tabindex="-1"></a>          <span class="fu">str_detect</span>(epiweek, <span class="st">&quot;W51|W52|W53|W01|W02&quot;</span>), </span>
<span id="cb1114-6"><a href="time-series.html#cb1114-6" tabindex="-1"></a>          <span class="do">## then set to missing </span></span>
<span id="cb1114-7"><a href="time-series.html#cb1114-7" tabindex="-1"></a>          <span class="cn">NA_real_</span>, </span>
<span id="cb1114-8"><a href="time-series.html#cb1114-8" tabindex="-1"></a>          <span class="do">## otherwise keep the value in case</span></span>
<span id="cb1114-9"><a href="time-series.html#cb1114-9" tabindex="-1"></a>          case</span>
<span id="cb1114-10"><a href="time-series.html#cb1114-10" tabindex="-1"></a>     ))</span>
<span id="cb1114-11"><a href="time-series.html#cb1114-11" tabindex="-1"></a></span>
<span id="cb1114-12"><a href="time-series.html#cb1114-12" tabindex="-1"></a><span class="do">## alternatively interpolate missings by linear trend </span></span>
<span id="cb1114-13"><a href="time-series.html#cb1114-13" tabindex="-1"></a><span class="do">## between two nearest adjacent points</span></span>
<span id="cb1114-14"><a href="time-series.html#cb1114-14" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1114-15"><a href="time-series.html#cb1114-15" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">case_int =</span> imputeTS<span class="sc">::</span><span class="fu">na_interpolation</span>(case_miss)</span>
<span id="cb1114-16"><a href="time-series.html#cb1114-16" tabindex="-1"></a>         )</span>
<span id="cb1114-17"><a href="time-series.html#cb1114-17" tabindex="-1"></a></span>
<span id="cb1114-18"><a href="time-series.html#cb1114-18" tabindex="-1"></a><span class="do">## to check what values have been imputed compared to the original</span></span>
<span id="cb1114-19"><a href="time-series.html#cb1114-19" tabindex="-1"></a><span class="fu">ggplot_na_imputations</span>(counts<span class="sc">$</span>case_miss, counts<span class="sc">$</span>case_int) <span class="sc">+</span> </span>
<span id="cb1114-20"><a href="time-series.html#cb1114-20" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1114-21"><a href="time-series.html#cb1114-21" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/missings-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
<div id="phân-tích-mô-tả" class="section level2" number="23.4">
<h2><span class="header-section-number">23.4</span> Phân tích mô tả</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Đường trung bình động</h3>
<p>Nếu dữ liệu rất nhiễu (dao động lên và xuống), việc tính toán đường trung bình động có thể sẽ hữu ích. Trong ví dụ dưới đây, với mỗi tuần chúng ta sẽ tính toán số trường hợp trung bình từ bốn tuần trước đó. Việc này sẽ giúp dữ liệu dễ diễn giải hơn. Trong trường hợp của chúng ta, điều này không thực sự bổ sung nhiều, vì vậy chúng ta sẽ bám vào dữ liệu nội suy để phân tích thêm. Xem chương <a href="moving-average.html#moving-average">Đường trung bình động</a> để biết thêm chi tiết.</p>
<div class="sourceCode" id="cb1115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1115-1"><a href="time-series.html#cb1115-1" tabindex="-1"></a><span class="do">## create a moving average variable (deals with missings)</span></span>
<span id="cb1115-2"><a href="time-series.html#cb1115-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1115-3"><a href="time-series.html#cb1115-3" tabindex="-1"></a>     <span class="do">## create the ma_4w variable </span></span>
<span id="cb1115-4"><a href="time-series.html#cb1115-4" tabindex="-1"></a>     <span class="do">## slide over each row of the case variable</span></span>
<span id="cb1115-5"><a href="time-series.html#cb1115-5" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">ma_4wk =</span> slider<span class="sc">::</span><span class="fu">slide_dbl</span>(case, </span>
<span id="cb1115-6"><a href="time-series.html#cb1115-6" tabindex="-1"></a>                               <span class="do">## for each row calculate the name</span></span>
<span id="cb1115-7"><a href="time-series.html#cb1115-7" tabindex="-1"></a>                               <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1115-8"><a href="time-series.html#cb1115-8" tabindex="-1"></a>                               <span class="do">## use the four previous weeks</span></span>
<span id="cb1115-9"><a href="time-series.html#cb1115-9" tabindex="-1"></a>                               <span class="at">.before =</span> <span class="dv">4</span>))</span>
<span id="cb1115-10"><a href="time-series.html#cb1115-10" tabindex="-1"></a></span>
<span id="cb1115-11"><a href="time-series.html#cb1115-11" tabindex="-1"></a><span class="do">## make a quick visualisation of the difference </span></span>
<span id="cb1115-12"><a href="time-series.html#cb1115-12" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1115-13"><a href="time-series.html#cb1115-13" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case)) <span class="sc">+</span> </span>
<span id="cb1115-14"><a href="time-series.html#cb1115-14" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ma_4wk), <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/moving_averages-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="tính-chu-kỳ" class="section level3 unnumbered">
<h3>Tính chu kỳ</h3>
<p>Sau đây chúng ta sẽ định nghĩa một hàm để tạo một biểu đồ chu kỳ. Xem chương <a href="basics.html#viết-hàm">Viết hàm</a> để biết cách tạo một hàm trong R.</p>
<p>Đầu tiên, hàm được định nghĩa. Các đối số của nó bao gồm một bộ dữ liệu với cột <code>counts</code>, <code>start_week =</code> là tuần đầu tiên của bộ dữ liệu, một con số để cho biết có bao nhiêu chu kỳ mỗi năm (ví dụ: 52, 12), và cuối cùng là kiểu đầu ra (xem chi tiết trong đoạn mã bên dưới).</p>
<div class="sourceCode" id="cb1116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1116-1"><a href="time-series.html#cb1116-1" tabindex="-1"></a><span class="do">## Function arguments</span></span>
<span id="cb1116-2"><a href="time-series.html#cb1116-2" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb1116-3"><a href="time-series.html#cb1116-3" tabindex="-1"></a><span class="do">## x is a dataset</span></span>
<span id="cb1116-4"><a href="time-series.html#cb1116-4" tabindex="-1"></a><span class="do">## counts is variable with count data or rates within x </span></span>
<span id="cb1116-5"><a href="time-series.html#cb1116-5" tabindex="-1"></a><span class="do">## start_week is the first week in your dataset</span></span>
<span id="cb1116-6"><a href="time-series.html#cb1116-6" tabindex="-1"></a><span class="do">## period is how many units in a year </span></span>
<span id="cb1116-7"><a href="time-series.html#cb1116-7" tabindex="-1"></a><span class="do">## output is whether you want return spectral periodogram or the peak weeks</span></span>
<span id="cb1116-8"><a href="time-series.html#cb1116-8" tabindex="-1"></a>  <span class="do">## &quot;periodogram&quot; or &quot;weeks&quot;</span></span>
<span id="cb1116-9"><a href="time-series.html#cb1116-9" tabindex="-1"></a></span>
<span id="cb1116-10"><a href="time-series.html#cb1116-10" tabindex="-1"></a><span class="co"># Define function</span></span>
<span id="cb1116-11"><a href="time-series.html#cb1116-11" tabindex="-1"></a>periodogram <span class="ot">&lt;-</span> <span class="cf">function</span>(x, </span>
<span id="cb1116-12"><a href="time-series.html#cb1116-12" tabindex="-1"></a>                        counts, </span>
<span id="cb1116-13"><a href="time-series.html#cb1116-13" tabindex="-1"></a>                        <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>), </span>
<span id="cb1116-14"><a href="time-series.html#cb1116-14" tabindex="-1"></a>                        <span class="at">period =</span> <span class="dv">52</span>, </span>
<span id="cb1116-15"><a href="time-series.html#cb1116-15" tabindex="-1"></a>                        <span class="at">output =</span> <span class="st">&quot;weeks&quot;</span>) {</span>
<span id="cb1116-16"><a href="time-series.html#cb1116-16" tabindex="-1"></a>  </span>
<span id="cb1116-17"><a href="time-series.html#cb1116-17" tabindex="-1"></a></span>
<span id="cb1116-18"><a href="time-series.html#cb1116-18" tabindex="-1"></a>    <span class="do">## make sure is not a tsibble, filter to project and only keep columns of interest</span></span>
<span id="cb1116-19"><a href="time-series.html#cb1116-19" tabindex="-1"></a>    prepare_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">as_tibble</span>(x)</span>
<span id="cb1116-20"><a href="time-series.html#cb1116-20" tabindex="-1"></a>    </span>
<span id="cb1116-21"><a href="time-series.html#cb1116-21" tabindex="-1"></a>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span id="cb1116-22"><a href="time-series.html#cb1116-22" tabindex="-1"></a>    prepare_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(prepare_data, {{counts}})</span>
<span id="cb1116-23"><a href="time-series.html#cb1116-23" tabindex="-1"></a>    </span>
<span id="cb1116-24"><a href="time-series.html#cb1116-24" tabindex="-1"></a>    <span class="do">## create an intermediate &quot;zoo&quot; time series to be able to use with spec.pgram</span></span>
<span id="cb1116-25"><a href="time-series.html#cb1116-25" tabindex="-1"></a>    zoo_cases <span class="ot">&lt;-</span> zoo<span class="sc">::</span><span class="fu">zooreg</span>(prepare_data, </span>
<span id="cb1116-26"><a href="time-series.html#cb1116-26" tabindex="-1"></a>                             <span class="at">start =</span> start_week, <span class="at">frequency =</span> period)</span>
<span id="cb1116-27"><a href="time-series.html#cb1116-27" tabindex="-1"></a>    </span>
<span id="cb1116-28"><a href="time-series.html#cb1116-28" tabindex="-1"></a>    <span class="do">## get a spectral periodogram not using fast fourier transform </span></span>
<span id="cb1116-29"><a href="time-series.html#cb1116-29" tabindex="-1"></a>    periodo <span class="ot">&lt;-</span> <span class="fu">spec.pgram</span>(zoo_cases, <span class="at">fast =</span> <span class="cn">FALSE</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1116-30"><a href="time-series.html#cb1116-30" tabindex="-1"></a>    </span>
<span id="cb1116-31"><a href="time-series.html#cb1116-31" tabindex="-1"></a>    <span class="do">## return the peak weeks </span></span>
<span id="cb1116-32"><a href="time-series.html#cb1116-32" tabindex="-1"></a>    periodo_weeks <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> periodo<span class="sc">$</span>freq[<span class="fu">order</span>(<span class="sc">-</span>periodo<span class="sc">$</span>spec)] <span class="sc">*</span> period</span>
<span id="cb1116-33"><a href="time-series.html#cb1116-33" tabindex="-1"></a>    </span>
<span id="cb1116-34"><a href="time-series.html#cb1116-34" tabindex="-1"></a>    <span class="cf">if</span> (output <span class="sc">==</span> <span class="st">&quot;weeks&quot;</span>) {</span>
<span id="cb1116-35"><a href="time-series.html#cb1116-35" tabindex="-1"></a>      periodo_weeks</span>
<span id="cb1116-36"><a href="time-series.html#cb1116-36" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1116-37"><a href="time-series.html#cb1116-37" tabindex="-1"></a>      periodo</span>
<span id="cb1116-38"><a href="time-series.html#cb1116-38" tabindex="-1"></a>    }</span>
<span id="cb1116-39"><a href="time-series.html#cb1116-39" tabindex="-1"></a>    </span>
<span id="cb1116-40"><a href="time-series.html#cb1116-40" tabindex="-1"></a>}</span>
<span id="cb1116-41"><a href="time-series.html#cb1116-41" tabindex="-1"></a></span>
<span id="cb1116-42"><a href="time-series.html#cb1116-42" tabindex="-1"></a><span class="do">## get spectral periodogram for extracting weeks with the highest frequencies </span></span>
<span id="cb1116-43"><a href="time-series.html#cb1116-43" tabindex="-1"></a><span class="do">## (checking of seasonality) </span></span>
<span id="cb1116-44"><a href="time-series.html#cb1116-44" tabindex="-1"></a>periodo <span class="ot">&lt;-</span> <span class="fu">periodogram</span>(counts, </span>
<span id="cb1116-45"><a href="time-series.html#cb1116-45" tabindex="-1"></a>                       case_int, </span>
<span id="cb1116-46"><a href="time-series.html#cb1116-46" tabindex="-1"></a>                       <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>),</span>
<span id="cb1116-47"><a href="time-series.html#cb1116-47" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">&quot;periodogram&quot;</span>)</span>
<span id="cb1116-48"><a href="time-series.html#cb1116-48" tabindex="-1"></a></span>
<span id="cb1116-49"><a href="time-series.html#cb1116-49" tabindex="-1"></a><span class="do">## pull spectrum and frequence in to a dataframe for plotting</span></span>
<span id="cb1116-50"><a href="time-series.html#cb1116-50" tabindex="-1"></a>periodo <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(periodo<span class="sc">$</span>freq, periodo<span class="sc">$</span>spec)</span>
<span id="cb1116-51"><a href="time-series.html#cb1116-51" tabindex="-1"></a></span>
<span id="cb1116-52"><a href="time-series.html#cb1116-52" tabindex="-1"></a><span class="do">## plot a periodogram showing the most frequently occuring periodicity </span></span>
<span id="cb1116-53"><a href="time-series.html#cb1116-53" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> periodo, </span>
<span id="cb1116-54"><a href="time-series.html#cb1116-54" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">/</span>(periodo.freq<span class="sc">/</span><span class="dv">52</span>),  <span class="at">y =</span> <span class="fu">log</span>(periodo.spec))) <span class="sc">+</span> </span>
<span id="cb1116-55"><a href="time-series.html#cb1116-55" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb1116-56"><a href="time-series.html#cb1116-56" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Period (Weeks)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Log(density)&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/periodogram-1.png" width="672" /></p>
<div class="sourceCode" id="cb1117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1117-1"><a href="time-series.html#cb1117-1" tabindex="-1"></a><span class="do">## get a vector weeks in ascending order </span></span>
<span id="cb1117-2"><a href="time-series.html#cb1117-2" tabindex="-1"></a>peak_weeks <span class="ot">&lt;-</span> <span class="fu">periodogram</span>(counts, </span>
<span id="cb1117-3"><a href="time-series.html#cb1117-3" tabindex="-1"></a>                          case_int, </span>
<span id="cb1117-4"><a href="time-series.html#cb1117-4" tabindex="-1"></a>                          <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>), </span>
<span id="cb1117-5"><a href="time-series.html#cb1117-5" tabindex="-1"></a>                          <span class="at">output =</span> <span class="st">&quot;weeks&quot;</span>)</span></code></pre></div>
<p><span style="color: black;"><strong><em>LƯU Ý:</em></strong> Có thể sử dụng các tuần ở trên để thêm chúng vào các chu kỳ sin và cosin, tuy nhiên chúng ta sẽ sử dụng một hàm để tạo ra các chu kỳ này (xem phần hồi quy bên dưới) </span></p>
<!-- ======================================================= -->
</div>
<div id="tách-nhỏ-chuỗi-thời-gian" class="section level3 unnumbered">
<h3>Tách nhỏ chuỗi thời gian</h3>
<p>Phân tách cổ điển được sử dụng để chia nhỏ một chuỗi thời gian thành một số phần, khi kết hợp lại với nhau sẽ tạo nên xu hướng mà bạn nhìn thấy. Các phần khác nhau này là:</p>
<ul>
<li>Chu kỳ xu hướng (hướng dài hạn của dữ liệu)<br />
</li>
<li>Theo mùa (lặp lại xu hướng)<br />
</li>
<li>Sự ngẫu nhiên (những gì còn lại sau khi loại bỏ xu hướng và theo mùa)</li>
</ul>
<div class="sourceCode" id="cb1118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1118-1"><a href="time-series.html#cb1118-1" tabindex="-1"></a><span class="do">## decompose the counts dataset </span></span>
<span id="cb1118-2"><a href="time-series.html#cb1118-2" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1118-3"><a href="time-series.html#cb1118-3" tabindex="-1"></a>  <span class="co"># using an additive classical decomposition model</span></span>
<span id="cb1118-4"><a href="time-series.html#cb1118-4" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(case_int, <span class="at">type =</span> <span class="st">&quot;additive&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1118-5"><a href="time-series.html#cb1118-5" tabindex="-1"></a>  <span class="do">## extract the important information from the model</span></span>
<span id="cb1118-6"><a href="time-series.html#cb1118-6" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1118-7"><a href="time-series.html#cb1118-7" tabindex="-1"></a>  <span class="do">## generate a plot </span></span>
<span id="cb1118-8"><a href="time-series.html#cb1118-8" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/decomposition-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="tự-tương-quan" class="section level3 unnumbered">
<h3>Tự tương quan</h3>
<p>Tự tương quan cho bạn biết về mối quan hệ giữa số lượng của mỗi tuần và các tuần trước đó (được gọi là trễ).</p>
<p>Sử dụng hàm <code>ACF()</code>, chúng ta có thể tạo ra một biểu đồ cho chúng ta thấy số lượng đường có mối quan hệ ở các độ trễ khác nhau. Khi độ trễ bằng 0 (x = 0), đường này sẽ luôn là 1 vì nó cho thấy mối quan hệ giữa một quan sát và chính nó (không được hiển thị). Đường đầu tiên hiển thị ở đây (x = 1) cho thấy mối quan hệ giữa mỗi quan sát và quan sát trước nó (độ trễ bằng 1), đường thứ hai cho thấy mối quan hệ giữa mỗi quan sát và quan sát trước quan sát cuối cùng (độ trễ là 2) và cứ như thế cho đến khi độ trễ là 52, cho thấy mối quan hệ giữa mỗi quan sát và quan sát từ 1 năm (52 tuần trước đó).</p>
<p>Sử dụng hàm <code>ACF()</code> (cho tự tương quan một phần) hiển thị cùng một loại quan hệ nhưng được hiệu chỉnh cho tất cả các tuần khác nằm giữa. Nó sẽ ít thông tin hơn để xác định tính chu kỳ.</p>
<div class="sourceCode" id="cb1119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1119-1"><a href="time-series.html#cb1119-1" tabindex="-1"></a><span class="do">## using the counts dataset</span></span>
<span id="cb1119-2"><a href="time-series.html#cb1119-2" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1119-3"><a href="time-series.html#cb1119-3" tabindex="-1"></a>  <span class="do">## calculate autocorrelation using a full years worth of lags</span></span>
<span id="cb1119-4"><a href="time-series.html#cb1119-4" tabindex="-1"></a>  <span class="fu">ACF</span>(case_int, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1119-5"><a href="time-series.html#cb1119-5" tabindex="-1"></a>  <span class="do">## show a plot</span></span>
<span id="cb1119-6"><a href="time-series.html#cb1119-6" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/autocorrelation-1.png" width="672" /></p>
<div class="sourceCode" id="cb1120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1120-1"><a href="time-series.html#cb1120-1" tabindex="-1"></a><span class="do">## using the counts data set </span></span>
<span id="cb1120-2"><a href="time-series.html#cb1120-2" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1120-3"><a href="time-series.html#cb1120-3" tabindex="-1"></a>  <span class="do">## calculate the partial autocorrelation using a full years worth of lags</span></span>
<span id="cb1120-4"><a href="time-series.html#cb1120-4" tabindex="-1"></a>  <span class="fu">PACF</span>(case_int, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1120-5"><a href="time-series.html#cb1120-5" tabindex="-1"></a>  <span class="do">## show a plot</span></span>
<span id="cb1120-6"><a href="time-series.html#cb1120-6" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/autocorrelation-2.png" width="672" /></p>
<p>Bạn có thể kiểm định giả thuyết không về tính độc lập trong một chuỗi thời gian (vd: không tự tương quan) sử dụng kiểm định Ljung-Box (trong package <strong>stats</strong>). Giá trị p có ý nghĩa cho thấy rằng có sự tự tương quan trong dữ liệu.</p>
<div class="sourceCode" id="cb1121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1121-1"><a href="time-series.html#cb1121-1" tabindex="-1"></a><span class="do">## test for independance </span></span>
<span id="cb1121-2"><a href="time-series.html#cb1121-2" tabindex="-1"></a><span class="fu">Box.test</span>(counts<span class="sc">$</span>case_int, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="fit-mô-hình-hồi-quy" class="section level2" number="23.5">
<h2><span class="header-section-number">23.5</span> Fit mô hình hồi quy</h2>
<p>Có thể fit một số lượng lớn các hồi quy khác nhau vào một chuỗi thời gian, tuy nhiên ở đây chúng tôi sẽ trình bày cách để fit một hồi quy nhị thức âm - vì nó thường phù hợp nhất cho dữ liệu về trường hợp bệnh trong các bệnh truyền nhiễm.</p>
<!-- ======================================================= -->
<div id="chu-kỳ-fourier" class="section level3 unnumbered">
<h3>Chu kỳ Fourier</h3>
<p>Chu kỳ Fourier tương đương với các đường cong sin và cosin. Sự khác biệt là chúng được dựa trên việc tìm ra sự kết hợp thích hợp nhất của các đường cong để giải thích dữ liệu của bạn.</p>
<p>If only fitting một chu kỳ Fourier, điều này sẽ tương đương với việc fitting một đường sin và cosin cho độ trễ xảy ra thường xuyên nhất được thấy trong biểu đồ chu kỳ của bạn (trong trường hợp của chúng ta là 52 tuần). Chúng ta sử dụng hàm <code>fourier()</code> từ package <strong>forecast</strong>.</p>
<p>Trong code dưới đây, chúng ta gán bằng cách sử dụng <code>$</code>, vì hàm <code>fourier()</code> trả về hai cột (một cho sin và một cho cosin) và vì vậy chúng được thêm vào tập dữ liệu dưới dạng danh sách, được gọi là “fourier” - nhưng danh sách này sau đó có thể được sử dụng như một biến bình thường trong hồi quy.</p>
<div class="sourceCode" id="cb1123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1123-1"><a href="time-series.html#cb1123-1" tabindex="-1"></a><span class="do">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span id="cb1123-2"><a href="time-series.html#cb1123-2" tabindex="-1"></a>counts<span class="sc">$</span>fourier <span class="ot">&lt;-</span> <span class="fu">select</span>(counts, epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1123-3"><a href="time-series.html#cb1123-3" tabindex="-1"></a>  <span class="fu">fourier</span>(<span class="at">K =</span> <span class="dv">1</span>)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="hồi-quy-nhị-thức-âm" class="section level3 unnumbered">
<h3>Hồi quy nhị thức âm</h3>
<p>Bạn có thể fit các mô hình hồi quy sử dụng các hàm từ package <strong>stats</strong> hoặc <strong>MASS</strong> trong base R (vd: <code>lm()</code>, <code>glm()</code> và <code>glm.nb()</code>). Tuy nhiên, chúng ta sẽ sử dụng các hàm từ package <strong>trending</strong>, vì nó cho phép tính khoảng tin cậy và khoảng tiên lượng phù hợp (các hàm khác không có sẵn). Cú pháp vẫn như vậy, bạn cụ thể biến đầu ra và theo sau bởi dấu ngã (~), sau đó thêm các biến giải thích vào, phân cách nhau bởi dấu cộng (+).</p>
<p>Sự khác biệt là đầu tiên chúng ta phải xác định model trước, và sau đó <code>fit()</code> nó vào dữ liệu. Điều này rất hữu ích vì nó cho phép so sánh nhiều mô hình khác nhau với cùng một cú pháp..</p>
<p><span style="color: darkgreen;"><strong><em>MẸO:</em></strong> Nếu bạn muốn sử dụng tỷ suất hơn là số lượng, bạn có thể bao gồm biến dân số dưới dạng thuật ngữ bù logarit, bằng cách thêm <code>offset(log(population)</code>. Sau đó, bạn sẽ cần đặt dân số là 1, trước khi sử dụng hàm <code>predict()</code> để tạo ra tỷ suất. </span></p>
<p><span style="color: darkgreen;"><strong><em>MẸO:</em></strong> Để fit những mô hình phức tạp hơn chẳng hạn như ARIMA hoặc prophet, hãy tham khảo package <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a>.</span></p>
<div class="sourceCode" id="cb1124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1124-1"><a href="time-series.html#cb1124-1" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1124-2"><a href="time-series.html#cb1124-2" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1124-3"><a href="time-series.html#cb1124-3" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1124-4"><a href="time-series.html#cb1124-4" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1124-5"><a href="time-series.html#cb1124-5" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1124-6"><a href="time-series.html#cb1124-6" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1124-7"><a href="time-series.html#cb1124-7" tabindex="-1"></a>    <span class="do">## use the fourier terms to account for seasonality</span></span>
<span id="cb1124-8"><a href="time-series.html#cb1124-8" tabindex="-1"></a>    fourier)</span>
<span id="cb1124-9"><a href="time-series.html#cb1124-9" tabindex="-1"></a></span>
<span id="cb1124-10"><a href="time-series.html#cb1124-10" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1124-11"><a href="time-series.html#cb1124-11" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1124-12"><a href="time-series.html#cb1124-12" tabindex="-1"></a></span>
<span id="cb1124-13"><a href="time-series.html#cb1124-13" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1124-14"><a href="time-series.html#cb1124-14" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1124-15"><a href="time-series.html#cb1124-15" tabindex="-1"></a></span>
<span id="cb1124-16"><a href="time-series.html#cb1124-16" tabindex="-1"></a>estimate_res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(observed<span class="sc">$</span>result)</span>
<span id="cb1124-17"><a href="time-series.html#cb1124-17" tabindex="-1"></a></span>
<span id="cb1124-18"><a href="time-series.html#cb1124-18" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1124-19"><a href="time-series.html#cb1124-19" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> estimate_res, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1124-20"><a href="time-series.html#cb1124-20" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1124-21"><a href="time-series.html#cb1124-21" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1124-22"><a href="time-series.html#cb1124-22" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;Red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1124-23"><a href="time-series.html#cb1124-23" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1124-24"><a href="time-series.html#cb1124-24" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1124-25"><a href="time-series.html#cb1124-25" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1124-26"><a href="time-series.html#cb1124-26" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1124-27"><a href="time-series.html#cb1124-27" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1124-28"><a href="time-series.html#cb1124-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1124-29"><a href="time-series.html#cb1124-29" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1124-30"><a href="time-series.html#cb1124-30" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1124-31"><a href="time-series.html#cb1124-31" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/nb_reg-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="phần-dư" class="section level3 unnumbered">
<h3>Phần dư</h3>
<p>Để xem mô hình của chúng ta phù hợp với dữ liệu quan sát như thế nào, chúng ta cần xem xét phần dư. Phần dư là sự khác biệt giữa số lượng được quan sát và số lượng được ước tính từ mô hình. Chúng ta có thể tính toán nó một cách đơn giản bằng cách dùng hàm <code>case_int - estimate</code>, nhưng hàm <code>residuals()</code> trích xuất nó trực tiếp từ mô hình hồi quy cho chúng ta.</p>
<p>Những gì chúng ta thấy dưới đây là chúng ta không giải thích tất cả các sự dao động mà chúng ta có thể có với mô hình. Có thể chúng ta cần fit nhiều chu kỳ fourier hơn, và gủau quyết biên độ. Tuy nhiên đối với ví dụ này, chúng ta sẽ để nguyên như vậy. Các biểu đồ cho thấy mô hình của chúng ta hoạt động kém hơn ở các đỉnh và đáy (khi số lượng ở mức cao nhất và thấp nhất) và có nhiều khả năng ước tính không đầy đủ các số lượng quan sát được.</p>
<div class="sourceCode" id="cb1125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1125-1"><a href="time-series.html#cb1125-1" tabindex="-1"></a><span class="do">## calculate the residuals </span></span>
<span id="cb1125-2"><a href="time-series.html#cb1125-2" tabindex="-1"></a>estimate_res <span class="ot">&lt;-</span> estimate_res <span class="sc">%&gt;%</span> </span>
<span id="cb1125-3"><a href="time-series.html#cb1125-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid =</span> fitted_model<span class="sc">$</span>result[[<span class="dv">1</span>]]<span class="sc">$</span>residuals)</span>
<span id="cb1125-4"><a href="time-series.html#cb1125-4" tabindex="-1"></a></span>
<span id="cb1125-5"><a href="time-series.html#cb1125-5" tabindex="-1"></a><span class="do">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span id="cb1125-6"><a href="time-series.html#cb1125-6" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1125-7"><a href="time-series.html#cb1125-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1125-8"><a href="time-series.html#cb1125-8" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1125-9"><a href="time-series.html#cb1125-9" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb1125-10"><a href="time-series.html#cb1125-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;epiweek&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-880-1.png" width="672" /></p>
<div class="sourceCode" id="cb1126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1126-1"><a href="time-series.html#cb1126-1" tabindex="-1"></a><span class="do">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span id="cb1126-2"><a href="time-series.html#cb1126-2" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span> </span>
<span id="cb1126-3"><a href="time-series.html#cb1126-3" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1126-4"><a href="time-series.html#cb1126-4" tabindex="-1"></a>  <span class="fu">ACF</span>(resid, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1126-5"><a href="time-series.html#cb1126-5" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-880-2.png" width="672" /></p>
<div class="sourceCode" id="cb1127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1127-1"><a href="time-series.html#cb1127-1" tabindex="-1"></a><span class="do">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span id="cb1127-2"><a href="time-series.html#cb1127-2" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1127-3"><a href="time-series.html#cb1127-3" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> resid)) <span class="sc">+</span></span>
<span id="cb1127-4"><a href="time-series.html#cb1127-4" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb1127-5"><a href="time-series.html#cb1127-5" tabindex="-1"></a>  <span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb1127-6"><a href="time-series.html#cb1127-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;count&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-880-3.png" width="672" /></p>
<div class="sourceCode" id="cb1128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1128-1"><a href="time-series.html#cb1128-1" tabindex="-1"></a><span class="do">## compare observed counts to their residuals </span></span>
<span id="cb1128-2"><a href="time-series.html#cb1128-2" tabindex="-1"></a>  <span class="do">## should also be no pattern </span></span>
<span id="cb1128-3"><a href="time-series.html#cb1128-3" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1128-4"><a href="time-series.html#cb1128-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1128-5"><a href="time-series.html#cb1128-5" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1128-6"><a href="time-series.html#cb1128-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Fitted&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-880-4.png" width="672" /></p>
<div class="sourceCode" id="cb1129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1129-1"><a href="time-series.html#cb1129-1" tabindex="-1"></a><span class="do">## formally test autocorrelation of the residuals</span></span>
<span id="cb1129-2"><a href="time-series.html#cb1129-2" tabindex="-1"></a><span class="do">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span id="cb1129-3"><a href="time-series.html#cb1129-3" tabindex="-1"></a><span class="do">## test for independence </span></span>
<span id="cb1129-4"><a href="time-series.html#cb1129-4" tabindex="-1"></a><span class="do">## if p value significant then non-random</span></span>
<span id="cb1129-5"><a href="time-series.html#cb1129-5" tabindex="-1"></a><span class="fu">Box.test</span>(estimate_res<span class="sc">$</span>resid, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 336.25, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="mối-quan-hệ-của-hai-chuỗi-thời-gian" class="section level2" number="23.6">
<h2><span class="header-section-number">23.6</span> Mối quan hệ của hai chuỗi thời gian</h2>
<p>Ở đây chúng ta xem xét việc sử dụng dữ liệu thời tiết (đặc biệt là nhiệt độ) để giải thích số lượng trường hợp campylobacter.</p>
<!-- ======================================================= -->
<div id="nối-hai-bộ-dữ-liệu" class="section level3 unnumbered">
<h3>Nối hai bộ dữ liệu</h3>
<p>Bạn có thể nối các tập dữ liệu của mình sử dụng biến tuần. Để biết thêm về nối dữ liệu, xem chương <a href="joining-matching.html#joining-matching">Nối dữ liệu</a>.</p>
<div class="sourceCode" id="cb1131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1131-1"><a href="time-series.html#cb1131-1" tabindex="-1"></a><span class="do">## left join so that we only have the rows already existing in counts</span></span>
<span id="cb1131-2"><a href="time-series.html#cb1131-2" tabindex="-1"></a><span class="do">## drop the date variable from temp_data (otherwise is duplicated)</span></span>
<span id="cb1131-3"><a href="time-series.html#cb1131-3" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">left_join</span>(counts, </span>
<span id="cb1131-4"><a href="time-series.html#cb1131-4" tabindex="-1"></a>                    <span class="fu">select</span>(temp_data, <span class="sc">-</span>date),</span>
<span id="cb1131-5"><a href="time-series.html#cb1131-5" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">&quot;epiweek&quot;</span>)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="phân-tích-mô-tả-1" class="section level3 unnumbered">
<h3>Phân tích mô tả</h3>
<p>Đầu tiên hãy trực quan hóa dữ liệu của bạn để kiểm tra xem có bất kỳ mối tương quan rõ ràng nào không. Biểu đồ dưới đây cho thấy một mối quan hệ rõ ràng về tính mùa vụ của các biến, và nhiệt độ có thể đạt đỉnh vài tuần trước khi các trường hợp xảy ra. Để biết thêm về xoay trục dữ liệu, xem chương <a href="pivoting.html#pivoting">Xoay trục dữ liệu</a>.</p>
<div class="sourceCode" id="cb1132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1132-1"><a href="time-series.html#cb1132-1" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1132-2"><a href="time-series.html#cb1132-2" tabindex="-1"></a>  <span class="do">## keep the variables we are interested </span></span>
<span id="cb1132-3"><a href="time-series.html#cb1132-3" tabindex="-1"></a>  <span class="fu">select</span>(epiweek, case_int, t2m) <span class="sc">%&gt;%</span> </span>
<span id="cb1132-4"><a href="time-series.html#cb1132-4" tabindex="-1"></a>  <span class="do">## change your data in to long format</span></span>
<span id="cb1132-5"><a href="time-series.html#cb1132-5" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb1132-6"><a href="time-series.html#cb1132-6" tabindex="-1"></a>    <span class="do">## use epiweek as your key</span></span>
<span id="cb1132-7"><a href="time-series.html#cb1132-7" tabindex="-1"></a>    <span class="sc">!</span>epiweek,</span>
<span id="cb1132-8"><a href="time-series.html#cb1132-8" tabindex="-1"></a>    <span class="do">## move column names to the new &quot;measure&quot; column</span></span>
<span id="cb1132-9"><a href="time-series.html#cb1132-9" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;measure&quot;</span>, </span>
<span id="cb1132-10"><a href="time-series.html#cb1132-10" tabindex="-1"></a>    <span class="do">## move cell values to the new &quot;values&quot; column</span></span>
<span id="cb1132-11"><a href="time-series.html#cb1132-11" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1132-12"><a href="time-series.html#cb1132-12" tabindex="-1"></a>  <span class="do">## create a plot with the dataset above</span></span>
<span id="cb1132-13"><a href="time-series.html#cb1132-13" tabindex="-1"></a>  <span class="do">## plot epiweek on the x axis and values (counts/celsius) on the y </span></span>
<span id="cb1132-14"><a href="time-series.html#cb1132-14" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb1132-15"><a href="time-series.html#cb1132-15" tabindex="-1"></a>    <span class="do">## create a separate plot for temperate and case counts </span></span>
<span id="cb1132-16"><a href="time-series.html#cb1132-16" tabindex="-1"></a>    <span class="do">## let them set their own y-axes</span></span>
<span id="cb1132-17"><a href="time-series.html#cb1132-17" tabindex="-1"></a>    <span class="fu">facet_grid</span>(measure <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb1132-18"><a href="time-series.html#cb1132-18" tabindex="-1"></a>    <span class="do">## plot both as a line</span></span>
<span id="cb1132-19"><a href="time-series.html#cb1132-19" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="lags-và-tương-quan-chéo" class="section level3 unnumbered">
<h3>Lags và tương quan chéo</h3>
<p>Để kiểm định xem những tuần nào có tương quan nhiều nhất tới các trường hợp và nhiệt độ, bạn có thể sử dụng hàm tương quan chéo (<code>CCF()</code>) từ package <strong>feasts</strong>. Bạn cũng có thể trực quan hóa (hơn là sử dụng <code>arrange</code>) sử dụng hàm <code>autoplot()</code>.</p>
<div class="sourceCode" id="cb1133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1133-1"><a href="time-series.html#cb1133-1" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1133-2"><a href="time-series.html#cb1133-2" tabindex="-1"></a>  <span class="do">## calculate cross-correlation between interpolated counts and temperature</span></span>
<span id="cb1133-3"><a href="time-series.html#cb1133-3" tabindex="-1"></a>  <span class="fu">CCF</span>(case_int, t2m,</span>
<span id="cb1133-4"><a href="time-series.html#cb1133-4" tabindex="-1"></a>      <span class="do">## set the maximum lag to be 52 weeks</span></span>
<span id="cb1133-5"><a href="time-series.html#cb1133-5" tabindex="-1"></a>      <span class="at">lag_max =</span> <span class="dv">52</span>, </span>
<span id="cb1133-6"><a href="time-series.html#cb1133-6" tabindex="-1"></a>      <span class="do">## return the correlation coefficient </span></span>
<span id="cb1133-7"><a href="time-series.html#cb1133-7" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">&quot;correlation&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1133-8"><a href="time-series.html#cb1133-8" tabindex="-1"></a>  <span class="do">## arange in decending order of the correlation coefficient </span></span>
<span id="cb1133-9"><a href="time-series.html#cb1133-9" tabindex="-1"></a>  <span class="do">## show the most associated lags</span></span>
<span id="cb1133-10"><a href="time-series.html#cb1133-10" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> </span>
<span id="cb1133-11"><a href="time-series.html#cb1133-11" tabindex="-1"></a>  <span class="do">## only show the top ten </span></span>
<span id="cb1133-12"><a href="time-series.html#cb1133-12" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##         lag   ccf
##    &lt;cf_lag&gt; &lt;dbl&gt;
##  1      -4W 0.749
##  2      -5W 0.745
##  3      -3W 0.735
##  4      -6W 0.729
##  5      -2W 0.727
##  6      -7W 0.704
##  7      -1W 0.695
##  8      -8W 0.671
##  9       0W 0.649
## 10      47W 0.638</code></pre>
<p>Chúng ta thấy rằng độ trễ 4 tuần có mối tương quan cao nhất, vì vậy chúng ta tạo một biến nhiệt độ trễ để đưa vào mô hình hồi quy.</p>
<p><span style="color: red;"><strong><em>NGUY HIỂM:</em></strong> Lưu ý rằng bốn tuần đầu tiên dữ liệu của chúng ta trong biến nhiệt độ trễ bị thiếu (<code>NA</code>) - bởi vì không có bốn tuần trước đó để lấy dữ liệu. Để sử dụng bộ dữ liệu này với hàm <strong>trending</strong> <code>predict()</code>, chúng ta cần phải sử dụng đối số <code>simulate_pi = FALSE</code> bên trong hàm <code>predict()</code>. Nếu chúng ta muốn sử dụng tùy chọn mô phỏng, thì chúng ta phải loại bỏ các giá trị missings và lưu thành một bộ dữ liệu mới bằng cách thêm hàm <code>drop_na(t2m_lag4)</code> vào đoạn code dưới đây.</span></p>
<div class="sourceCode" id="cb1135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1135-1"><a href="time-series.html#cb1135-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1135-2"><a href="time-series.html#cb1135-2" tabindex="-1"></a>  <span class="do">## create a new variable for temperature lagged by four weeks</span></span>
<span id="cb1135-3"><a href="time-series.html#cb1135-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t2m_lag4 =</span> <span class="fu">lag</span>(t2m, <span class="at">n =</span> <span class="dv">4</span>))</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="hồi-quy-nhị-thức-âm-với-hai-biến-số" class="section level3 unnumbered">
<h3>Hồi quy nhị thức âm với hai biến số</h3>
<p>Chúng ta sẽ fit một mô hình hồi quy nhị thức âm như đã thực hiện trước đó. Lần này chúng ta thêm biến nhiệt độ có độ trễ là bốn tuần.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code>predict()</code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code>?trending::predict.trending_model_fit</code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1136-1"><a href="time-series.html#cb1136-1" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1136-2"><a href="time-series.html#cb1136-2" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1136-3"><a href="time-series.html#cb1136-3" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1136-4"><a href="time-series.html#cb1136-4" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1136-5"><a href="time-series.html#cb1136-5" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1136-6"><a href="time-series.html#cb1136-6" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1136-7"><a href="time-series.html#cb1136-7" tabindex="-1"></a>    <span class="do">## use the fourier terms to account for seasonality</span></span>
<span id="cb1136-8"><a href="time-series.html#cb1136-8" tabindex="-1"></a>    fourier <span class="sc">+</span> </span>
<span id="cb1136-9"><a href="time-series.html#cb1136-9" tabindex="-1"></a>    <span class="do">## use the temperature lagged by four weeks </span></span>
<span id="cb1136-10"><a href="time-series.html#cb1136-10" tabindex="-1"></a>    t2m_lag4</span>
<span id="cb1136-11"><a href="time-series.html#cb1136-11" tabindex="-1"></a>    )</span>
<span id="cb1136-12"><a href="time-series.html#cb1136-12" tabindex="-1"></a></span>
<span id="cb1136-13"><a href="time-series.html#cb1136-13" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1136-14"><a href="time-series.html#cb1136-14" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1136-15"><a href="time-series.html#cb1136-15" tabindex="-1"></a></span>
<span id="cb1136-16"><a href="time-series.html#cb1136-16" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1136-17"><a href="time-series.html#cb1136-17" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Để khảo sát các chu kỳ đơn lẻ, chúng ta có thể lấy mô hình hồi quy nhị thức âm gốc ra khỏi định dạng <strong>trending</strong> bằng cách sử dụng hàm <code>get_model()</code> và chuyển nó tới hàm <code>tidy()</code> của package <strong>broom</strong> để truy xuất các ước tính được lũy thừa hóa và các khoảng tin cậy.</p>
<p>Điều này cho chúng ta thấy là nhiệt độ trễ, sau khi kiểm soát xu hướng và tính theo mùa, tương tự như số lượng trường hợp (ước tính ~ 1) và sự liên quan có ý nghĩa. Điều này cho thấy rằng nó có thể là một biến số tốt để sử dụng trong việc dự báo các ca bệnh trong tương lai (các dữ liệu dự báo khí hậu luôn có sẵn).</p>
<div class="sourceCode" id="cb1137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1137-1"><a href="time-series.html#cb1137-1" tabindex="-1"></a>fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1137-2"><a href="time-series.html#cb1137-2" tabindex="-1"></a>  <span class="do">## extract original negative binomial regression</span></span>
<span id="cb1137-3"><a href="time-series.html#cb1137-3" tabindex="-1"></a>  <span class="fu">get_fitted_model</span>()</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:  glm.nb(formula = case_int ~ epiweek + fourier + t2m_lag4, data = counts, 
##     init.theta = 32.80689607, link = log)
## 
## Coefficients:
##  (Intercept)       epiweek  fourierS1-52  fourierC1-52      t2m_lag4  
##   5.82535083    0.00008464   -0.28502594   -0.19537827    0.00667157  
## 
## Degrees of Freedom: 504 Total (i.e. Null);  500 Residual
##   (4 observations deleted due to missingness)
## Null Deviance:       2015 
## Residual Deviance: 508.2     AIC: 6784</code></pre>
<div class="sourceCode" id="cb1139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1139-1"><a href="time-series.html#cb1139-1" tabindex="-1"></a>  <span class="do">## get a tidy dataframe of results</span></span>
<span id="cb1139-2"><a href="time-series.html#cb1139-2" tabindex="-1"></a>  <span class="co">#tidy(exponentiate = TRUE, </span></span>
<span id="cb1139-3"><a href="time-series.html#cb1139-3" tabindex="-1"></a>  <span class="co">#     conf.int = TRUE)</span></span></code></pre></div>
<p>Đánh giá nhanh mô hình cho thấy nó có thể thực hiện tốt hơn công việc ước tính số ca bệnh quan sát được.</p>
<div class="sourceCode" id="cb1140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1140-1"><a href="time-series.html#cb1140-1" tabindex="-1"></a>estimate_res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(observed<span class="sc">$</span>result)</span>
<span id="cb1140-2"><a href="time-series.html#cb1140-2" tabindex="-1"></a></span>
<span id="cb1140-3"><a href="time-series.html#cb1140-3" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1140-4"><a href="time-series.html#cb1140-4" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> estimate_res, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1140-5"><a href="time-series.html#cb1140-5" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1140-6"><a href="time-series.html#cb1140-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1140-7"><a href="time-series.html#cb1140-7" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;Red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1140-8"><a href="time-series.html#cb1140-8" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1140-9"><a href="time-series.html#cb1140-9" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1140-10"><a href="time-series.html#cb1140-10" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1140-11"><a href="time-series.html#cb1140-11" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1140-12"><a href="time-series.html#cb1140-12" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1140-13"><a href="time-series.html#cb1140-13" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1140-14"><a href="time-series.html#cb1140-14" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1140-15"><a href="time-series.html#cb1140-15" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1140-16"><a href="time-series.html#cb1140-16" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672" /></p>
<div id="phần-dư-1" class="section level4 unnumbered">
<h4>Phần dư</h4>
<p>Chúng ta một lần nữa lại khảo sát phần dư để xem mô hình của chúng ta phù hợp với dữ liệu quan sát như thế nào. Các kết quả và phiên giải ở đây tương tự như kết quả của hồi quy trước đó, vì vậy sẽ khả thi hơn khi chọn mô hình đơn giản hơn mà không có nhiệt độ.</p>
<div class="sourceCode" id="cb1141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1141-1"><a href="time-series.html#cb1141-1" tabindex="-1"></a><span class="do">## calculate the residuals </span></span>
<span id="cb1141-2"><a href="time-series.html#cb1141-2" tabindex="-1"></a>estimate_res <span class="ot">&lt;-</span> estimate_res <span class="sc">%&gt;%</span> </span>
<span id="cb1141-3"><a href="time-series.html#cb1141-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid =</span> case_int <span class="sc">-</span> estimate)</span>
<span id="cb1141-4"><a href="time-series.html#cb1141-4" tabindex="-1"></a></span>
<span id="cb1141-5"><a href="time-series.html#cb1141-5" tabindex="-1"></a><span class="do">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span id="cb1141-6"><a href="time-series.html#cb1141-6" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1141-7"><a href="time-series.html#cb1141-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1141-8"><a href="time-series.html#cb1141-8" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1141-9"><a href="time-series.html#cb1141-9" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb1141-10"><a href="time-series.html#cb1141-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;epiweek&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-881-1.png" width="672" /></p>
<div class="sourceCode" id="cb1142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1142-1"><a href="time-series.html#cb1142-1" tabindex="-1"></a><span class="do">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span id="cb1142-2"><a href="time-series.html#cb1142-2" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span> </span>
<span id="cb1142-3"><a href="time-series.html#cb1142-3" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1142-4"><a href="time-series.html#cb1142-4" tabindex="-1"></a>  <span class="fu">ACF</span>(resid, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1142-5"><a href="time-series.html#cb1142-5" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-881-2.png" width="672" /></p>
<div class="sourceCode" id="cb1143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1143-1"><a href="time-series.html#cb1143-1" tabindex="-1"></a><span class="do">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span id="cb1143-2"><a href="time-series.html#cb1143-2" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1143-3"><a href="time-series.html#cb1143-3" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> resid)) <span class="sc">+</span></span>
<span id="cb1143-4"><a href="time-series.html#cb1143-4" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb1143-5"><a href="time-series.html#cb1143-5" tabindex="-1"></a>  <span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb1143-6"><a href="time-series.html#cb1143-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;count&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-881-3.png" width="672" /></p>
<div class="sourceCode" id="cb1144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1144-1"><a href="time-series.html#cb1144-1" tabindex="-1"></a><span class="do">## compare observed counts to their residuals </span></span>
<span id="cb1144-2"><a href="time-series.html#cb1144-2" tabindex="-1"></a>  <span class="do">## should also be no pattern </span></span>
<span id="cb1144-3"><a href="time-series.html#cb1144-3" tabindex="-1"></a>estimate_res <span class="sc">%&gt;%</span></span>
<span id="cb1144-4"><a href="time-series.html#cb1144-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1144-5"><a href="time-series.html#cb1144-5" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1144-6"><a href="time-series.html#cb1144-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Fitted&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-881-4.png" width="672" /></p>
<div class="sourceCode" id="cb1145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1145-1"><a href="time-series.html#cb1145-1" tabindex="-1"></a><span class="do">## formally test autocorrelation of the residuals</span></span>
<span id="cb1145-2"><a href="time-series.html#cb1145-2" tabindex="-1"></a><span class="do">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span id="cb1145-3"><a href="time-series.html#cb1145-3" tabindex="-1"></a><span class="do">## test for independence </span></span>
<span id="cb1145-4"><a href="time-series.html#cb1145-4" tabindex="-1"></a><span class="do">## if p value significant then non-random</span></span>
<span id="cb1145-5"><a href="time-series.html#cb1145-5" tabindex="-1"></a><span class="fu">Box.test</span>(estimate_res<span class="sc">$</span>resid, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="phát-hiện-ổ-dịch" class="section level2" number="23.7">
<h2><span class="header-section-number">23.7</span> Phát hiện ổ dịch</h2>
<p>Chúng tôi sẽ trình bày hai phương pháp (tương tự) để phát hiện các ổ dịch ở đây. Cách đầu tiên được xây dựng dựa vào phần bên trên. Chúng ta sử dụng package <strong>trending</strong> để fit các mô hình hồi quy cho các năm trước đó, sau đó dự báo cho các năm tiếp theo. Nếu số lượng quan sát được cao hơn những gì chúng tôi dự báo, thì khả năng là đã có một đợt bùng phát. Phương pháp thứ hai dựa trên nguyên tắc tương tự nhưng sử dụng package <strong>surveillance</strong>, cung cấp nhiều thuật toán khác nhau để phát hiện các thay đổi bất thường.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Thông thường, bạn quan tâm đến năm hiện tại (do bạn chỉ biết số ca bệnh đến tuần hiện tại). Vì vậy, trong ví dụ này, chúng tôi đang giả định là tuần 39 của năm 2011.</span></p>
<!-- ======================================================= -->
<div id="package-trending" class="section level3 unnumbered">
<h3>Package <strong>trending</strong></h3>
<p>Đối với phương pháp này, chúng ta xác định một mốc (baseline) (thường là khoảng 5 năm dữ liệu). Chúng ta fit một mô hình hồi quy tới dữ liệu baseline, và sau đó sử dụng nó để ước tính cho năm sau.</p>
<!-- ======================================================= -->
<div id="điểm-cắt-ngày" class="section level4 unnumbered">
<h4>Điểm cắt ngày</h4>
<p>Sẽ dễ dàng hơn khi xác định ngày của bạn ở một nơi và sau đó sử dụng những ngày này trong suốt phần còn lại trong của bạn.</p>
<p>Ở đây chúng ta xác định ngày bắt đầu (khi các quan sát của chúng ta bắt đầu) và ngày làm điểm cắt (cut-off date) (kết thúc giai đoạn baseline - và giai đoạn chúng ta muốn dự đoán cho sự bắt đầu). ~Chúng ta cũng xác định có bao nhiêu tuần trong năm mà chúng tôi sẽ dự đoán)~. Chúng ta cũng xác định có bao nhiêu tuần mà chúng ta đang muốn dự báo nằm giữa điểm cắt baseline và ngày kết thúc.</p>
<p><span style="color: black;"><strong><em>LƯU Ý:</em></strong> Trong ví dụ này, chúng tôi giả sử hiện đang ở cuối tháng 9 năm 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb1147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1147-1"><a href="time-series.html#cb1147-1" tabindex="-1"></a><span class="do">## define start date (when observations began)</span></span>
<span id="cb1147-2"><a href="time-series.html#cb1147-2" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">min</span>(counts<span class="sc">$</span>epiweek)</span>
<span id="cb1147-3"><a href="time-series.html#cb1147-3" tabindex="-1"></a></span>
<span id="cb1147-4"><a href="time-series.html#cb1147-4" tabindex="-1"></a><span class="do">## define a cut-off week (end of baseline, start of prediction period)</span></span>
<span id="cb1147-5"><a href="time-series.html#cb1147-5" tabindex="-1"></a>cut_off <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2010-12-31&quot;</span>)</span>
<span id="cb1147-6"><a href="time-series.html#cb1147-6" tabindex="-1"></a></span>
<span id="cb1147-7"><a href="time-series.html#cb1147-7" tabindex="-1"></a><span class="do">## define the last date interested in (i.e. end of prediction)</span></span>
<span id="cb1147-8"><a href="time-series.html#cb1147-8" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2011-12-31&quot;</span>)</span>
<span id="cb1147-9"><a href="time-series.html#cb1147-9" tabindex="-1"></a></span>
<span id="cb1147-10"><a href="time-series.html#cb1147-10" tabindex="-1"></a><span class="do">## find how many weeks in period (year) of interest</span></span>
<span id="cb1147-11"><a href="time-series.html#cb1147-11" tabindex="-1"></a>num_weeks <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(end_date <span class="sc">-</span> cut_off)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="thêm-hàng-1" class="section level4 unnumbered">
<h4>Thêm hàng</h4>
<p>Để có thể dự báo ở định dạng tidyverse, chúng ta cần có số hàng phù hợp trong tập dữ liệu của mình, tức là một hàng cho mỗi tuần cho tới ngày kết thúc <code>end_date</code> đã được xác định bên trên. Đoạn mã bên dưới cho phép bạn thêm các hàng này theo một biến nhóm - ví dụ: nếu chúng ta có nhiều quốc gia trong một tập dữ liệu, chúng ta có thể nhóm theo quốc gia và sau đó thêm các hàng một cách thích hợp cho từng quốc gia. Hàm <code>group_by_key()</code> trong package <strong>tsibble</strong> cho phép chúng ta thực hiện điều này và sau đó chuyển dữ liệu đã nhóm tới các hàm <strong>dplyr</strong> như <code>group_modify()</code> và <code>add_row()</code>. Sau đó, chúng ta cụ thể trình tự các tuần giữa một tuần sau tuần tối đa hiện có trong dữ liệu và tuần kết thúc.</p>
<div class="sourceCode" id="cb1148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1148-1"><a href="time-series.html#cb1148-1" tabindex="-1"></a><span class="do">## add in missing weeks till end of year </span></span>
<span id="cb1148-2"><a href="time-series.html#cb1148-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span></span>
<span id="cb1148-3"><a href="time-series.html#cb1148-3" tabindex="-1"></a>  <span class="do">## group by the region</span></span>
<span id="cb1148-4"><a href="time-series.html#cb1148-4" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1148-5"><a href="time-series.html#cb1148-5" tabindex="-1"></a>  <span class="do">## for each group add rows from the highest epiweek to the end of year</span></span>
<span id="cb1148-6"><a href="time-series.html#cb1148-6" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">add_row</span>(.,</span>
<span id="cb1148-7"><a href="time-series.html#cb1148-7" tabindex="-1"></a>                        <span class="at">epiweek =</span> <span class="fu">seq</span>(<span class="fu">max</span>(.<span class="sc">$</span>epiweek) <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb1148-8"><a href="time-series.html#cb1148-8" tabindex="-1"></a>                                      end_date,</span>
<span id="cb1148-9"><a href="time-series.html#cb1148-9" tabindex="-1"></a>                                      <span class="at">by =</span> <span class="dv">1</span>)))</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="chu-kỳ-fourier-1" class="section level4 unnumbered">
<h4>Chu kỳ Fourier</h4>
<p>Chúng ta phải định nghĩa lại chu kỳ Fourier - bởi vì chúng ta chỉ muốn fit chúng tới ngày baseline và sau đó dự báo (ngoại suy) các chu kỳ này cho năm sau. Để làm điều này, chúng ta cần kết hợp hai danh sách đầu ra từ hàm <code>fourier()</code> lại với nhau; cái đầu tiên dành cho dữ liệu baseline, và cái thứ hai dự đoán cho năm quan tâm (bằng cách xác định đối số <code>h</code>).</p>
<p><em>Lưu ý</em> để nối dòng chúng ta phải sử dụng hàm <code>rbind()</code> (thay vì hàm tidyverse <code>bind_rows</code>) bởi vì các cột fourier ở định dạng danh sách (vì vậy không được đặt tên riêng lẻ).</p>
<div class="sourceCode" id="cb1149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1149-1"><a href="time-series.html#cb1149-1" tabindex="-1"></a><span class="do">## define fourier terms (sincos) </span></span>
<span id="cb1149-2"><a href="time-series.html#cb1149-2" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1149-3"><a href="time-series.html#cb1149-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1149-4"><a href="time-series.html#cb1149-4" tabindex="-1"></a>    <span class="do">## combine fourier terms for weeks prior to  and after 2010 cut-off date</span></span>
<span id="cb1149-5"><a href="time-series.html#cb1149-5" tabindex="-1"></a>    <span class="do">## (nb. 2011 fourier terms are predicted)</span></span>
<span id="cb1149-6"><a href="time-series.html#cb1149-6" tabindex="-1"></a>    <span class="at">fourier =</span> <span class="fu">rbind</span>(</span>
<span id="cb1149-7"><a href="time-series.html#cb1149-7" tabindex="-1"></a>      <span class="do">## get fourier terms for previous years</span></span>
<span id="cb1149-8"><a href="time-series.html#cb1149-8" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1149-9"><a href="time-series.html#cb1149-9" tabindex="-1"></a>        <span class="do">## only keep the rows before 2011</span></span>
<span id="cb1149-10"><a href="time-series.html#cb1149-10" tabindex="-1"></a>        <span class="fu">filter</span>(counts, </span>
<span id="cb1149-11"><a href="time-series.html#cb1149-11" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cut_off), </span>
<span id="cb1149-12"><a href="time-series.html#cb1149-12" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1149-13"><a href="time-series.html#cb1149-13" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span></span>
<span id="cb1149-14"><a href="time-series.html#cb1149-14" tabindex="-1"></a>        ), </span>
<span id="cb1149-15"><a href="time-series.html#cb1149-15" tabindex="-1"></a>      <span class="do">## predict the fourier terms for 2011 (using baseline data)</span></span>
<span id="cb1149-16"><a href="time-series.html#cb1149-16" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1149-17"><a href="time-series.html#cb1149-17" tabindex="-1"></a>        <span class="do">## only keep the rows before 2011</span></span>
<span id="cb1149-18"><a href="time-series.html#cb1149-18" tabindex="-1"></a>        <span class="fu">filter</span>(counts, </span>
<span id="cb1149-19"><a href="time-series.html#cb1149-19" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cut_off),</span>
<span id="cb1149-20"><a href="time-series.html#cb1149-20" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1149-21"><a href="time-series.html#cb1149-21" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span>, </span>
<span id="cb1149-22"><a href="time-series.html#cb1149-22" tabindex="-1"></a>        <span class="do">## predict 52 weeks ahead</span></span>
<span id="cb1149-23"><a href="time-series.html#cb1149-23" tabindex="-1"></a>        <span class="at">h =</span> num_weeks</span>
<span id="cb1149-24"><a href="time-series.html#cb1149-24" tabindex="-1"></a>        )</span>
<span id="cb1149-25"><a href="time-series.html#cb1149-25" tabindex="-1"></a>      )</span>
<span id="cb1149-26"><a href="time-series.html#cb1149-26" tabindex="-1"></a>    )</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="chia-dữ-liệu-và-fit-mô-hình-hồi-quy" class="section level4 unnumbered">
<h4>Chia dữ liệu và fit mô hình hồi quy</h4>
<p>Chúng ta bây giờ cần phải chia dữ liệu của mình thành 2 giai đoạn: giai đoạn baseline và giai đoạn dự báo. Nó có thể thực hiện được với hàm <strong>dplyr</strong> <code>group_split()</code> sau khi nhóm bởi <code>group_by()</code>, và sẽ tạo ra một danh sách gồm hai data frame, một trước thời điểm cut-off và một cái ở thời điểm sau cut-off.</p>
<p>Chúng ta sau đó sử dụng hàm <code>pluck()</code> từ package <strong>purrr</strong> để kéo tập dữ liệu ra khỏi danh sách (tương đương với việc sử dụng ngoặc vuông, vd: <code>dat[[1]]</code>), và sau đó có thể fit mô hình của chúng ta tới dữ liệu nền,và sau đó sử dụng hàm <code>predict()</code> cho dữ liệu mà chúng ta quan tâm sau cut-off.</p>
<p>Xem chương <a href="iteration.html#iteration">Lặp, vòng lặp, và danh sách</a> để biết thêm về <strong>purrr</strong>.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code>predict()</code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code>?trending::predict.trending_model_fit</code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1150-1"><a href="time-series.html#cb1150-1" tabindex="-1"></a><span class="co"># split data for fitting and prediction</span></span>
<span id="cb1150-2"><a href="time-series.html#cb1150-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1150-3"><a href="time-series.html#cb1150-3" tabindex="-1"></a>  <span class="fu">group_by</span>(epiweek <span class="sc">&lt;=</span> cut_off) <span class="sc">%&gt;%</span></span>
<span id="cb1150-4"><a href="time-series.html#cb1150-4" tabindex="-1"></a>  <span class="fu">group_split</span>()</span>
<span id="cb1150-5"><a href="time-series.html#cb1150-5" tabindex="-1"></a></span>
<span id="cb1150-6"><a href="time-series.html#cb1150-6" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1150-7"><a href="time-series.html#cb1150-7" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1150-8"><a href="time-series.html#cb1150-8" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1150-9"><a href="time-series.html#cb1150-9" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1150-10"><a href="time-series.html#cb1150-10" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1150-11"><a href="time-series.html#cb1150-11" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1150-12"><a href="time-series.html#cb1150-12" tabindex="-1"></a>    <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1150-13"><a href="time-series.html#cb1150-13" tabindex="-1"></a>    fourier</span>
<span id="cb1150-14"><a href="time-series.html#cb1150-14" tabindex="-1"></a>)</span>
<span id="cb1150-15"><a href="time-series.html#cb1150-15" tabindex="-1"></a></span>
<span id="cb1150-16"><a href="time-series.html#cb1150-16" tabindex="-1"></a><span class="co"># define which data to use for fitting and which for predicting</span></span>
<span id="cb1150-17"><a href="time-series.html#cb1150-17" tabindex="-1"></a>fitting_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">2</span>)</span>
<span id="cb1150-18"><a href="time-series.html#cb1150-18" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-19"><a href="time-series.html#cb1150-19" tabindex="-1"></a>  <span class="fu">select</span>(case_int, epiweek, fourier)</span>
<span id="cb1150-20"><a href="time-series.html#cb1150-20" tabindex="-1"></a></span>
<span id="cb1150-21"><a href="time-series.html#cb1150-21" tabindex="-1"></a><span class="co"># fit model </span></span>
<span id="cb1150-22"><a href="time-series.html#cb1150-22" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, fitting_data)</span>
<span id="cb1150-23"><a href="time-series.html#cb1150-23" tabindex="-1"></a></span>
<span id="cb1150-24"><a href="time-series.html#cb1150-24" tabindex="-1"></a><span class="co"># get confint and estimates for fitted data</span></span>
<span id="cb1150-25"><a href="time-series.html#cb1150-25" tabindex="-1"></a>observed <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1150-26"><a href="time-series.html#cb1150-26" tabindex="-1"></a>  <span class="fu">predict</span>(<span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1150-27"><a href="time-series.html#cb1150-27" tabindex="-1"></a></span>
<span id="cb1150-28"><a href="time-series.html#cb1150-28" tabindex="-1"></a><span class="co"># forecast with data want to predict with </span></span>
<span id="cb1150-29"><a href="time-series.html#cb1150-29" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1150-30"><a href="time-series.html#cb1150-30" tabindex="-1"></a>  <span class="fu">predict</span>(pred_data, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1150-31"><a href="time-series.html#cb1150-31" tabindex="-1"></a></span>
<span id="cb1150-32"><a href="time-series.html#cb1150-32" tabindex="-1"></a><span class="do">## combine baseline and predicted datasets</span></span>
<span id="cb1150-33"><a href="time-series.html#cb1150-33" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(observed<span class="sc">$</span>result, forecasts<span class="sc">$</span>result)</span></code></pre></div>
<p>Như bên trên, chúng ta có thể trực quan hóa mô hình với <strong>ggplot</strong>. Chúng ta đánh dấu các cảnh báo bằng các chấm màu đỏ cho các trường hợp quan sát được phía trên 95% khoảng dự đoán. Lần này, chúng ta cũng thêm một đường dọc để dán nhãn khi dự báo bắt đầu.</p>
<div class="sourceCode" id="cb1151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1151-1"><a href="time-series.html#cb1151-1" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1151-2"><a href="time-series.html#cb1151-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> observed, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1151-3"><a href="time-series.html#cb1151-3" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1151-4"><a href="time-series.html#cb1151-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1151-5"><a href="time-series.html#cb1151-5" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1151-6"><a href="time-series.html#cb1151-6" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1151-7"><a href="time-series.html#cb1151-7" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1151-8"><a href="time-series.html#cb1151-8" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1151-9"><a href="time-series.html#cb1151-9" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1151-10"><a href="time-series.html#cb1151-10" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1151-11"><a href="time-series.html#cb1151-11" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1151-12"><a href="time-series.html#cb1151-12" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1151-13"><a href="time-series.html#cb1151-13" tabindex="-1"></a>  <span class="do">## plot in points for the observed counts above expected</span></span>
<span id="cb1151-14"><a href="time-series.html#cb1151-14" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb1151-15"><a href="time-series.html#cb1151-15" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(observed, case_int <span class="sc">&gt;</span> upper_pi), </span>
<span id="cb1151-16"><a href="time-series.html#cb1151-16" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1151-17"><a href="time-series.html#cb1151-17" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, </span>
<span id="cb1151-18"><a href="time-series.html#cb1151-18" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb1151-19"><a href="time-series.html#cb1151-19" tabindex="-1"></a>  <span class="do">## add vertical line and label to show where forecasting started</span></span>
<span id="cb1151-20"><a href="time-series.html#cb1151-20" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb1151-21"><a href="time-series.html#cb1151-21" tabindex="-1"></a>           <span class="at">xintercept =</span> <span class="fu">as.Date</span>(cut_off), </span>
<span id="cb1151-22"><a href="time-series.html#cb1151-22" tabindex="-1"></a>           <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1151-23"><a href="time-series.html#cb1151-23" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, </span>
<span id="cb1151-24"><a href="time-series.html#cb1151-24" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">&quot;Forecast&quot;</span>, </span>
<span id="cb1151-25"><a href="time-series.html#cb1151-25" tabindex="-1"></a>           <span class="at">x =</span> cut_off, </span>
<span id="cb1151-26"><a href="time-series.html#cb1151-26" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">max</span>(observed<span class="sc">$</span>upper_pi) <span class="sc">-</span> <span class="dv">250</span>, </span>
<span id="cb1151-27"><a href="time-series.html#cb1151-27" tabindex="-1"></a>           <span class="at">angle =</span> <span class="dv">90</span>, </span>
<span id="cb1151-28"><a href="time-series.html#cb1151-28" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb1151-29"><a href="time-series.html#cb1151-29" tabindex="-1"></a>           ) <span class="sc">+</span> </span>
<span id="cb1151-30"><a href="time-series.html#cb1151-30" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1151-31"><a href="time-series.html#cb1151-31" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (`geom_line()`).</code></pre>
<p><img src="_main_files/figure-html/forecast_plot-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="đánh-giá-dự-báo" class="section level4 unnumbered">
<h4>Đánh giá dự báo</h4>
<p>Ngoài việc kiểm tra các phần dư, cũng quan trọng khi đánh giá xem mô hình của bạn tốt như thế nào trong việc dự đoán các trường hợp trong tương lai. Điều này cung cấp cho bạn ý tưởng về mức độ đáng tin cậy của các ngưỡng cảnh báo của bạn.</p>
<p>Cách kiểm định truyền thống là xem bạn có thể dự đoán năm gần nhất trước năm hiện tại tốt như thế nào (bởi vì bạn chưa biết số lượng cho “năm hiện tại”). Ví dụ: trong tập dữ liệu của chúng ta, chúng ta sẽ sử dụng dữ liệu từ năm 2002 đến năm 2009 để dự đoán năm 2010 và sau đó xem mức độ chính xác của những dự đoán đó. Sau đó, fit lại mô hình có bao gồm dữ liệu năm 2010 và sử dụng dữ liệu đó để dự đoán cho năm 2011.</p>
<p>Bạn có thể xem ảnh minh họa bên dưới bởi <em>Hyndman và cộng sự</em> trong cuốn <a href="https://otexts.com/fpp3/">“Các nguyên tắc dự báo và thực hành”</a>.</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png" /> <em>hình sử dụng lại với sự cho phép của các tác giả</em></p>
<p>Nhược điểm của cách này là bạn không sử dụng tất cả dữ liệu có sẵn và nó không phải là mô hình cuối cùng mà bạn đang sử dụng để dự đoán.</p>
<p>Một giải pháp thay thế là sử dụng một phương pháp được gọi là xác thực chéo (cross-validation). Trong trường hợp này, bạn cuộn qua tất cả dữ liệu có sẵn để fit nhiều mô hình để dự đoán một năm tới. Bạn sẽ sử dụng nhiều dữ liệu hơn trong các mô hình, như được trình bày dưới đây từ cùng <a href="https://otexts.com/fpp3/"><em>cuốn sách của Hyndman và cộng sự</em></a>. Ví dụ, mô hình đầu tiên sử dụng 2002 để dự đoán năm 2003, mô hình thứ hai sử dụng 2002 và 2003 để dự đoán năm 2004, v.v.</p>
<p><img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png" /> <em>hình sử dụng lại với sự cho phép của các tác giả</em></p>
<p>Dưới đây chúng ta sử dụng hàm <code>map()</code> từ package <strong>purrr</strong> để chạy vòng lặp trên từng tập dữ liệu. Sau đó, chúng ta đặt các ước tính vào một tập dữ liệu và hợp nhất với số lượng trường hợp ban đầu để sử dụng package <strong>yardstick</strong> để tính toán các đo lường về độ chính xác. Chúng ta sẽ tính toán bốn giá trị bao gồm: Root mean squared error (RMSE), Mean absolute error (MAE), Mean absolute scaled error (MASE), Mean absolute percent error (MAPE).</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code>predict()</code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code>?trending::predict.trending_model_fit</code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1153-1"><a href="time-series.html#cb1153-1" tabindex="-1"></a><span class="do">## Cross validation: predicting week(s) ahead based on sliding window</span></span>
<span id="cb1153-2"><a href="time-series.html#cb1153-2" tabindex="-1"></a></span>
<span id="cb1153-3"><a href="time-series.html#cb1153-3" tabindex="-1"></a><span class="do">## expand your data by rolling over in 52 week windows (before + after) </span></span>
<span id="cb1153-4"><a href="time-series.html#cb1153-4" tabindex="-1"></a><span class="do">## to predict 52 week ahead</span></span>
<span id="cb1153-5"><a href="time-series.html#cb1153-5" tabindex="-1"></a><span class="do">## (creates longer and longer chains of observations - keeps older data)</span></span>
<span id="cb1153-6"><a href="time-series.html#cb1153-6" tabindex="-1"></a></span>
<span id="cb1153-7"><a href="time-series.html#cb1153-7" tabindex="-1"></a><span class="do">## define window want to roll over</span></span>
<span id="cb1153-8"><a href="time-series.html#cb1153-8" tabindex="-1"></a>roll_window <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb1153-9"><a href="time-series.html#cb1153-9" tabindex="-1"></a></span>
<span id="cb1153-10"><a href="time-series.html#cb1153-10" tabindex="-1"></a><span class="do">## define weeks ahead want to predict </span></span>
<span id="cb1153-11"><a href="time-series.html#cb1153-11" tabindex="-1"></a>weeks_ahead <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb1153-12"><a href="time-series.html#cb1153-12" tabindex="-1"></a></span>
<span id="cb1153-13"><a href="time-series.html#cb1153-13" tabindex="-1"></a><span class="do">## create a data set of repeating, increasingly long data</span></span>
<span id="cb1153-14"><a href="time-series.html#cb1153-14" tabindex="-1"></a><span class="do">## label each data set with a unique id</span></span>
<span id="cb1153-15"><a href="time-series.html#cb1153-15" tabindex="-1"></a><span class="do">## only use cases before year of interest (i.e. 2011)</span></span>
<span id="cb1153-16"><a href="time-series.html#cb1153-16" tabindex="-1"></a>case_roll <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1153-17"><a href="time-series.html#cb1153-17" tabindex="-1"></a>  <span class="fu">filter</span>(epiweek <span class="sc">&lt;</span> cut_off) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-18"><a href="time-series.html#cb1153-18" tabindex="-1"></a>  <span class="do">## only keep the week and case counts variables</span></span>
<span id="cb1153-19"><a href="time-series.html#cb1153-19" tabindex="-1"></a>  <span class="fu">select</span>(epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-20"><a href="time-series.html#cb1153-20" tabindex="-1"></a>    <span class="do">## drop the last x observations </span></span>
<span id="cb1153-21"><a href="time-series.html#cb1153-21" tabindex="-1"></a>    <span class="do">## depending on how many weeks ahead forecasting </span></span>
<span id="cb1153-22"><a href="time-series.html#cb1153-22" tabindex="-1"></a>    <span class="do">## (otherwise will be an actual forecast to &quot;unknown&quot;)</span></span>
<span id="cb1153-23"><a href="time-series.html#cb1153-23" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">n</span>() <span class="sc">-</span> weeks_ahead)) <span class="sc">%&gt;%</span></span>
<span id="cb1153-24"><a href="time-series.html#cb1153-24" tabindex="-1"></a>    <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-25"><a href="time-series.html#cb1153-25" tabindex="-1"></a>    <span class="do">## roll over each week in x after windows to create grouping ID </span></span>
<span id="cb1153-26"><a href="time-series.html#cb1153-26" tabindex="-1"></a>    <span class="do">## depending on what rolling window specify</span></span>
<span id="cb1153-27"><a href="time-series.html#cb1153-27" tabindex="-1"></a>    <span class="fu">stretch_tsibble</span>(<span class="at">.init =</span> roll_window, <span class="at">.step =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-28"><a href="time-series.html#cb1153-28" tabindex="-1"></a>  <span class="do">## drop the first couple - as have no &quot;before&quot; cases</span></span>
<span id="cb1153-29"><a href="time-series.html#cb1153-29" tabindex="-1"></a>  <span class="fu">filter</span>(.id <span class="sc">&gt;</span> roll_window)</span>
<span id="cb1153-30"><a href="time-series.html#cb1153-30" tabindex="-1"></a></span>
<span id="cb1153-31"><a href="time-series.html#cb1153-31" tabindex="-1"></a></span>
<span id="cb1153-32"><a href="time-series.html#cb1153-32" tabindex="-1"></a><span class="do">## for each of the unique data sets run the code below</span></span>
<span id="cb1153-33"><a href="time-series.html#cb1153-33" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="fu">unique</span>(case_roll<span class="sc">$</span>.id), </span>
<span id="cb1153-34"><a href="time-series.html#cb1153-34" tabindex="-1"></a>                        <span class="cf">function</span>(i) {</span>
<span id="cb1153-35"><a href="time-series.html#cb1153-35" tabindex="-1"></a>  </span>
<span id="cb1153-36"><a href="time-series.html#cb1153-36" tabindex="-1"></a>  <span class="do">## only keep the current fold being fit </span></span>
<span id="cb1153-37"><a href="time-series.html#cb1153-37" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">filter</span>(case_roll, .id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-38"><a href="time-series.html#cb1153-38" tabindex="-1"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb1153-39"><a href="time-series.html#cb1153-39" tabindex="-1"></a>  </span>
<span id="cb1153-40"><a href="time-series.html#cb1153-40" tabindex="-1"></a>  <span class="do">## create an empty data set for forecasting on </span></span>
<span id="cb1153-41"><a href="time-series.html#cb1153-41" tabindex="-1"></a>  forecast_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1153-42"><a href="time-series.html#cb1153-42" tabindex="-1"></a>    <span class="at">epiweek =</span> <span class="fu">seq</span>(<span class="fu">max</span>(mini_data<span class="sc">$</span>epiweek) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1153-43"><a href="time-series.html#cb1153-43" tabindex="-1"></a>                  <span class="fu">max</span>(mini_data<span class="sc">$</span>epiweek) <span class="sc">+</span> weeks_ahead,</span>
<span id="cb1153-44"><a href="time-series.html#cb1153-44" tabindex="-1"></a>                  <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb1153-45"><a href="time-series.html#cb1153-45" tabindex="-1"></a>    <span class="at">case_int =</span> <span class="fu">rep.int</span>(<span class="cn">NA</span>, weeks_ahead),</span>
<span id="cb1153-46"><a href="time-series.html#cb1153-46" tabindex="-1"></a>    <span class="at">.id =</span> <span class="fu">rep.int</span>(i, weeks_ahead)</span>
<span id="cb1153-47"><a href="time-series.html#cb1153-47" tabindex="-1"></a>  )</span>
<span id="cb1153-48"><a href="time-series.html#cb1153-48" tabindex="-1"></a>  </span>
<span id="cb1153-49"><a href="time-series.html#cb1153-49" tabindex="-1"></a>  <span class="do">## add the forecast data to the original </span></span>
<span id="cb1153-50"><a href="time-series.html#cb1153-50" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(mini_data, forecast_data)</span>
<span id="cb1153-51"><a href="time-series.html#cb1153-51" tabindex="-1"></a>  </span>
<span id="cb1153-52"><a href="time-series.html#cb1153-52" tabindex="-1"></a>  <span class="do">## define the cut off based on latest non missing count data </span></span>
<span id="cb1153-53"><a href="time-series.html#cb1153-53" tabindex="-1"></a>  cv_cut_off <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1153-54"><a href="time-series.html#cb1153-54" tabindex="-1"></a>    <span class="do">## only keep non-missing rows</span></span>
<span id="cb1153-55"><a href="time-series.html#cb1153-55" tabindex="-1"></a>    <span class="fu">drop_na</span>(case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-56"><a href="time-series.html#cb1153-56" tabindex="-1"></a>    <span class="do">## get the latest week</span></span>
<span id="cb1153-57"><a href="time-series.html#cb1153-57" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">max</span>(epiweek)) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-58"><a href="time-series.html#cb1153-58" tabindex="-1"></a>    <span class="do">## extract so is not in a dataframe</span></span>
<span id="cb1153-59"><a href="time-series.html#cb1153-59" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb1153-60"><a href="time-series.html#cb1153-60" tabindex="-1"></a>  </span>
<span id="cb1153-61"><a href="time-series.html#cb1153-61" tabindex="-1"></a>  <span class="do">## make mini_data back in to a tsibble</span></span>
<span id="cb1153-62"><a href="time-series.html#cb1153-62" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(mini_data, <span class="at">index =</span> epiweek)</span>
<span id="cb1153-63"><a href="time-series.html#cb1153-63" tabindex="-1"></a>  </span>
<span id="cb1153-64"><a href="time-series.html#cb1153-64" tabindex="-1"></a>  <span class="do">## define fourier terms (sincos) </span></span>
<span id="cb1153-65"><a href="time-series.html#cb1153-65" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1153-66"><a href="time-series.html#cb1153-66" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1153-67"><a href="time-series.html#cb1153-67" tabindex="-1"></a>    <span class="do">## combine fourier terms for weeks prior to  and after cut-off date</span></span>
<span id="cb1153-68"><a href="time-series.html#cb1153-68" tabindex="-1"></a>    <span class="at">fourier =</span> <span class="fu">rbind</span>(</span>
<span id="cb1153-69"><a href="time-series.html#cb1153-69" tabindex="-1"></a>      <span class="do">## get fourier terms for previous years</span></span>
<span id="cb1153-70"><a href="time-series.html#cb1153-70" tabindex="-1"></a>      forecast<span class="sc">::</span><span class="fu">fourier</span>(</span>
<span id="cb1153-71"><a href="time-series.html#cb1153-71" tabindex="-1"></a>        <span class="do">## only keep the rows before cut-off</span></span>
<span id="cb1153-72"><a href="time-series.html#cb1153-72" tabindex="-1"></a>        <span class="fu">filter</span>(mini_data, </span>
<span id="cb1153-73"><a href="time-series.html#cb1153-73" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cv_cut_off), </span>
<span id="cb1153-74"><a href="time-series.html#cb1153-74" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1153-75"><a href="time-series.html#cb1153-75" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span></span>
<span id="cb1153-76"><a href="time-series.html#cb1153-76" tabindex="-1"></a>        ), </span>
<span id="cb1153-77"><a href="time-series.html#cb1153-77" tabindex="-1"></a>      <span class="do">## predict the fourier terms for following year (using baseline data)</span></span>
<span id="cb1153-78"><a href="time-series.html#cb1153-78" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1153-79"><a href="time-series.html#cb1153-79" tabindex="-1"></a>        <span class="do">## only keep the rows before cut-off</span></span>
<span id="cb1153-80"><a href="time-series.html#cb1153-80" tabindex="-1"></a>        <span class="fu">filter</span>(mini_data, </span>
<span id="cb1153-81"><a href="time-series.html#cb1153-81" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cv_cut_off),</span>
<span id="cb1153-82"><a href="time-series.html#cb1153-82" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1153-83"><a href="time-series.html#cb1153-83" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span>, </span>
<span id="cb1153-84"><a href="time-series.html#cb1153-84" tabindex="-1"></a>        <span class="do">## predict 52 weeks ahead</span></span>
<span id="cb1153-85"><a href="time-series.html#cb1153-85" tabindex="-1"></a>        <span class="at">h =</span> weeks_ahead</span>
<span id="cb1153-86"><a href="time-series.html#cb1153-86" tabindex="-1"></a>        )</span>
<span id="cb1153-87"><a href="time-series.html#cb1153-87" tabindex="-1"></a>      )</span>
<span id="cb1153-88"><a href="time-series.html#cb1153-88" tabindex="-1"></a>    )</span>
<span id="cb1153-89"><a href="time-series.html#cb1153-89" tabindex="-1"></a>  </span>
<span id="cb1153-90"><a href="time-series.html#cb1153-90" tabindex="-1"></a>  </span>
<span id="cb1153-91"><a href="time-series.html#cb1153-91" tabindex="-1"></a>  <span class="co"># split data for fitting and prediction</span></span>
<span id="cb1153-92"><a href="time-series.html#cb1153-92" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1153-93"><a href="time-series.html#cb1153-93" tabindex="-1"></a>    <span class="fu">group_by</span>(epiweek <span class="sc">&lt;=</span> cv_cut_off) <span class="sc">%&gt;%</span></span>
<span id="cb1153-94"><a href="time-series.html#cb1153-94" tabindex="-1"></a>    <span class="fu">group_split</span>()</span>
<span id="cb1153-95"><a href="time-series.html#cb1153-95" tabindex="-1"></a></span>
<span id="cb1153-96"><a href="time-series.html#cb1153-96" tabindex="-1"></a>  <span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1153-97"><a href="time-series.html#cb1153-97" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1153-98"><a href="time-series.html#cb1153-98" tabindex="-1"></a>    <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1153-99"><a href="time-series.html#cb1153-99" tabindex="-1"></a>    case_int <span class="sc">~</span></span>
<span id="cb1153-100"><a href="time-series.html#cb1153-100" tabindex="-1"></a>      <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1153-101"><a href="time-series.html#cb1153-101" tabindex="-1"></a>      epiweek <span class="sc">+</span></span>
<span id="cb1153-102"><a href="time-series.html#cb1153-102" tabindex="-1"></a>      <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1153-103"><a href="time-series.html#cb1153-103" tabindex="-1"></a>      fourier</span>
<span id="cb1153-104"><a href="time-series.html#cb1153-104" tabindex="-1"></a>  )</span>
<span id="cb1153-105"><a href="time-series.html#cb1153-105" tabindex="-1"></a></span>
<span id="cb1153-106"><a href="time-series.html#cb1153-106" tabindex="-1"></a>  <span class="co"># define which data to use for fitting and which for predicting</span></span>
<span id="cb1153-107"><a href="time-series.html#cb1153-107" tabindex="-1"></a>  fitting_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">2</span>)</span>
<span id="cb1153-108"><a href="time-series.html#cb1153-108" tabindex="-1"></a>  pred_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">1</span>)</span>
<span id="cb1153-109"><a href="time-series.html#cb1153-109" tabindex="-1"></a>  </span>
<span id="cb1153-110"><a href="time-series.html#cb1153-110" tabindex="-1"></a>  <span class="co"># fit model </span></span>
<span id="cb1153-111"><a href="time-series.html#cb1153-111" tabindex="-1"></a>  fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, fitting_data)</span>
<span id="cb1153-112"><a href="time-series.html#cb1153-112" tabindex="-1"></a>  </span>
<span id="cb1153-113"><a href="time-series.html#cb1153-113" tabindex="-1"></a>  <span class="co"># forecast with data want to predict with </span></span>
<span id="cb1153-114"><a href="time-series.html#cb1153-114" tabindex="-1"></a>  forecasts <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1153-115"><a href="time-series.html#cb1153-115" tabindex="-1"></a>    <span class="fu">predict</span>(pred_data, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>) </span>
<span id="cb1153-116"><a href="time-series.html#cb1153-116" tabindex="-1"></a>  forecasts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(forecasts<span class="sc">$</span>result[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span>   </span>
<span id="cb1153-117"><a href="time-series.html#cb1153-117" tabindex="-1"></a>    <span class="do">## only keep the week and the forecast estimate</span></span>
<span id="cb1153-118"><a href="time-series.html#cb1153-118" tabindex="-1"></a>    <span class="fu">select</span>(epiweek, estimate)</span>
<span id="cb1153-119"><a href="time-series.html#cb1153-119" tabindex="-1"></a>    </span>
<span id="cb1153-120"><a href="time-series.html#cb1153-120" tabindex="-1"></a>  }</span>
<span id="cb1153-121"><a href="time-series.html#cb1153-121" tabindex="-1"></a>  )</span>
<span id="cb1153-122"><a href="time-series.html#cb1153-122" tabindex="-1"></a></span>
<span id="cb1153-123"><a href="time-series.html#cb1153-123" tabindex="-1"></a><span class="do">## make the list in to a data frame with all the forecasts</span></span>
<span id="cb1153-124"><a href="time-series.html#cb1153-124" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(forecasts)</span>
<span id="cb1153-125"><a href="time-series.html#cb1153-125" tabindex="-1"></a></span>
<span id="cb1153-126"><a href="time-series.html#cb1153-126" tabindex="-1"></a><span class="do">## join the forecasts with the observed</span></span>
<span id="cb1153-127"><a href="time-series.html#cb1153-127" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> <span class="fu">left_join</span>(forecasts, </span>
<span id="cb1153-128"><a href="time-series.html#cb1153-128" tabindex="-1"></a>                       <span class="fu">select</span>(counts, epiweek, case_int),</span>
<span id="cb1153-129"><a href="time-series.html#cb1153-129" tabindex="-1"></a>                       <span class="at">by =</span> <span class="st">&quot;epiweek&quot;</span>)</span>
<span id="cb1153-130"><a href="time-series.html#cb1153-130" tabindex="-1"></a></span>
<span id="cb1153-131"><a href="time-series.html#cb1153-131" tabindex="-1"></a><span class="do">## using {yardstick} compute metrics</span></span>
<span id="cb1153-132"><a href="time-series.html#cb1153-132" tabindex="-1"></a>  <span class="do">## RMSE: Root mean squared error</span></span>
<span id="cb1153-133"><a href="time-series.html#cb1153-133" tabindex="-1"></a>  <span class="do">## MAE:  Mean absolute error  </span></span>
<span id="cb1153-134"><a href="time-series.html#cb1153-134" tabindex="-1"></a>  <span class="do">## MASE: Mean absolute scaled error</span></span>
<span id="cb1153-135"><a href="time-series.html#cb1153-135" tabindex="-1"></a>  <span class="do">## MAPE: Mean absolute percent error</span></span>
<span id="cb1153-136"><a href="time-series.html#cb1153-136" tabindex="-1"></a>model_metrics <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb1153-137"><a href="time-series.html#cb1153-137" tabindex="-1"></a>  <span class="do">## in your forcasted dataset compare the observed to the predicted</span></span>
<span id="cb1153-138"><a href="time-series.html#cb1153-138" tabindex="-1"></a>  <span class="fu">rmse</span>(forecasts, case_int, estimate), </span>
<span id="cb1153-139"><a href="time-series.html#cb1153-139" tabindex="-1"></a>  <span class="fu">mae</span>( forecasts, case_int, estimate),</span>
<span id="cb1153-140"><a href="time-series.html#cb1153-140" tabindex="-1"></a>  <span class="fu">mase</span>(forecasts, case_int, estimate),</span>
<span id="cb1153-141"><a href="time-series.html#cb1153-141" tabindex="-1"></a>  <span class="fu">mape</span>(forecasts, case_int, estimate),</span>
<span id="cb1153-142"><a href="time-series.html#cb1153-142" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-143"><a href="time-series.html#cb1153-143" tabindex="-1"></a>  <span class="do">## only keep the metric type and its output</span></span>
<span id="cb1153-144"><a href="time-series.html#cb1153-144" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Metric  =</span> .metric, </span>
<span id="cb1153-145"><a href="time-series.html#cb1153-145" tabindex="-1"></a>         <span class="at">Measure =</span> .estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb1153-146"><a href="time-series.html#cb1153-146" tabindex="-1"></a>  <span class="do">## make in to wide format so can bind rows after</span></span>
<span id="cb1153-147"><a href="time-series.html#cb1153-147" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Metric, <span class="at">values_from =</span> Measure)</span>
<span id="cb1153-148"><a href="time-series.html#cb1153-148" tabindex="-1"></a></span>
<span id="cb1153-149"><a href="time-series.html#cb1153-149" tabindex="-1"></a><span class="do">## return model metrics </span></span>
<span id="cb1153-150"><a href="time-series.html#cb1153-150" tabindex="-1"></a>model_metrics</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="package-surveillance" class="section level3 unnumbered">
<h3>package <strong>surveillance</strong></h3>
<p>Trong phần này chúng ta sẽ sử dụng package <strong>surveillance</strong> để tạo các ngưỡng cảnh báo dựa trên thuật toán phát hiện ổ dịch. Có một số phương pháp khác có sẵn trong package, tuy nhiên chúng ta sẽ tập trung vào hai tùy chọn ở đây. Để biết chi tiết, xem các bài báo sau về <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">sự ứng dụng</a> và <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">lý thuyết</a> về các thuật toán được sử dụng.</p>
<p>Lựa chọn đầu tiên là sử dụng phương pháp Farrington cải tiến. Nó fit một mô hình nhị thức âm tổng quát (bao gồm xu hướng) và down-weights các đợt bùng phát trong quá khứ (giá trị ngoại lai) để tạo một mức ngưỡng.</p>
<p>Lựa chọn thứ hai là dùng phương pháp glrnb. Nó cũng fit một mô hình nhị thức âm tổng quát nhưng bao gồm cả xu hướng và chu kỳ fourier (vì vậy được ưu ái ở đây). Mô hình hồi quy được sử dụng để tính toán “control mean” (~fitted values) - nó sau đó sử dụng một phép thống kê tính toán likelihood ratio statistic tổng quát hóa để đánh giá nếu có sự thay đổi trung bình cho mỗi tuần. Lưu ý rằng ngưỡng cho mỗi tuần sẽ tính đến các tuần trước, vì vậy nếu có sự thay đổi liên tục, một cảnh báo sẽ được kích hoạt. (Cũng lưu ý rằng sau mỗi lần cảnh báo, thuật toán sẽ được đặt lại)</p>
<p>Để làm việc được với package <strong>surveillance</strong>, trước tiên chúng ta cần xác định đối tượng “chuỗi thời gian giám sát” (sử dụng hàm <code>sts()</code>) để fit vào bên trong framework.</p>
<div class="sourceCode" id="cb1155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1155-1"><a href="time-series.html#cb1155-1" tabindex="-1"></a><span class="do">## define surveillance time series object</span></span>
<span id="cb1155-2"><a href="time-series.html#cb1155-2" tabindex="-1"></a><span class="do">## nb. you can include a denominator with the population object (see ?sts)</span></span>
<span id="cb1155-3"><a href="time-series.html#cb1155-3" tabindex="-1"></a>counts_sts <span class="ot">&lt;-</span> <span class="fu">sts</span>(<span class="at">observed =</span> counts<span class="sc">$</span>case_int[<span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)],</span>
<span id="cb1155-4"><a href="time-series.html#cb1155-4" tabindex="-1"></a>                  <span class="at">start =</span> <span class="fu">c</span>(</span>
<span id="cb1155-5"><a href="time-series.html#cb1155-5" tabindex="-1"></a>                    <span class="do">## subset to only keep the year from start_date </span></span>
<span id="cb1155-6"><a href="time-series.html#cb1155-6" tabindex="-1"></a>                    <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(start_date, <span class="dv">1</span>, <span class="dv">4</span>)), </span>
<span id="cb1155-7"><a href="time-series.html#cb1155-7" tabindex="-1"></a>                    <span class="do">## subset to only keep the week from start_date</span></span>
<span id="cb1155-8"><a href="time-series.html#cb1155-8" tabindex="-1"></a>                    <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(start_date, <span class="dv">7</span>, <span class="dv">8</span>))), </span>
<span id="cb1155-9"><a href="time-series.html#cb1155-9" tabindex="-1"></a>                  <span class="do">## define the type of data (in this case weekly)</span></span>
<span id="cb1155-10"><a href="time-series.html#cb1155-10" tabindex="-1"></a>                  <span class="at">freq =</span> <span class="dv">52</span>)</span>
<span id="cb1155-11"><a href="time-series.html#cb1155-11" tabindex="-1"></a></span>
<span id="cb1155-12"><a href="time-series.html#cb1155-12" tabindex="-1"></a><span class="do">## define the week range that you want to include (ie. prediction period)</span></span>
<span id="cb1155-13"><a href="time-series.html#cb1155-13" tabindex="-1"></a><span class="do">## nb. the sts object only counts observations without assigning a week or </span></span>
<span id="cb1155-14"><a href="time-series.html#cb1155-14" tabindex="-1"></a><span class="do">## year identifier to them - so we use our data to define the appropriate observations</span></span>
<span id="cb1155-15"><a href="time-series.html#cb1155-15" tabindex="-1"></a>weekrange <span class="ot">&lt;-</span> cut_off <span class="sc">-</span> start_date</span></code></pre></div>
<!-- ======================================================= -->
<div id="phương-pháp-farrington" class="section level4 unnumbered">
<h4>Phương pháp Farrington</h4>
<p>Sau đó chúng ta xác định từng tham số cho phương pháp Farrington trong một danh sách <code>list</code>. Sau đó, chúng ta chạy thuật toán bằng cách sử dụng hàm <code>farringtonFlexible()</code> và sau đó chúng ta có thể trích xuất ngưỡng cảnh báo bằng hàm <code>farringtonmethod@upperbound</code> để thêm vào tệp dữ liệu của chúng ta. Bạn cũng có thể trích xuất giá trị TRUE/FALSE cho từng tuần nếu nó kích hoạt một cảnh báo (cao hơn ngưỡng) bằng cách sử dụng <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb1156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1156-1"><a href="time-series.html#cb1156-1" tabindex="-1"></a><span class="do">## define control</span></span>
<span id="cb1156-2"><a href="time-series.html#cb1156-2" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1156-3"><a href="time-series.html#cb1156-3" tabindex="-1"></a>  <span class="do">## define what time period that want threshold for (i.e. 2011)</span></span>
<span id="cb1156-4"><a href="time-series.html#cb1156-4" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">which</span>(counts_sts<span class="sc">@</span>epoch <span class="sc">&gt;</span> weekrange),</span>
<span id="cb1156-5"><a href="time-series.html#cb1156-5" tabindex="-1"></a>  <span class="at">b =</span> <span class="dv">9</span>, <span class="do">## how many years backwards for baseline</span></span>
<span id="cb1156-6"><a href="time-series.html#cb1156-6" tabindex="-1"></a>  <span class="at">w =</span> <span class="dv">2</span>, <span class="do">## rolling window size in weeks</span></span>
<span id="cb1156-7"><a href="time-series.html#cb1156-7" tabindex="-1"></a>  <span class="at">weightsThreshold =</span> <span class="fl">2.58</span>, <span class="do">## reweighting past outbreaks (improved noufaily method - original suggests 1)</span></span>
<span id="cb1156-8"><a href="time-series.html#cb1156-8" tabindex="-1"></a>  <span class="do">## pastWeeksNotIncluded = 3, ## use all weeks available (noufaily suggests drop 26)</span></span>
<span id="cb1156-9"><a href="time-series.html#cb1156-9" tabindex="-1"></a>  <span class="at">trend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1156-10"><a href="time-series.html#cb1156-10" tabindex="-1"></a>  <span class="at">pThresholdTrend =</span> <span class="dv">1</span>, <span class="do">## 0.05 normally, however 1 is advised in the improved method (i.e. always keep)</span></span>
<span id="cb1156-11"><a href="time-series.html#cb1156-11" tabindex="-1"></a>  <span class="at">thresholdMethod =</span> <span class="st">&quot;nbPlugin&quot;</span>,</span>
<span id="cb1156-12"><a href="time-series.html#cb1156-12" tabindex="-1"></a>  <span class="at">populationOffset =</span> <span class="cn">TRUE</span></span>
<span id="cb1156-13"><a href="time-series.html#cb1156-13" tabindex="-1"></a>  )</span>
<span id="cb1156-14"><a href="time-series.html#cb1156-14" tabindex="-1"></a></span>
<span id="cb1156-15"><a href="time-series.html#cb1156-15" tabindex="-1"></a><span class="do">## apply farrington flexible method</span></span>
<span id="cb1156-16"><a href="time-series.html#cb1156-16" tabindex="-1"></a>farringtonmethod <span class="ot">&lt;-</span> <span class="fu">farringtonFlexible</span>(counts_sts, ctrl)</span>
<span id="cb1156-17"><a href="time-series.html#cb1156-17" tabindex="-1"></a></span>
<span id="cb1156-18"><a href="time-series.html#cb1156-18" tabindex="-1"></a><span class="do">## create a new variable in the original dataset called threshold</span></span>
<span id="cb1156-19"><a href="time-series.html#cb1156-19" tabindex="-1"></a><span class="do">## containing the upper bound from farrington </span></span>
<span id="cb1156-20"><a href="time-series.html#cb1156-20" tabindex="-1"></a><span class="do">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span id="cb1156-21"><a href="time-series.html#cb1156-21" tabindex="-1"></a>counts[<span class="fu">which</span>(counts<span class="sc">$</span>epiweek <span class="sc">&gt;=</span> cut_off <span class="sc">&amp;</span> </span>
<span id="cb1156-22"><a href="time-series.html#cb1156-22" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)),</span>
<span id="cb1156-23"><a href="time-series.html#cb1156-23" tabindex="-1"></a>              <span class="st">&quot;threshold&quot;</span>] <span class="ot">&lt;-</span> farringtonmethod<span class="sc">@</span>upperbound</span></code></pre></div>
<p>Sau đó, chúng ta có thể trực quan hóa kết quả với ggplot như đã thực hiện ở trên.</p>
<div class="sourceCode" id="cb1157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1157-1"><a href="time-series.html#cb1157-1" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1157-2"><a href="time-series.html#cb1157-2" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1157-3"><a href="time-series.html#cb1157-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1157-4"><a href="time-series.html#cb1157-4" tabindex="-1"></a>  <span class="do">## add in upper bound of aberration algorithm</span></span>
<span id="cb1157-5"><a href="time-series.html#cb1157-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> threshold, <span class="at">colour =</span> <span class="st">&quot;Alert threshold&quot;</span>), </span>
<span id="cb1157-6"><a href="time-series.html#cb1157-6" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb1157-7"><a href="time-series.html#cb1157-7" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb1157-8"><a href="time-series.html#cb1157-8" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1157-9"><a href="time-series.html#cb1157-9" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1157-10"><a href="time-series.html#cb1157-10" tabindex="-1"></a>                                 <span class="st">&quot;Alert threshold&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1157-11"><a href="time-series.html#cb1157-11" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1157-12"><a href="time-series.html#cb1157-12" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb1157-13"><a href="time-series.html#cb1157-13" tabindex="-1"></a>  <span class="do">## remove title of legend </span></span>
<span id="cb1157-14"><a href="time-series.html#cb1157-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_farrington-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="phương-pháp-glrnb" class="section level4 unnumbered">
<h4>Phương pháp GLRNB</h4>
<p>Tương tự với phương pháp GLRNB, chúng ta xác định từng tham số vào một danh sách <code>list</code>, sau đó fit thuật toán và trích xuất các giới hạn trên.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Phương pháp này sử dụng “brute force” (tương tự như bootstrapping) để tính toán các ngưỡng, vì vậy có thể mất nhiều thời gian!</span></p>
<p>Xem <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">GLRNB vignette</a> để biết thêm chi tiết.</p>
<div class="sourceCode" id="cb1158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1158-1"><a href="time-series.html#cb1158-1" tabindex="-1"></a><span class="do">## define control options</span></span>
<span id="cb1158-2"><a href="time-series.html#cb1158-2" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1158-3"><a href="time-series.html#cb1158-3" tabindex="-1"></a>  <span class="do">## define what time period that want threshold for (i.e. 2011)</span></span>
<span id="cb1158-4"><a href="time-series.html#cb1158-4" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">which</span>(counts_sts<span class="sc">@</span>epoch <span class="sc">&gt;</span> weekrange),</span>
<span id="cb1158-5"><a href="time-series.html#cb1158-5" tabindex="-1"></a>  <span class="at">mu0 =</span> <span class="fu">list</span>(<span class="at">S =</span> <span class="dv">1</span>,    <span class="do">## number of fourier terms (harmonics) to include</span></span>
<span id="cb1158-6"><a href="time-series.html#cb1158-6" tabindex="-1"></a>  <span class="at">trend =</span> <span class="cn">TRUE</span>,   <span class="do">## whether to include trend or not</span></span>
<span id="cb1158-7"><a href="time-series.html#cb1158-7" tabindex="-1"></a>  <span class="at">refit =</span> <span class="cn">FALSE</span>), <span class="do">## whether to refit model after each alarm</span></span>
<span id="cb1158-8"><a href="time-series.html#cb1158-8" tabindex="-1"></a>  <span class="do">## cARL = threshold for GLR statistic (arbitrary)</span></span>
<span id="cb1158-9"><a href="time-series.html#cb1158-9" tabindex="-1"></a>     <span class="do">## 3 ~ middle ground for minimising false positives</span></span>
<span id="cb1158-10"><a href="time-series.html#cb1158-10" tabindex="-1"></a>     <span class="do">## 1 fits to the 99%PI of glm.nb - with changes after peaks (threshold lowered for alert)</span></span>
<span id="cb1158-11"><a href="time-series.html#cb1158-11" tabindex="-1"></a>   <span class="at">c.ARL =</span> <span class="dv">2</span>,</span>
<span id="cb1158-12"><a href="time-series.html#cb1158-12" tabindex="-1"></a>   <span class="co"># theta = log(1.5), ## equates to a 50% increase in cases in an outbreak</span></span>
<span id="cb1158-13"><a href="time-series.html#cb1158-13" tabindex="-1"></a>   <span class="at">ret =</span> <span class="st">&quot;cases&quot;</span>     <span class="do">## return threshold upperbound as case counts</span></span>
<span id="cb1158-14"><a href="time-series.html#cb1158-14" tabindex="-1"></a>  )</span>
<span id="cb1158-15"><a href="time-series.html#cb1158-15" tabindex="-1"></a></span>
<span id="cb1158-16"><a href="time-series.html#cb1158-16" tabindex="-1"></a><span class="do">## apply the glrnb method</span></span>
<span id="cb1158-17"><a href="time-series.html#cb1158-17" tabindex="-1"></a>glrnbmethod <span class="ot">&lt;-</span> <span class="fu">glrnb</span>(counts_sts, <span class="at">control =</span> ctrl, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1158-18"><a href="time-series.html#cb1158-18" tabindex="-1"></a></span>
<span id="cb1158-19"><a href="time-series.html#cb1158-19" tabindex="-1"></a><span class="do">## create a new variable in the original dataset called threshold</span></span>
<span id="cb1158-20"><a href="time-series.html#cb1158-20" tabindex="-1"></a><span class="do">## containing the upper bound from glrnb </span></span>
<span id="cb1158-21"><a href="time-series.html#cb1158-21" tabindex="-1"></a><span class="do">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span id="cb1158-22"><a href="time-series.html#cb1158-22" tabindex="-1"></a>counts[<span class="fu">which</span>(counts<span class="sc">$</span>epiweek <span class="sc">&gt;=</span> cut_off <span class="sc">&amp;</span> </span>
<span id="cb1158-23"><a href="time-series.html#cb1158-23" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)),</span>
<span id="cb1158-24"><a href="time-series.html#cb1158-24" tabindex="-1"></a>              <span class="st">&quot;threshold_glrnb&quot;</span>] <span class="ot">&lt;-</span> glrnbmethod<span class="sc">@</span>upperbound</span></code></pre></div>
<p>Trực quan hóa kết quả đầu ra như bên trên.</p>
<div class="sourceCode" id="cb1159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1159-1"><a href="time-series.html#cb1159-1" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1159-2"><a href="time-series.html#cb1159-2" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1159-3"><a href="time-series.html#cb1159-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1159-4"><a href="time-series.html#cb1159-4" tabindex="-1"></a>  <span class="do">## add in upper bound of aberration algorithm</span></span>
<span id="cb1159-5"><a href="time-series.html#cb1159-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> threshold_glrnb, <span class="at">colour =</span> <span class="st">&quot;Alert threshold&quot;</span>), </span>
<span id="cb1159-6"><a href="time-series.html#cb1159-6" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb1159-7"><a href="time-series.html#cb1159-7" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb1159-8"><a href="time-series.html#cb1159-8" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1159-9"><a href="time-series.html#cb1159-9" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1159-10"><a href="time-series.html#cb1159-10" tabindex="-1"></a>                                 <span class="st">&quot;Alert threshold&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1159-11"><a href="time-series.html#cb1159-11" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1159-12"><a href="time-series.html#cb1159-12" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb1159-13"><a href="time-series.html#cb1159-13" tabindex="-1"></a>  <span class="do">## remove title of legend </span></span>
<span id="cb1159-14"><a href="time-series.html#cb1159-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_glrnb-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="chuỗi-thời-gian-bị-gián-đoạn" class="section level2" number="23.8">
<h2><span class="header-section-number">23.8</span> Chuỗi thời gian bị gián đoạn</h2>
<p>Chuỗi thời gian bị gián đoạn (còn được gọi là hồi quy phân đoạn hoặc phân tích can thiệp), thường được sử dụng để đánh giá tác động của vắc-xin đối với tỷ lệ mắc mới của bệnh. Nhưng nó có thể được sử dụng để đánh giá tác động của một loạt các can thiệp hoặc sự giới thiệu. Ví dụ như những thay đổi trong quy trình của bệnh viện hoặc sự xuất hiện của chủng bệnh mới vào quần thể. Trong ví dụ này, chúng ta sẽ giả định rằng một chủng mới của Campylobacter đã xuất hiện ở Đức vào cuối năm 2008, và xem liệu điều đó có ảnh hưởng đến số lượng trường hợp. Chúng ta sẽ sử dụng hồi quy nhị thức âm một lần nữa. Sự hồi quy lần này sẽ được chia thành hai phần, một phần trước khi can thiệp (hoặc sự xuất hiện của chủng mới) và một phần sau (trước và sau giai đoạn). Điều này cho phép chúng ta tính toán tỷ số tỷ lệ mới mắc giữa hai khoảng thời gian. Giải thích phương trình có thể làm cho điều này rõ ràng hơn (nếu không thì chỉ cần bỏ qua!).</p>
<p>Hồi quy nhị thức âm có thể được định nghĩa như sau:</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Trong đó:</p>
<p><span class="math inline">\(Y_t\)</span> là số trường hợp quan sát được tại thời điểm <span class="math inline">\(t\)</span></p>
<p><span class="math inline">\(pop_t\)</span> nếu kích thước quần thể trong 100,000s tại thời điểm <span class="math inline">\(t\)</span> (không sử dụng tại đây)</p>
<p><span class="math inline">\(t_0\)</span> là năm cuối cùng của giai đoạn trước (bao gồm cả thời gian chuyển tiếp nếu có)</p>
<p><span class="math inline">\(δ(x\)</span> là hàm chỉ báo (nó là 0 nếu x ≤ 0 và 1 nếu x &gt; 0)</p>
<p><span class="math inline">\((x)^+\)</span> là toán tử cut off (nó là x nếu x &gt; 0 và ngược lại sẽ bằng 0)</p>
<p><span class="math inline">\(e_t\)</span> biểu thị phần dư</p>
<p>Các chu kỳ bổ sung có xu hướng hoặc theo mùa có thể được thêm vào nếu cần thiết.</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+\)</span> là một phần của mô hình tuyến tỉnh tổng quát hóa của giai đoạn sau và bằng không ở giai đoạn trước. Điều này có nghĩa là <span class="math inline">\(β_2\)</span> và <span class="math inline">\(β_3\)</span> ước tính các hiệu quả của can thiệp.</p>
<p>Chúng ta cần tính toán lại chu kỳ Fourier mà không có dự báo ở đây, vì chúng ta sẽ sử dụng tất cả dữ liệu có sẵn (vd: hồi cứu). Ngoài ra, chúng ta cần tính toán các điều khoản bổ sung cần thiết cho hồi quy. thực tế là chúng ta cần tính chu kỳ mở rộng (extra terms) cho đường hồi quy.</p>
<div class="sourceCode" id="cb1160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1160-1"><a href="time-series.html#cb1160-1" tabindex="-1"></a><span class="do">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span id="cb1160-2"><a href="time-series.html#cb1160-2" tabindex="-1"></a>counts<span class="sc">$</span>fourier <span class="ot">&lt;-</span> <span class="fu">select</span>(counts, epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1160-3"><a href="time-series.html#cb1160-3" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1160-4"><a href="time-series.html#cb1160-4" tabindex="-1"></a>  <span class="fu">fourier</span>(<span class="at">K =</span> <span class="dv">1</span>)</span>
<span id="cb1160-5"><a href="time-series.html#cb1160-5" tabindex="-1"></a></span>
<span id="cb1160-6"><a href="time-series.html#cb1160-6" tabindex="-1"></a><span class="do">## define intervention week </span></span>
<span id="cb1160-7"><a href="time-series.html#cb1160-7" tabindex="-1"></a>intervention_week <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2008-12-31&quot;</span>)</span>
<span id="cb1160-8"><a href="time-series.html#cb1160-8" tabindex="-1"></a></span>
<span id="cb1160-9"><a href="time-series.html#cb1160-9" tabindex="-1"></a><span class="do">## define variables for regression </span></span>
<span id="cb1160-10"><a href="time-series.html#cb1160-10" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1160-11"><a href="time-series.html#cb1160-11" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1160-12"><a href="time-series.html#cb1160-12" tabindex="-1"></a>    <span class="do">## corresponds to t in the formula</span></span>
<span id="cb1160-13"><a href="time-series.html#cb1160-13" tabindex="-1"></a>      <span class="do">## count of weeks (could probably also just use straight epiweeks var)</span></span>
<span id="cb1160-14"><a href="time-series.html#cb1160-14" tabindex="-1"></a>    <span class="co"># linear = row_number(epiweek), </span></span>
<span id="cb1160-15"><a href="time-series.html#cb1160-15" tabindex="-1"></a>    <span class="do">## corresponds to delta(t-t0) in the formula</span></span>
<span id="cb1160-16"><a href="time-series.html#cb1160-16" tabindex="-1"></a>      <span class="do">## pre or post intervention period</span></span>
<span id="cb1160-17"><a href="time-series.html#cb1160-17" tabindex="-1"></a>    <span class="at">intervention =</span> <span class="fu">as.numeric</span>(epiweek <span class="sc">&gt;=</span> intervention_week), </span>
<span id="cb1160-18"><a href="time-series.html#cb1160-18" tabindex="-1"></a>    <span class="do">## corresponds to (t-t0)^+ in the formula</span></span>
<span id="cb1160-19"><a href="time-series.html#cb1160-19" tabindex="-1"></a>      <span class="do">## count of weeks post intervention</span></span>
<span id="cb1160-20"><a href="time-series.html#cb1160-20" tabindex="-1"></a>      <span class="do">## (choose the larger number between 0 and whatever comes from calculation)</span></span>
<span id="cb1160-21"><a href="time-series.html#cb1160-21" tabindex="-1"></a>    <span class="at">time_post =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, epiweek <span class="sc">-</span> intervention_week <span class="sc">+</span> <span class="dv">1</span>))</span></code></pre></div>
<p>Chúng ta sau đó sử dụng các chi kỳ này để fit một mô hình hồi quy nhị thức âm, và tạo một bảng với phần trăm thay đổi. Những gì ví dụ này cho thấy là không có thay đổi đáng kể.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code>predict()</code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code>?trending::predict.trending_model_fit</code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1161-1"><a href="time-series.html#cb1161-1" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1161-2"><a href="time-series.html#cb1161-2" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1161-3"><a href="time-series.html#cb1161-3" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1161-4"><a href="time-series.html#cb1161-4" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1161-5"><a href="time-series.html#cb1161-5" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1161-6"><a href="time-series.html#cb1161-6" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1161-7"><a href="time-series.html#cb1161-7" tabindex="-1"></a>    <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1161-8"><a href="time-series.html#cb1161-8" tabindex="-1"></a>    fourier <span class="sc">+</span> </span>
<span id="cb1161-9"><a href="time-series.html#cb1161-9" tabindex="-1"></a>    <span class="do">## add in whether in the pre- or post-period </span></span>
<span id="cb1161-10"><a href="time-series.html#cb1161-10" tabindex="-1"></a>    intervention <span class="sc">+</span> </span>
<span id="cb1161-11"><a href="time-series.html#cb1161-11" tabindex="-1"></a>    <span class="do">## add in the time post intervention </span></span>
<span id="cb1161-12"><a href="time-series.html#cb1161-12" tabindex="-1"></a>    time_post</span>
<span id="cb1161-13"><a href="time-series.html#cb1161-13" tabindex="-1"></a>    )</span>
<span id="cb1161-14"><a href="time-series.html#cb1161-14" tabindex="-1"></a></span>
<span id="cb1161-15"><a href="time-series.html#cb1161-15" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1161-16"><a href="time-series.html#cb1161-16" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1161-17"><a href="time-series.html#cb1161-17" tabindex="-1"></a></span>
<span id="cb1161-18"><a href="time-series.html#cb1161-18" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1161-19"><a href="time-series.html#cb1161-19" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb1162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1162-1"><a href="time-series.html#cb1162-1" tabindex="-1"></a><span class="do">## show estimates and percentage change in a table</span></span>
<span id="cb1162-2"><a href="time-series.html#cb1162-2" tabindex="-1"></a>fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1162-3"><a href="time-series.html#cb1162-3" tabindex="-1"></a>  <span class="do">## extract original negative binomial regression</span></span>
<span id="cb1162-4"><a href="time-series.html#cb1162-4" tabindex="-1"></a>  <span class="fu">get_model</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1162-5"><a href="time-series.html#cb1162-5" tabindex="-1"></a>  <span class="do">## get a tidy dataframe of results</span></span>
<span id="cb1162-6"><a href="time-series.html#cb1162-6" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb1162-7"><a href="time-series.html#cb1162-7" tabindex="-1"></a>       <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1162-8"><a href="time-series.html#cb1162-8" tabindex="-1"></a>  <span class="do">## only keep the intervention value </span></span>
<span id="cb1162-9"><a href="time-series.html#cb1162-9" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;intervention&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1162-10"><a href="time-series.html#cb1162-10" tabindex="-1"></a>  <span class="do">## change the IRR to percentage change for estimate and CIs </span></span>
<span id="cb1162-11"><a href="time-series.html#cb1162-11" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1162-12"><a href="time-series.html#cb1162-12" tabindex="-1"></a>    <span class="do">## for each of the columns of interest - create a new column</span></span>
<span id="cb1162-13"><a href="time-series.html#cb1162-13" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb1162-14"><a href="time-series.html#cb1162-14" tabindex="-1"></a>      <span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;conf.low&quot;</span>, <span class="st">&quot;conf.high&quot;</span>)), </span>
<span id="cb1162-15"><a href="time-series.html#cb1162-15" tabindex="-1"></a>      <span class="do">## apply the formula to calculate percentage change</span></span>
<span id="cb1162-16"><a href="time-series.html#cb1162-16" tabindex="-1"></a>            <span class="at">.f =</span> <span class="cf">function</span>(i) <span class="dv">100</span> <span class="sc">*</span> (i <span class="sc">-</span> <span class="dv">1</span>), </span>
<span id="cb1162-17"><a href="time-series.html#cb1162-17" tabindex="-1"></a>      <span class="do">## add a suffix to new column names with &quot;_perc&quot;</span></span>
<span id="cb1162-18"><a href="time-series.html#cb1162-18" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">&quot;{.col}_perc&quot;</span>)</span>
<span id="cb1162-19"><a href="time-series.html#cb1162-19" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb1162-20"><a href="time-series.html#cb1162-20" tabindex="-1"></a>  <span class="do">## only keep (and rename) certain columns </span></span>
<span id="cb1162-21"><a href="time-series.html#cb1162-21" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">&quot;IRR&quot;</span> <span class="ot">=</span> estimate, </span>
<span id="cb1162-22"><a href="time-series.html#cb1162-22" tabindex="-1"></a>         <span class="st">&quot;95%CI low&quot;</span> <span class="ot">=</span> conf.low, </span>
<span id="cb1162-23"><a href="time-series.html#cb1162-23" tabindex="-1"></a>         <span class="st">&quot;95%CI high&quot;</span> <span class="ot">=</span> conf.high,</span>
<span id="cb1162-24"><a href="time-series.html#cb1162-24" tabindex="-1"></a>         <span class="st">&quot;Percentage change&quot;</span> <span class="ot">=</span> estimate_perc, </span>
<span id="cb1162-25"><a href="time-series.html#cb1162-25" tabindex="-1"></a>         <span class="st">&quot;95%CI low (perc)&quot;</span> <span class="ot">=</span> conf.low_perc, </span>
<span id="cb1162-26"><a href="time-series.html#cb1162-26" tabindex="-1"></a>         <span class="st">&quot;95%CI high (perc)&quot;</span> <span class="ot">=</span> conf.high_perc,</span>
<span id="cb1162-27"><a href="time-series.html#cb1162-27" tabindex="-1"></a>         <span class="st">&quot;p-value&quot;</span> <span class="ot">=</span> p.value)</span></code></pre></div>
<p>Như bên trên, chúng ta có thể trực quan hóa các đầu ra của mô hình hồi quy.</p>
<div class="sourceCode" id="cb1163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1163-1"><a href="time-series.html#cb1163-1" tabindex="-1"></a>estimate_res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(observed<span class="sc">$</span>result)</span>
<span id="cb1163-2"><a href="time-series.html#cb1163-2" tabindex="-1"></a></span>
<span id="cb1163-3"><a href="time-series.html#cb1163-3" tabindex="-1"></a><span class="fu">ggplot</span>(estimate_res, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1163-4"><a href="time-series.html#cb1163-4" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1163-5"><a href="time-series.html#cb1163-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1163-6"><a href="time-series.html#cb1163-6" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1163-7"><a href="time-series.html#cb1163-7" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate, <span class="at">col =</span> <span class="st">&quot;Estimate&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1163-8"><a href="time-series.html#cb1163-8" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1163-9"><a href="time-series.html#cb1163-9" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1163-10"><a href="time-series.html#cb1163-10" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1163-11"><a href="time-series.html#cb1163-11" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1163-12"><a href="time-series.html#cb1163-12" tabindex="-1"></a>  <span class="do">## add vertical line and label to show where forecasting started</span></span>
<span id="cb1163-13"><a href="time-series.html#cb1163-13" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb1163-14"><a href="time-series.html#cb1163-14" tabindex="-1"></a>           <span class="at">xintercept =</span> <span class="fu">as.Date</span>(intervention_week), </span>
<span id="cb1163-15"><a href="time-series.html#cb1163-15" tabindex="-1"></a>           <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1163-16"><a href="time-series.html#cb1163-16" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, </span>
<span id="cb1163-17"><a href="time-series.html#cb1163-17" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">&quot;Intervention&quot;</span>, </span>
<span id="cb1163-18"><a href="time-series.html#cb1163-18" tabindex="-1"></a>           <span class="at">x =</span> intervention_week, </span>
<span id="cb1163-19"><a href="time-series.html#cb1163-19" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">max</span>(observed<span class="sc">$</span>upper_pi), </span>
<span id="cb1163-20"><a href="time-series.html#cb1163-20" tabindex="-1"></a>           <span class="at">angle =</span> <span class="dv">90</span>, </span>
<span id="cb1163-21"><a href="time-series.html#cb1163-21" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb1163-22"><a href="time-series.html#cb1163-22" tabindex="-1"></a>           ) <span class="sc">+</span> </span>
<span id="cb1163-23"><a href="time-series.html#cb1163-23" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1163-24"><a href="time-series.html#cb1163-24" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1163-25"><a href="time-series.html#cb1163-25" tabindex="-1"></a>                                 <span class="st">&quot;Estimate&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1163-26"><a href="time-series.html#cb1163-26" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1163-27"><a href="time-series.html#cb1163-27" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Unknown or uninitialised column: `upper_pi`.</code></pre>
<pre><code>## Warning in max(observed$upper_pi): no non-missing arguments to max; returning -Inf</code></pre>
<p><img src="_main_files/figure-html/plot_interrupted-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="nguồn-tham-khảo-1" class="section level2" number="23.9">
<h2><span class="header-section-number">23.9</span> Nguồn tham khảo</h2>
<p><a href="https://otexts.com/fpp3/">forecasting: principles and practice textbook</a><br />
<a href="https://github.com/EPIET/TimeSeriesAnalysis">EPIET timeseries analysis case studies</a><br />
<a href="https://online.stat.psu.edu/stat510/lesson/1">Penn State course</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Surveillance package manuscript</a></p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Cẩm nang dịch tễ học với R</strong>" was written by the handbook team. It was last built on 2024-02-16.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
